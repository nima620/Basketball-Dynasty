<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Atom Idle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/decimal.js/decimal.min.js"></script>
    
    <style>
      #notification-area {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 1000;
          display: flex;
          flex-direction: column;
          gap: 10px;
      }

      .notification-item {
          background-color: rgba(30, 30, 60, 0.9); 
          color: #e0e0ff; 
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          border: 1px solid #7e22ce; 
          opacity: 0; 
          transform: translateY(-20px); 
          transition: opacity 0.5s ease-out, transform 0.5s ease-out; 
          min-width: 250px;
          text-align: center;
          font-size: 1.1em;
      }

      .notification-item.notification-show {
          opacity: 1;
          transform: translateY(0);
      }

      .notification-item.notification-hide {
          opacity: 0;
          transform: translateY(-20px);
      }
    </style>
    <style>
        .universe-modal-backdrop {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 10, 0.8);
          backdrop-filter: blur(5px);
          z-index: 1999;
          display: flex; 
          justify-content: center;
          align-items: center;
          padding: 20px 0;
        }
        .universe-modal-content-wrapper {
          position: relative;
          width: 95vw;
          max-width: 900px;
          max-height: 95vh;
          overflow-y: auto;
          margin: 20px auto;
          background-color: #000011;
          border: 2px solid #7e22ce;
          border-radius: 15px;
          box-shadow: 0 0 30px rgba(126, 34, 206, 0.6);
          color: #e0e0ff;
        }
        .universe-modal-close-button {
          position: sticky;
          top: -15px;
          right: -15px;
          float: right;
          width: 40px;
          height: 40px;
          background: linear-gradient(145deg, #7e22ce, #a855f7);
          border: 2px solid #e0e0ff;
          border-radius: 50%;
          color: white;
          font-size: 24px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          justify-content: center;
          align-items: center;
          line-height: 1;
          z-index: 2001;
          transition: all 0.2s ease-in-out;
        }
        .universe-modal-close-button:hover {
          transform: scale(1.1) rotate(90deg);
          box-shadow: 0 0 15px #a855f7;
        }
    </style>
    
    <style>
        #starfield-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .universe-container {
            position: relative;
            z-index: 1;
            background: rgba(15, 15, 35, 0.75);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            height: 100%;
            border-radius: 13px;
        }

        .universe-container h1 {
            font-size: 3em;
            color: #c084fc;
            text-shadow: 0 0 10px #c084fc, 0 0 20px #c084fc, 0 0 35px #a855f7;
            margin-bottom: 20px;
        }

        .universe-stardust-display {
            font-size: 1.5rem;
            font-family: monospace;
            color: #a78bfa;
            font-weight: bold;
            background-color: rgba(167, 139, 250, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #a78bfa;
            display: inline-block;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .universe-container p {
            font-size: 1.1em;
            color: #d8b4fe;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .universe-shop-section {
            background: rgba(30, 30, 60, 0.6);
            border: 1px solid #a855f7;
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 20px;
            flex: 1 1 400px;
            min-width: 350px;
            display: flex;
            flex-direction: column;
        }

        .universe-shop-section h2 {
            color: #f472b6;
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 0 0 8px #f472b6;
        }

        .universe-shop-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            justify-content: center;
            flex-grow: 1;
        }
        
        .universe-shop-item {
            background: rgba(34, 34, 34, 0.8);
            border-radius: 8px;
            padding: 15px; 
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            text-align: center;
            border: 1px solid #7e22ce;
            transition: all 0.2s ease-in-out;
            min-height: 120px; 
        }

        .universe-shop-item:not(.purchased):not(.disabled):hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(168, 85, 247, 0.4);
            cursor: pointer;
        }
        
        .universe-shop-item.purchased {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(22, 163, 74, 0.3);
            border-color: #16a34a;
        }

        .universe-shop-item.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .universe-shop-item b {
            color: #d8b4fe;
            font-size: 1.2em; 
            margin-bottom: 8px;
        }
        .universe-shop-item span {
            font-size: 0.9em;
            color: #ccc;
            line-height: 1.4; 
        }
        .universe-shop-item .price {
            font-weight: bold;
            margin-top: auto;
            padding-top: 8px;
        }
        .universe-shop-item .price.stardust { 
             color: #c084fc;
        }
        .universe-shop-item .price.energy {
             color: #f59e0b;
        }
        .universe-shop-item .price.gp {
             color: #34d399;
        }

        .universe-guide-item {
            background: rgba(10, 10, 20, 0.7);
            border-left: 4px solid #f472b6;
            padding: 15px;
            margin-bottom: 12px;
            text-align: left;
            border-radius: 4px;
        }
        .universe-guide-item b {
            font-size: 1.3em;
            color: #f9a8d4;
            display: block;
            margin-bottom: 8px;
        }
        .universe-guide-item span {
            font-size: 1em;
            color: #e0e0ff;
            line-height: 1.5;
        }
        .progress-bar-bg { background-color: #2a2a4a; border: 1px solid #4a4a7a; }
        .progress-bar-fg { transition: width 0.3s ease-in-out; }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2KEDZEVQTV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2KEDZEVQTV');
</script>
  <body class="bg-slate-900 text-slate-100">
    <div id="root"></div>
    <script>
'use strict';
const { useState, useEffect, useMemo, useCallback, useRef } = React;
const D = Decimal;


const UNIVERSE_PLANETS = {
    "Mercury": { baseCost: 1, costIncreaseFactor: 1, color: "#7e22ce", size: 40, energy: new D(1), moons: [] },
    "Venus": { baseCost: 2, costIncreaseFactor: 1, color: "#a855f7", size: 48, energy: new D(5), moons: ["Ishtar"] },
    "Earth": { baseCost: 3, costIncreaseFactor: 1, color: "#c084fc", size: 54, energy: new D(20), moons: ["Moon"] },
    "Mars": { baseCost: 5, costIncreaseFactor: 1, color: "#d8b4fe", size: 46, energy: new D(100), moons: ["Phobos", "Deimos"] },
    "Jupiter": { baseCost: 7, costIncreaseFactor: 1, color: "#f472b6", size: 70, energy: new D(500), moons: ["Io", "Europa", "Ganymede", "Callisto"] },
    "Saturn": { baseCost: 10, costIncreaseFactor: 1, color: "#ec4899", size: 66, energy: new D(2e3), moons: ["Titan", "Enceladus", "Mimas"] },
    "Uranus": { baseCost: 15, costIncreaseFactor: 1, color: "#f59e0b", size: 56, energy: new D(1e4), moons: ["Miranda", "Ariel"] },
    "Neptune": { baseCost: 20, costIncreaseFactor: 1, color: "#f97316", size: 52, energy: new D(5e4), moons: ["Triton"] },
    "Sun": { baseCost: 100, costIncreaseFactor: 1, color: "#ffcc00", size: 80, energy: new D(1e6), moons: [] }
};
const UNIVERSE_MOONS = {
    "Moon": { baseCost: 1, costIncreaseFactor: 1, planet: "Earth", stardust: 0.01 },
    "Phobos": { baseCost: 5, costIncreaseFactor: 1, planet: "Mars", stardust: 0.02 },
    "Deimos": { baseCost: 20, costIncreaseFactor: 1, planet: "Mars", stardust: 0.03 },
    "Io": { baseCost: 30, costIncreaseFactor: 1, planet: "Jupiter", stardust: 0.05 },
    "Europa": { baseCost: 75, costIncreaseFactor: 1, planet: "Jupiter", stardust: 0.1 },
    "Ganymede": { baseCost: 200, costIncreaseFactor: 1, planet: "Jupiter", stardust: 0.25 },
    "Callisto": { baseCost: 500, costIncreaseFactor: 1, planet: "Jupiter", stardust: 0.5 },
    "Titan": { baseCost: 1000, costIncreaseFactor: 1, planet: "Saturn", stardust: 1 },
    "Enceladus": { baseCost: 2500, costIncreaseFactor: 1, planet: "Saturn", stardust: 2 },
    "Mimas": { baseCost: 5000, costIncreaseFactor: 1, planet: "Saturn", stardust: 3 },
    "Miranda": { baseCost: 10000, costIncreaseFactor: 1, planet: "Uranus", stardust: 5 },
    "Ariel": { baseCost: 20000, costIncreaseFactor: 1, planet: "Uranus", stardust: 10 },
    "Triton": { baseCost: 30000, costIncreaseFactor: 1, planet: "Neptune", stardust: 20 },
    "Ishtar": { baseCost: 50000, costIncreaseFactor: 1, planet: "Venus", stardust: 35 },
    "Oberon": { baseCost: 75000, costIncreaseFactor: 1, planet: "Uranus", stardust: 50 },
    "Rhea": { baseCost: 150000, costIncreaseFactor: 1, planet: "Saturn", stardust: 100 },
    "Dione": { baseCost: 300000, costIncreaseFactor: 1, planet: "Saturn", stardust: 200 },
    "Tethys": { baseCost: 500000, costIncreaseFactor: 1, planet: "Saturn", stardust: 350 },
    "Umbriel": { baseCost: 1000000, costIncreaseFactor: 1, planet: "Uranus", stardust: 500 }
};

const UNIVERSE_UPGRADES = { 
    "Energy Booster": { baseCost: 100, costIncreaseFactor: 1, effect: "energy", multiplier: 2 }, 
    "Atom Synergy": { baseCost: 10000, costIncreaseFactor: 1, effect: "atoms", multiplier: 10 },
    "Moon Mining": { baseCost: 50000, costIncreaseFactor: 1, effect: "moon", multiplier: 2 },
    "Energy Blast": { baseCost: 250000, costIncreaseFactor: 1, effect: "energy", multiplier: 5 },
    "Charging Atoms": { baseCost: 1000000, costIncreaseFactor: 1, effect: "atoms", multiplier: 50 },
    "Moon Harvest": { baseCost: 5000000, costIncreaseFactor: 1, effect: "moon", multiplier: 5 },
    "Energy Amplification": { baseCost: new D('5e7'), costIncreaseFactor: 1, effect: "energy", multiplier: 50 },
    "Quantum Atoms": { baseCost: new D('1e9'), costIncreaseFactor: 1, effect: "atoms", multiplier: 1000 },
    "Stardust Siphon": { baseCost: new D('1e10'), costIncreaseFactor: 1, effect: "moon", multiplier: 100 }
};

const PLANETARY_SYSTEM_REQUIREMENTS = {
    stellarNurseryBase: 5000,
    stellarNurseryIncrease: 5000,
    stardustBase: new D('1e3'),
    stardustScaling: new D(5),
    energyBase: new D('1e4'),
    energyScaling: new D(5)
};

const GALACTIC_UPGRADES = {
    "gu1": { name: "Transcendent evolution", description: "Super Human's Gain permanently increases by 25%.", cost: 1, effect: { type: 'super_human_gain', multiplier: 1.25 } },
    "gu2": { name: "Prestige Clarity", description: "Prestige Point gain is permanently multiplied by 5.", cost: 1, effect: { type: 'prestige', multiplier: 5 } },
    "gu3": { name: "Universal Attunement", description: "All Energy generation in the Universe is multiplied by 10.", cost: 2, effect: { type: 'universe_energy', multiplier: 10 } },
    "gu4": { name: "Cosmic Dust Amplification", description: "All Stardust generation is permanently multiplied by 10.", cost: 2, effect: { type: 'stardust_generation', multiplier: 10 } },
    "gu5": { name: "Accelerated genesis", description: "Life's production is permanently multiplied by 10.", cost: 3, effect: { type: 'life_production', multiplier: 10 } },
    "gu6": { name: "Temporal Insight", description: "Prestige Point gain is permanently multiplied by 10.", cost: 3, effect: { type: 'prestige', multiplier: 10 } },
    "gu7": { name: "Galactic Synergy", description: "All Stardust generation is permanently multiplied by 100.", cost: 5, effect: { type: 'stardust_generation', multiplier: 100 } },
};

const UNIVERSE_GUIDE_DATA = [
    { title: 'Solar System âœ¨', description: 'Unlock planets to generate Energy, and use Energy to unlock moons and other upgrades.' },
    { title: 'Planetary Systems ðŸŒŒ', description: 'Unlocks when you reach the Sun. Fulfill resource requirements to form new systems and earn Galactic Points.' },
    { title: 'Galactic Upgrades ðŸš€', description: 'Spend Galactic Points on powerful, permanent upgrades that affect all aspects of the game.' },
    { title: '????????????', description: '???? ? ?!?? ?!!?' },
    { title: '############', description: '??! ???' }
];

function textToHex(text) {
  return Array.from(text)
    .map(char => char.charCodeAt(0).toString(16).padStart(2, '0'))
    .join('');
}

function hexToText(hex) {
  let text = '';
  for (let i = 0; i < hex.length; i += 2) {
    text += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
  }
  return text;
}

const SI_SYMBOLS = [
  { value: 1, symbol: "" }, { value: 1E3, symbol: "k" }, { value: 1E6, symbol: "m" }, { value: 1E9, symbol: "b" },
  { value: 1E12, symbol: "t" }, { value: 1E15, symbol: "qa" }, { value: 1E18, symbol: "qi" }, { value: 1E21, symbol: "sx" },
  { value: 1E24, symbol: "sp" }, { value: 1E27, symbol: "oc" }, { value: 1E30, symbol: "no" }, { value: 1E33, symbol: "de" }
];
const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
const getAlphabeticSuffix = (index) => {
    if (index < 0) return '';
    let suffix = '';
    let i = index;
    while(true) {
        suffix = ALPHABET[i % 26] + suffix;
        i = Math.floor(i / 26) - 1;
        if (i < 0) break;
    }
    return suffix;
};

const formatNumber = (num, format = 'standard') => {
  if (num === null || num === undefined || (typeof num === 'number' && isNaN(num))) {
      return "Invalid";
  }
  const dNum = num instanceof D ? num : new D(num);
  if (dNum.isNaN()) return "Invalid";
  if (dNum.isZero()) return "0"; 
  if (format === 'scientific') {
      if (dNum.lt(1000) && dNum.gt(0.01)) return dNum.toFixed(2);
      return dNum.toExponential(2);
  }
  if (dNum.lt(0.01) && dNum.gt(0)) return dNum.toPrecision(2);
  if (dNum.lt(1000)) return dNum.toFixed(2);
  const exponent = dNum.e;
  const tierIndex = Math.floor(exponent / 3);
  if (tierIndex < SI_SYMBOLS.length) {
      const tier = SI_SYMBOLS[tierIndex];
      const value = dNum.div(tier.value);
      return `${value.toFixed(2)}${tier.symbol}`;
  }
  const alphabeticIndex = tierIndex - SI_SYMBOLS.length;
  const suffix = getAlphabeticSuffix(alphabeticIndex);
  const value = dNum.div(new D(10).pow(tierIndex * 3));
  return `${value.toFixed(2)}${suffix}`;
};

const calculatePurchaseCost = (item, amount) => {
    if (amount <= 0) return new D(0);
    const baseCost = new D(item.baseCost);
    const costIncreaseFactor = new D(item.costIncreaseFactor);
    const count = item.count || item.level || 0;
    if (costIncreaseFactor.equals(1)) return baseCost.mul(amount);
    const r_pow_n = costIncreaseFactor.pow(count);
    const r_pow_a = costIncreaseFactor.pow(amount);
    const numerator = baseCost.mul(r_pow_n).mul(r_pow_a.sub(1));
    const denominator = costIncreaseFactor.sub(1);
    if (denominator.isZero()) return new D(Infinity);
    return numerator.div(denominator);
};

const calculateMaxAffordable = (item, resources) => {
    const baseCost = new D(item.baseCost);
    const r = new D(item.costIncreaseFactor);
    const n = item.count || item.level || 0;
    const res = new D(resources);
    const singleCost = baseCost.mul(r.pow(n));
    if (res.lt(singleCost)) return 0;
    if (r.equals(1)) {
       if (baseCost.isZero()) return Infinity;
       return res.div(baseCost).floor().toNumber();
    }
    const logArgument = res.mul(r.sub(1)).div(singleCost).add(1);
    if (logArgument.lte(0)) return 0;
    const maxAffordable = logArgument.log(r).floor();
    return maxAffordable.gt(0) ? maxAffordable.toNumber() : 0;
};


const StarfieldCanvas = () => {
    const canvasRef = useRef(null);
    useEffect(() => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        let animationFrameId;
        const resizeCanvas = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        };
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        const stars = [];
        const numStars = 400;
        for (let i = 0; i < numStars; i++) {
            stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, radius: Math.random() * 1.5, alpha: Math.random(), speed: Math.random() * 0.1 + 0.05 });
        }
        const drawStars = () => {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                ctx.fill();
                star.y -= star.speed;
                if (star.y < 0) star.y = canvas.height;
            });
            animationFrameId = requestAnimationFrame(drawStars);
        };
        drawStars();
        return () => {
            window.removeEventListener('resize', resizeCanvas);
            cancelAnimationFrame(animationFrameId);
        };
    }, []);
    return React.createElement('canvas', { id: 'starfield-canvas', ref: canvasRef });
};

const UniverseShopItem = ({ name, description, cost, costType, onBuy, canAfford, isPurchased }) => {
    const classNames = ['universe-shop-item', isPurchased ? 'purchased' : '', !isPurchased && !canAfford ? 'disabled' : ''].join(' ');
    const costColorClass = costType === 'stardust' ? 'stardust' : (costType === 'energy' ? 'energy' : 'gp');
    return React.createElement('div', { className: classNames, onClick: () => !isPurchased && canAfford && onBuy() },
        React.createElement('div', null,
            React.createElement('b', null, name),
            React.createElement('span', null, description)
        ),
        React.createElement('span', { className: `price ${costColorClass}` },
            isPurchased ? 'PURCHASED' : `Cost: ${formatNumber(new D(cost))} ${costType === 'stardust' ? 'Stardust' : costType === 'energy' ? 'Energy' : 'GP'}`
        )
    );
};

const PlanetarySystemManager = ({ planetarySystemReqs, systemProgress, onInvest, stellarNurseryCount, canFormSystem, onForm, availableStardust, totalEnergy, planetarySystemsCount }) => {
    const { stellarNursery, stardust, energy } = planetarySystemReqs;

    const stellarNurseryMet = stellarNurseryCount >= stellarNursery;
    const stardustProgress = systemProgress.stardust.div(stardust).mul(100).clamp(0, 100).toNumber();
    const energyProgress = systemProgress.energy.div(energy).mul(100).clamp(0, 100).toNumber();

    return React.createElement('div', { className: 'text-left p-4' },
        React.createElement('p', { className: "text-slate-300 text-lg mb-4" }, `Form Planetary System #${planetarySystemsCount + 1} to gain 1 Galactic Point.`),
        
        React.createElement('div', { className: 'space-y-4' },
            React.createElement('div', { className: `p-3 rounded-md border ${stellarNurseryMet ? 'border-green-500 bg-green-900/20' : 'border-slate-600'}` },
                React.createElement('p', { className: 'font-bold text-slate-200' }, `1. Stellar Nurseries: ${formatNumber(stellarNurseryCount)} / ${formatNumber(stellarNursery)}`)
            ),
            
            React.createElement('div', { className: 'p-3 rounded-md border border-slate-600' },
                React.createElement('p', { className: 'font-bold text-slate-200 mb-2' }, `2. Stardust Requirement`),
                React.createElement('p', { className: 'text-sm text-purple-300 font-mono' }, `${formatNumber(systemProgress.stardust)} / ${formatNumber(stardust)}`),
                React.createElement('div', { className: 'w-full h-4 rounded-full progress-bar-bg mt-1' }, 
                    React.createElement('div', { className: 'h-full rounded-full bg-purple-500 progress-bar-fg', style: { width: `${stardustProgress}%` } })
                ),
                React.createElement('button', {
                    onClick: () => onInvest('stardust'),
                    disabled: availableStardust.isZero() || systemProgress.stardust.gte(stardust),
                    className: 'mt-2 px-4 py-1 text-sm font-bold rounded-md bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white'
                }, 'Invest Max Stardust')
            ),

            React.createElement('div', { className: 'p-3 rounded-md border border-slate-600' },
                React.createElement('p', { className: 'font-bold text-slate-200 mb-2' }, `3. Energy Requirement`),
                React.createElement('p', { className: 'text-sm text-amber-300 font-mono' }, `${formatNumber(systemProgress.energy)} / ${formatNumber(energy)}`),
                React.createElement('div', { className: 'w-full h-4 rounded-full progress-bar-bg mt-1' },
                    React.createElement('div', { className: 'h-full rounded-full bg-amber-500 progress-bar-fg', style: { width: `${energyProgress}%` } })
                ),
                React.createElement('button', {
                    onClick: () => onInvest('energy'),
                    disabled: totalEnergy.isZero() || systemProgress.energy.gte(energy),
                    className: 'mt-2 px-4 py-1 text-sm font-bold rounded-md bg-amber-600 hover:bg-amber-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white'
                }, 'Invest Max Energy')
            )
        ),

        React.createElement('button', {
            onClick: onForm,
            disabled: !canFormSystem,
            className: 'w-full mt-6 py-3 font-bold text-lg rounded-lg bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed transition-colors'
        }, 'Form Planetary System')
    );
};


const UniverseContent = ({ universeData, availableStardust, totalEnergy, energyPerSecond, stardustPerSecond, onBuyItem, stellarNurseryCount, planetarySystems, galacticPoints, onInvestInPlanetarySystem, onFormPlanetarySystem, onBuyGalacticUpgrade }) => {    
    const planetarySystemReqs = useMemo(() => {
        const { stellarNurseryBase, stellarNurseryIncrease, stardustBase, stardustScaling, energyBase, energyScaling } = PLANETARY_SYSTEM_REQUIREMENTS;
        const systemIndex = planetarySystems;
        return {
            stellarNursery: stellarNurseryBase + systemIndex * stellarNurseryIncrease,
            stardust: stardustBase.mul(stardustScaling.pow(systemIndex)),
            energy: energyBase.mul(energyScaling.pow(systemIndex)),
        };
    }, [planetarySystems]);

    const systemProgress = {
        stardust: new D(universeData.planetarySystemProgress?.stardust || '0'),
        energy: new D(universeData.planetarySystemProgress?.energy || '0')
    };

    const canFormSystem = stellarNurseryCount >= planetarySystemReqs.stellarNursery &&
                          systemProgress.stardust.gte(planetarySystemReqs.stardust) &&
                          systemProgress.energy.gte(planetarySystemReqs.energy);

    const handleBuy = (itemType, itemName) => {
        onBuyItem(itemType, itemName);
    };

    const totalAtomMultiplier = (universeData.purchasedUpgrades || []).reduce((total, upgradeName) => {
        const upgrade = UNIVERSE_UPGRADES[upgradeName];
        if (upgrade && upgrade.effect === 'atoms') {
            return total * upgrade.multiplier;
        }
        return total;
    }, 1);

    return React.createElement('div', { className: 'universe-container' },
        React.createElement(StarfieldCanvas),
        React.createElement('h1', null, 'The Universe'),
                React.createElement('div', { className: 'flex justify-center items-start gap-4 flex-wrap' },
            React.createElement('div', { className: 'flex flex-col' },
                React.createElement('div', { className: 'universe-stardust-display' }, `Stardust: ${formatNumber(availableStardust)}`),
                React.createElement('span', { className: 'text-sm text-purple-300 -mt-2' }, `(${formatNumber(stardustPerSecond)}/s)`)
            ),
            React.createElement('div', { className: 'flex flex-col' },
                React.createElement('div', { className: 'universe-stardust-display', style: {color: '#f59e0b', borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)'} }, `Energy: ${formatNumber(totalEnergy)}`),
                React.createElement('span', { className: 'text-sm text-amber-400 -mt-2' }, `(${formatNumber(energyPerSecond)}/s)`)
            ),
            React.createElement('div', { className: 'flex flex-col' },
                React.createElement('div', { className: 'universe-stardust-display', style: {color: '#34d399', borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.1)'} }, `Galactic Points: ${formatNumber(galacticPoints)}`)
            )
        ),
        React.createElement('div', { style: { fontSize: '1.2em', color: '#a78bfa', margin: '8px 0' } }, `Atom Multiplier: x${formatNumber(totalAtomMultiplier)}`),
        React.createElement('div', { style: { fontSize: '1.2em', color: '#754bf1', margin: '8px 0' } }, "Get Stardust by buying Black Hole Colliders (50 = 1 Stardust)"),
        
        (universeData.purchasedPlanets || []).includes("Sun") && React.createElement('div', { className: 'universe-shop-section' },
            React.createElement('h2', { style: { color: '#60a5fa' } }, 'Planetary Systems ðŸŒŒ'),
            React.createElement(PlanetarySystemManager, {
                planetarySystemReqs,
                systemProgress,
                onInvest: onInvestInPlanetarySystem,
                stellarNurseryCount,
                canFormSystem,
                onForm: onFormPlanetarySystem,
                availableStardust,
                totalEnergy,
                planetarySystemsCount: planetarySystems
            })
        ),
        
        (galacticPoints > 0 || (universeData.purchasedGalacticUpgrades || []).length > 0) && React.createElement('div', { className: 'universe-shop-section' },
            React.createElement('h2', { style: { color: '#34d399' } }, 'Galactic Upgrades ðŸš€'),
            React.createElement('div', { className: 'universe-shop-items-grid' },
                Object.entries(GALACTIC_UPGRADES).map(([id, data]) => {
                    const isPurchased = (universeData.purchasedGalacticUpgrades || []).includes(id);
                    return React.createElement(UniverseShopItem, {
                        key: id,
                        name: data.name,
                        description: data.description,
                        cost: data.cost,
                        costType: 'gp',
                        onBuy: () => onBuyGalacticUpgrade(id),
                        canAfford: galacticPoints >= data.cost,
                        isPurchased,
                    });
                })
            )
        ),

        React.createElement('div', { className: 'universe-shop-section' },
            React.createElement('h2', null, 'Planet Shop'),
            React.createElement('div', { className: 'universe-shop-items-grid' },
                Object.entries(UNIVERSE_PLANETS).map(([name, data]) => {
                    const cost = calculatePurchaseCost({ ...data, count: 0 }, 1);
                    const description = name === "Sun" 
                        ? `+${formatNumber(new D(data.energy))} Energy/s`
                        : `+${formatNumber(new D(data.energy))} Energy/s`;
                    return React.createElement(UniverseShopItem, {
                        key: name, name, cost: cost, costType: 'stardust', description: description,
                        onBuy: () => handleBuy('planet', name),
                        canAfford: availableStardust.gte(cost), 
                        isPurchased: (universeData.purchasedPlanets || []).includes(name),
                    })
                })
            )
        ),
        React.createElement('div', { className: 'universe-shop-section' },
            React.createElement('h2', null, 'Moon Shop'),
            React.createElement('div', { className: 'universe-shop-items-grid' },
                Object.entries(UNIVERSE_MOONS).map(([name, data]) => {
                    const cost = calculatePurchaseCost({ ...data, count: 0 }, 1);
                    return React.createElement(UniverseShopItem, {
                        key: name, name, cost: cost, costType: 'energy', description: `+${formatNumber(new D(data.stardust))} Stardust/s`,
                        onBuy: () => handleBuy('moon', name),
                        canAfford: totalEnergy.gte(cost), 
                        isPurchased: (universeData.purchasedMoons || []).includes(name),
                    })
                })
            )
        ),
        React.createElement('div', { className: 'universe-shop-section' },
            React.createElement('h2', null, 'Upgrades'),
            React.createElement('div', { className: 'universe-shop-items-grid' },
            Object.entries(UNIVERSE_UPGRADES).map(([name, data]) => {
                let effectText = '';
                if (data.effect === 'energy') effectText = 'Energy/s';
                else if (data.effect === 'atoms') effectText = 'Atom gain';
                else if (data.effect === 'moon') effectText = 'Stardust/s';
                else effectText = 'Effect';
                
                const description = `Effect: x${formatNumber(new D(data.multiplier))} ${effectText}`;
                const cost = calculatePurchaseCost({ ...data, count: 0 }, 1);

                return React.createElement(UniverseShopItem, {
                    key: name,
                    name,
                    cost: cost,
                    costType: 'energy',
                    description: description,
                    onBuy: () => handleBuy('upgrade', name),
                    canAfford: totalEnergy.gte(cost),
                    isPurchased: (universeData.purchasedUpgrades || []).includes(name),
                });
            })
            )
        ),
        React.createElement('div', { className: 'universe-shop-section' },
            React.createElement('h2', null, 'Universe Guide'),
            UNIVERSE_GUIDE_DATA.map(item => React.createElement('div', { key: item.title, className: 'universe-guide-item' },
                React.createElement('b', null, item.title),
                React.createElement('span', null, item.description)
            ))
        ),
        React.createElement('p', null, "Now you're building the Universe! The Stardust you've collected resonates with the cosmos."),
    );
};

const UniverseModal = ({ show, onClose, universeData, availableStardust, onBuyUniverseItem, totalEnergy, energyPerSecond, stardustPerSecond, stellarNurseryCount, planetarySystems, galacticPoints, onInvestInPlanetarySystem, onFormPlanetarySystem, onBuyGalacticUpgrade }) => {
    if (!show) return null;
    return React.createElement('div', { className: 'universe-modal-backdrop' },
        React.createElement('div', { className: 'universe-modal-content-wrapper' },
            React.createElement('button', { className: 'universe-modal-close-button', onClick: onClose }, 'Ã—'),
            React.createElement(UniverseContent, { 
                universeData: universeData || {}, 
                availableStardust, 
                onBuyItem: onBuyUniverseItem,
                totalEnergy,
                energyPerSecond,
                stardustPerSecond,
                stellarNurseryCount,
                planetarySystems,
                galacticPoints,
                onInvestInPlanetarySystem,
                onFormPlanetarySystem,
                onBuyGalacticUpgrade
            })
        )
    );
};


function AtomIcon({ className }) { return React.createElement("svg", { className, viewBox: "0 0 24 24", fill: "none", xmlns: "http://www.w3.org/2000/svg" }, React.createElement("path", { d: "M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}), React.createElement("path", { d: "M12 12L20.5 8", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}), React.createElement("path", { d: "M12 12L20.5 16", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}), React.createElement("path", { d: "M12 12L3.5 8", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}), React.createElement("path", { d: "M12 12L3.5 16", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"})); }
function UpgradeIcon({ className }) { return React.createElement("svg", { className, viewBox: "0 0 24 24", fill: "none", xmlns: "http://www.w3.org/2000/svg" }, React.createElement("path", { d: "M12 5V19", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}), React.createElement("path", { d: "M5 12H19", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}), React.createElement("path", { d: "M12 5L7 10", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}), React.createElement("path", { d: "M12 5L17 10", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"})); }
function GeneratorIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" }), React.createElement("circle", { cx: "12", cy: "12", r: "4" })); }
function PrestigeIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" })); }
function ResearchIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" }), React.createElement("line", { x1: "12", y1: "9", x2: "12", y2: "13" }), React.createElement("line", { x1: "12", y1: "17", x2: "12.01", y2: "17" })); }
function LockIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("rect", { x: "3", y: "11", width: "18", height: "11", rx: "2", ry: "2" }), React.createElement("path", { d: "M7 11V7a5 5 0 0 1 10 0v4" })); }
function LifeIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" })); }
function SubjectIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "12", cy: "7", r: "4" })); }
function HumanIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "9", cy: "7", r: "4" }), React.createElement("path", { d: "M23 21v-2a4 4 0 0 0-3-3.87" }), React.createElement("path", { d: "M16 3.13a4 4 0 0 1 0 7.75" })); }
function SuperHumanIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "10", cy: "7", r: "4" }), React.createElement("path", { d: "m21.64 7.64-1.28-1.28a1.2 1.2 0 0 0-1.7 0l-1.28 1.28a1.2 1.2 0 0 0 0 1.7l1.28 1.28a1.2 1.2 0 0 0 1.7 0l1.28-1.28a1.2 1.2 0 0 0 0-1.7z" })); }
function UniverseIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("circle", { cx: "12", cy: "12", r: "10" }), React.createElement("path", { d: "M2.93 9.07a10 10 0 0 1 14.14-14.14m4.95 4.95a10 10 0 0 1-14.14 14.14m-4.95-4.95a10 10 0 0 1 14.14-14.14" })); }
function MindIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M9 3a3 3 0 0 0-3 3v2a3 3 0 0 0 0 6v2a3 3 0 0 0 3 3" }), React.createElement("path", { d: "M15 3a3 3 0 0 1 3 3v2a3 3 0 0 1 0 6v2a3 3 0 0 1-3 3" }), React.createElement("path", { d: "M12 6v12" })); }
function NewBeingIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}), React.createElement("path", { d: "M12 7V12L15 15", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"})); }
function BrainIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M9.5 2A2.5 2.5 0 0 1 12 4.5v1.23c.33-.09.67-.16 1-.23a2.5 2.5 0 0 1 2.5 2.5v1.5a2.5 2.5 0 0 1-2.5 2.5h-2.5a2.5 2.5 0 0 1-2.5-2.5V9.5a2.5 2.5 0 0 1 2.5-2.5c.33.07.67.14 1 .23V4.5A2.5 2.5 0 0 1 9.5 2zM12 12h.5a2.5 2.5 0 0 1 2.5 2.5v1.5a2.5 2.5 0 0 1-2.5 2.5h-1A2.5 2.5 0 0 1 9 16v-1.5A2.5 2.5 0 0 1 11.5 12H12zM4.5 9.5A2.5 2.5 0 0 0 2 12v2.5a2.5 2.5 0 0 0 2.5 2.5h1.23c.09-.33.16-.67.23-1a2.5 2.5 0 0 0-2.5-2.5v-1.5a2.5 2.5 0 0 0 2.5-2.5c.07-.33.14-.67.23-1H4.5zm15 0c.07.33.14.67.23 1a2.5 2.5 0 0 0 2.5 2.5v1.5a2.5 2.5 0 0 0-2.5 2.5c-.09.33-.16.67-.23 1h1.23A2.5 2.5 0 0 0 22 14.5V12a2.5 2.5 0 0 0-2.5-2.5h-1.23z" })); }
function InfinityIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M12 12c-2-2.67-4-4-6-4a4 4 0 1 0 0 8c2 0 4-1.33 6-4zm0 0c2 2.67 4 4 6 4a4 4 0 1 0 0-8c-2 0-4 1.33-6 4z" })); }
function AutomationIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", { d: "M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 0l-1.63 1.63a1 1 0 0 0-.3 1.05v7.9a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h.7l-2.8-2.8c-.35-.35-1.02-.35-1.37 0L2 12.07a1 1 0 0 0 0 1.41l2.81 2.81c.35.35.35 1.02 0 1.37L1.4 19.4a1 1 0 0 0 0 1.4l.7.7a1 1 0 0 0 1.4 0l2.8-2.8c.35-.35 1.02-.35 1.37 0l2.8 2.8a1 1 0 0 0 1.4 0l.7-.7a1 1 0 0 0 0-1.4l-2.8-2.8c-.35-.35-.35-1.02 0-1.37l1.63-1.63c.2-.2.4-.3.6-.3h.7a2 2 0 0 1 2 2v2a2 2 0 0 1 2 2h2a2 2 0 0 1 2-2v-7.9c0-.2-.1-.4-.3-.6L14.7 6.3z" })); }
function GuideIcon({ className }) { return React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement("path", {d: "M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"}), React.createElement("path", {d: "M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"})); }

const Notification = ({ message, id, onDismiss }) => {
    const [visible, setVisible] = useState(true);
    useEffect(() => {
        const timer = setTimeout(() => { setVisible(false); }, 4000); 
        const fadeTimer = setTimeout(() => { onDismiss(id); }, 4500); 
        return () => { clearTimeout(timer); clearTimeout(fadeTimer); };
    }, [id, onDismiss]);
    return React.createElement('div', { className: `notification-item ${visible ? 'notification-show' : 'notification-hide'}`}, message);
};

const GAME_TICK_RATE_MS = 100;
const SAVE_INTERVAL_MS = 30000;
const PRESTIGE_REQUIREMENT = new D('1e9');
const RESEARCH_STARTING_BOOST_AMOUNT = 10;
const SUBJECTS_UNLOCK_REQUIREMENT = new D('1e27');
const HUMANS_UNLOCK_REQUIREMENT = new D('1e7');
const HUMAN_COST_INCREASE_FACTOR = 1.00000005;
const HUMAN_GENERATOR_BONUS_PER_HUMAN = 0.25;
const HUMAN_SKILL_POINTS_PER_SECOND_PER_HUMAN = 0.0025;
const SUPER_HUMAN_UNLOCK_REQUIREMENT = new D('1e6');
const SUPER_HUMAN_COST_INCREASE_FACTOR = 1.5;
const ARTIFICIAL_INGENUITY_PER_SUPER_HUMAN_PER_SECOND = 2.5;
const POST_SUPER_HUMANS_REQUIREMENT = new D('10'); // Super Humans
const MIND_UNLOCK_REQUIREMENT = 20;
const MIND_XP_BASE = 100;
const MIND_XP_FACTOR = 1.31;
const AI_TO_XP = 10;
const SP_TO_XP = 1e-5;

const MIND_MILESTONES = [
    { level: 5, description: "Skill Point generation +100%", effect: { type: 'sp_gen', value: 2 } },
    { level: 10, description: "Artificial Ingenuity generation +100%", effect: { type: 'ai_gen', value: 2 } },
    { level: 15, description: "Skill Point generation +250%", effect: { type: 'sp_gen', value: 3.5 } },
    { level: 20, description: "Artificial Ingenuity generation +250%", effect: { type: 'ai_gen', value: 3.5 } },
    { level: 25, description: "Super Human Gain Discount bonus x2", effect: { type: 'shg_bonus_mult', value: 2 } },
    { level: 30, description: "Human Gain Discount bonus x2", effect: { type: 'hg_bonus_mult', value: 2 } },
    { level: 35, description: "Add 5 max levels to Temporal Prestige", effect: { type: 'ps3_max_level', value: 5 } },
    { level: 40, description: "Super Human Gain Discount bonus x3", effect: { type: 'shg_bonus_mult', value: 3 } },
    { level: 45, description: "Human Gain Discount bonus x3", effect: { type: 'hg_bonus_mult', value: 3 } },
    { level: 50, description: "Every 1b Humans adds +5 max levels to Cosmic Consciousness (limited to 1t Humans)", effect: { type: 'unlock_human_consciousness_scaling', value: true } },
    { level: 55, description: "Skill Point generation +500%", effect: { type: 'sp_gen', value: 6 } },
    { level: 60, description: "Artificial Ingenuity generation +500%", effect: { type: 'ai_gen', value: 6 } },
    { level: 65, description: "Add 5 max levels to Temporal Prestige", effect: { type: 'ps3_max_level', value: 5 } },
    { level: 70, description: "Super Human Gain Discount bonus x3", effect: { type: 'shg_bonus_mult', value: 3 } },
    { level: 75, description: "Human Gain Discount bonus x3", effect: { type: 'hg_bonus_mult', value: 3 } },
    { level: 80, description: "Add 10 max levels to Temporal Prestige", effect: { type: 'ps3_max_level', value: 10 } },
    { level: 85, description: 'Skill Point generation +1000%', effect: { type: 'sp_gen', value: 10 } },
    { level: 90, description: 'Artificial Ingenuity generation +1000%', effect: { type: 'ai_gen', value: 10 } },
    { level: 95, description: "Add 20 max levels to Temporal Prestige", effect: { type: 'ps3_max_level', value: 20 } },
    { level: 100, description: "Every 1000 A-05 Subjects adds +5 max levels to Vital Symbiosis.", effect: { type: 'unlock_pantheon_symbiosis_scaling', value: true } },

];

const INITIAL_GENERATORS = [
  {id: 'gen1', name: 'Particle Accelerator', description: 'Generates atoms by colliding particles.', isHidden: false, baseCost: new D(1), costIncreaseFactor: 1.15, baseProduction: new D(0.1), icon: React.createElement(GeneratorIcon, { className: "w-8 h-8 text-cyan-400" })},
  {id: 'gen2', name: 'Stellar Nursery', description: 'Forges atoms in the heart of a protostar.', isHidden: false, baseCost: new D(25), costIncreaseFactor: 1.20, baseProduction: new D(1), icon: React.createElement(GeneratorIcon, { className: "w-8 h-8 text-amber-400" })},
  {id: 'gen3', name: 'Quark Factory', description: 'Assembles protons and neutrons from scratch.', isHidden: false, baseCost: new D(250), costIncreaseFactor: 1.25, baseProduction: new D(10), icon: React.createElement(GeneratorIcon, { className: "w-8 h-8 text-rose-400" })},
  {id: 'gen4', name: 'Supernova Forge', description: 'Creates heavy elements in a stellar explosion.', isHidden: false, baseCost: new D(5000), costIncreaseFactor: 1.30, baseProduction: new D(150), icon: React.createElement(GeneratorIcon, { className: "w-8 h-8 text-indigo-400" })},
  {id: 'gen5', name: 'Black Hole Collider', description: 'Harnesses the power of black holes to generate atoms.', isHidden: true, baseCost: new D(1e114), costIncreaseFactor: 1.35, baseProduction: new D(1e65), icon: React.createElement(GeneratorIcon, { className: "w-8 h-8 text-purple-400" })},
];
const INITIAL_UPGRADES = [
  {id: 'upg0', name: 'Quantum Leap', description: 'Increases all atom production by 50% per level.', isHidden: true, baseCost: new D(500), costIncreaseFactor: 5, effect: () => 1.5, maxLevel: 10, icon: React.createElement(UpgradeIcon, { className: "w-8 h-8 text-green-400" })},
  {id: 'upg1', name: 'Faster Particles', description: 'Increases all atom production by 100% per level.', isHidden: false, baseCost: new D(1000), costIncreaseFactor: 10, effect: () => 2, maxLevel: 10, icon: React.createElement(UpgradeIcon, { className: "w-8 h-8 text-teal-400" })},
  {id: 'upg2', name: 'Magnetic Cooling', description: 'Doubles the production of Particle Accelerators.', isHidden: false, baseCost: new D(2000), costIncreaseFactor: 10, effect: () => 2, maxLevel: 10, appliesToGenerator: 'gen1', icon: React.createElement(UpgradeIcon, { className: "w-8 h-8 text-sky-400" })},
  {id: 'upg3', name: 'Efficient Fusion', description: 'Increases all atom production by 200% per level.', isHidden: false, baseCost: new D(10000), costIncreaseFactor: 20, effect: () => 3, maxLevel: 10, icon: React.createElement(UpgradeIcon, { className: "w-8 h-8 text-fuchsia-400" })},
  {id: 'upg4', name: 'Cosmic Consciousness', description: 'Increases Life production by 50% per level.', isHidden: false, baseCost: new D('1e27'), costIncreaseFactor: 7.5, effect: () => 1.5, maxLevel: 10, icon: React.createElement(UpgradeIcon, { className: "w-8 h-8 text-violet-400" }), unlockCondition: (gs) => gs.subjectsUnlocked},
  {id: 'upg5', name: 'Vital Symbiosis', description: 'Each Life now grants an additional 10% atom bonus.', isHidden: false, baseCost: new D('1e30'), costIncreaseFactor: 15, effect: () => 1.1, maxLevel: 10, icon: React.createElement(UpgradeIcon, { className: "w-8 h-8 text-rose-400" }), unlockCondition: (gs) => gs.subjectsUnlocked}
];
const RESEARCH_TREE = [
    {id: 'res1', name: 'Generator Synergy', description: 'Increases global production by 50%.',                                                                           cost: new D(1), dependencies: [], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-green-400" })},
    {id: 'res2', name: 'Quick Start', description: `Start with ${RESEARCH_STARTING_BOOST_AMOUNT} Particle Accelerators after a Prestige.`,                                cost: new D(10), dependencies: ['res1'], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-cyan-400" })},
    {id: 'res3', name: 'Enhanced Prestige', description: 'Each Prestige Point now gives a 1.5% bonus instead of 1%.',                                                     cost: new D(50), dependencies: ['res1'], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-yellow-400" })},
    {id: 'res4', name: 'Loyalty Bonus', description: 'Keep 1% of your atoms on prestige.',                                                                                cost: new D(100), dependencies: ['res3', 'res2'], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-indigo-400" })},
    {id: 'res5', name: 'Accelerating the Accelerator', description: 'For every 50 Supernova Forges, +5 max levels to Magnetic Cooling.',                                  cost: new D(1000), dependencies: ['res4'], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-indigo-400" })},
    {id: 'res0', name: 'Enhanced Prestige II', description: 'Each Prestige Point now gives a 2% bonus instead of 1%.',                                                    cost: new D(10000), dependencies: ['res5'], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-yellow-400" })},
    {id: 'res6', name: 'Atomic Singularity', description: 'The Life bonus to atoms is 25% more effective.',                                                               cost: new D('1e10'), dependencies: ['res5'], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-red-500" }), unlockCondition: (gs) => gs.subjectsUnlocked},
    {id: 'res7', name: 'Synergy of Origins', description: 'For each 10 A-01 Subjects, +5 max levels to Cosmic Consciousness.',                               cost: new D('1e12'), dependencies: ['res6'], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-pink-400" }), unlockCondition: (gs) => gs.subjectsUnlocked},
    {id: 'res8', name: 'Generator Automation', description: 'Unlocks the ability to set individual generators to be purchased automatically.',                            cost: new D('5e15'), dependencies: ['res7'], icon: React.createElement(AutomationIcon, { className: "w-8 h-8 text-blue-400" }), unlockCondition: (gs) => gs.humansUnlocked && gs.subjectsUnlocked},
    {id: 'res9', name: 'Automated Upgrades', description: 'Automatically buys the cheapest affordable upgrade.',                                                          cost: new D('1e16'), dependencies: ['res8'], icon: React.createElement(AutomationIcon, { className: "w-8 h-8 text-purple-400" }), unlockCondition: (gs) => gs.humansUnlocked && gs.subjectsUnlocked},
    {id: 'res10', name: 'Automated Research', description: 'Automatically researches the cheapest affordable research.',                                                  cost: new D('5e18'), dependencies: ['res9'], icon: React.createElement(AutomationIcon, { className: "w-8 h-8 text-yellow-400" }), unlockCondition: (gs) => gs.superHumansUnlocked},
    {id: 'res11', name: 'Universal Power', description: 'Unlock Stardust generation. Gain 1 Stardust for every 50 Black Hole Colliders owned (based on historical max).', cost: new D('1e75'), dependencies: ['res10'], icon: React.createElement(ResearchIcon, { className: "w-8 h-8 text-gray-400" }), unlockCondition: (gs) => gs.superHumans >= Number(POST_SUPER_HUMANS_REQUIREMENT)},    {id: 'res12', name: 'Life Tech Automation', description: 'Automatically buys the cheapest affordable Life Technology.', cost: new D('1e22'), dependencies: ['res10'], icon: React.createElement(AutomationIcon, { className: "w-8 h-8 text-red-300" }), unlockCondition: (gs) => gs.superHumansUnlocked },
    {id: 'res13', name: 'Human Skill Automation', description: 'Automatically buys the cheapest affordable Human Skill.',                                                 cost: new D('1e30'), dependencies: ['res12'], icon: React.createElement(AutomationIcon, { className: "w-8 h-8 text-pink-300" }), unlockCondition: (gs) => gs.superHumansUnlocked },
    {id: 'res14', name: 'Super Human Skill Automation', description: 'Automatically buys the cheapest affordable Super Human Skill.',                                     cost: new D('1e55'), dependencies: ['res13'], icon: React.createElement(AutomationIcon, { className: "w-8 h-8 text-sky-300" }), unlockCondition: (gs) => gs.superHumansUnlocked },
    {id: 'res15', name: 'Infinite Project Automation', description: 'Automatically buys the cheapest affordable Infinite Project.',                                       cost: new D('1e80'), dependencies: ['res14'], icon: React.createElement(AutomationIcon, { className: "w-8 h-8 text-purple-300" }), unlockCondition: (gs) => gs.superHumansUnlocked },
    {id: 'res16', name: 'Subject Automation', description: 'Unlocks the ability to set individual subjects to be purchased automatically.',                               cost: new D('1e100'), dependencies: ['res15'], icon: React.createElement(AutomationIcon, { className: "w-8 h-8 text-red-300" }), unlockCondition: (gs) => gs.superHumansUnlocked },
];
const INITIAL_SUBJECTS = [
    {id: 'sub1', name: 'A-01: The Origin', description: 'Initiates the creation of Lives.', baseCost: SUBJECTS_UNLOCK_REQUIREMENT, costIncreaseFactor: 500, costResource: 'atoms', baseLifeProduction: new D(0.01), icon: React.createElement(SubjectIcon, { className: "w-8 h-8 text-white" })},
    {id: 'sub2', name: 'A-02: The Successor', description: 'Increases Life production.', baseCost: new D(1), costIncreaseFactor: 1.1, costResource: 'lives', baseLifeProduction: new D(0.1), icon: React.createElement(SubjectIcon, { className: "w-8 h-8 text-red-400" })},
    {id: 'sub3', name: 'A-03: The Colony', description: 'Multiplies Life production.', baseCost: new D(100), costIncreaseFactor: 1.1, costResource: 'lives', baseLifeProduction: new D(1), icon: React.createElement(SubjectIcon, { className: "w-8 h-8 text-orange-400" })},
    {id: 'sub4', name: 'A-04: The Consciousness', description: 'Drastically accelerates Life generation.', baseCost: new D(10000), costIncreaseFactor: 1.1, costResource: 'lives', baseLifeProduction: new D(10), icon: React.createElement(SubjectIcon, { className: "w-8 h-8 text-yellow-400" })},
    {id: 'sub5', name: 'A-05: The Pantheon', description: 'Reaches a transcendental state of Life creation.', baseCost: new D('1e6'), costIncreaseFactor: 1.1, costResource: 'lives', baseLifeProduction: new D(200), icon: React.createElement(SubjectIcon, { className: "w-8 h-8 text-purple-400" })}
];
const HUMAN_SKILLS = [
    {id: 'hs1', name: 'Human Ingenuity', description: 'Increases the additive bonus of each Human by +1% per level.', baseCost: new D(1), costIncreaseFactor: 1.5, icon: React.createElement(BrainIcon, {className: "w-8 h-8 text-pink-400"})},
    {id: 'hs2', name: 'Efficient Engineering', description: 'Reduces the cost of all generators by 5% per level.', baseCost: new D(10), costIncreaseFactor: 2, maxLevel: 50, icon: React.createElement(GeneratorIcon, {className: "w-8 h-8 text-teal-400"})},
    {id: 'hs3', name: 'Life Essence', description: 'Increases all Life production by 1% per level.', baseCost: new D(5), costIncreaseFactor: 1.8, icon: React.createElement(LifeIcon, {className: "w-8 h-8 text-rose-400"})}
];
const INFINITE_PROJECTS = [
    {id: 'ip1', name: 'Infinite Atom Drive', description: 'Increases all atom production by 10%.', baseCost: new D('1e30'), costIncreaseFactor: 1e3, icon: React.createElement(InfinityIcon, {className: "w-8 h-8 text-cyan-300"})},
    {id: 'ip2', name: 'Endless Knowledge', description: 'Increases Skill Point generation by 10%.', baseCost: new D('1e33'), costIncreaseFactor: 1e4, icon: React.createElement(InfinityIcon, {className: "w-8 h-8 text-purple-300"})}
];
const INITIAL_PRESTIGE_SKILLS = [
    {id: 'ps1', name: 'Prestige Efficiency', description: 'Increases Prestige Point gain by 10% per level.', baseCost: new D(10), costIncreaseFactor: 1.5, maxLevel: 50, icon: React.createElement(PrestigeIcon, {className: "w-8 h-8 text-yellow-300"})},
    {id: 'ps2', name: 'Research Acceleration', description: 'Reduces research costs by 1% per level.', baseCost: new D(50), costIncreaseFactor: 3, maxLevel: 50, icon: React.createElement(ResearchIcon, {className: "w-8 h-8 text-yellow-500"})},
    {id: 'ps3', name: 'Temporal Prestige', description: 'Passively generate 1% of your current Prestige Points per second, per level.', baseCost: new D('1e12'), costIncreaseFactor: 50, maxLevel: 5, icon: React.createElement(InfinityIcon, {className: "w-8 h-8 text-purple-300"})}
];
const INITIAL_LIFE_TECHNOLOGIES = [
    {id: 'lt1', name: 'Enhanced Vitality', description: 'Increases all Life production by 10% per level.', baseCost: new D(1000), costIncreaseFactor: 2, icon: React.createElement(LifeIcon, {className: "w-8 h-8 text-red-300"})},
    {id: 'lt2', name: 'Symbiotic Evolution', description: 'Increases the effect of Vital Symbiosis (upg5) by 10% per level.', baseCost: new D(5000), costIncreaseFactor: 3, icon: React.createElement(UpgradeIcon, {className: "w-8 h-8 text-rose-400"})},
    {id: 'lt3', name: 'Consciousness Expansion', description: 'Increases the effect of Cosmic Consciousness (upg4) by 2% per level.', baseCost: new D(10000), costIncreaseFactor: 5, icon: React.createElement(BrainIcon, {className: "w-8 h-8 text-violet-400"})},
];
const INITIAL_SUPER_HUMAN_SKILLS = [
    {id: 'shs1', name: 'Transcendent Mind', description: 'Increases Artificial Ingenuity production by 10% per level.', baseCost: new D(1), costIncreaseFactor: 2, icon: React.createElement(BrainIcon, {className: "w-8 h-8 text-sky-300"})},
    {id: 'shs2', name: 'Stellar Amplification', description: 'Increases Stellar Nursery production by 500% per level.', baseCost: new D(3), costIncreaseFactor: 4, icon: React.createElement(GeneratorIcon, {className: "w-8 h-8 text-amber-300"})},
    {id: 'shs3', name: 'Cosmic Architects', description: 'Increases the additive bonus of each Human by +0.01 per level.', baseCost: new D(5), costIncreaseFactor: 5, icon: React.createElement(HumanIcon, {className: "w-8 h-8 text-green-300"})},
    {id: 'shs4', name: 'Accelerated Evolution', description: 'Increases Skill Point generation by 50% per level.', baseCost: new D(10), costIncreaseFactor: 3, icon: React.createElement(InfinityIcon, {className: "w-8 h-8 text-pink-300"})},
    {id: 'shs5', name: 'Singularity Start', description: 'Start with 10 Humans after a Super Human reset per level.', baseCost: new D(1000), costIncreaseFactor: 10, maxLevel: 10, icon: React.createElement(SuperHumanIcon, {className: "w-8 h-8 text-purple-300"})}
];

const Header = ({ atoms, atomsPerSecond, prestigePoints, prestigePointsPerSecond, lives, livesPerSecond, subjectsUnlocked, humans, humansUnlocked, skillPoints, superHumans, artificialIngenuity, superHumansUnlocked, skillPointGenerationRate, artificialIngenuityPerSecond, numberFormat }) => {
  return React.createElement("header", { className: "bg-slate-900/50 backdrop-blur-sm sticky top-0 z-10 p-4 border-b border-slate-700" },
      React.createElement("div", { className: "max-w-7xl mx-auto flex justify-between items-center gap-4" },
        React.createElement("div", { className: "flex items-center space-x-3" },
            React.createElement(AtomIcon, { className: "w-10 h-10 text-cyan-300 animate-pulse" }),
        React.createElement("div", { className: "flex items-baseline gap-2" },
        React.createElement("h1", { className: "text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 to-blue-500" }, "Atom Idle"),
        React.createElement("span", { className: "text-sm font-mono text-slate-400" }, "V0.4.1")
        ) 
        ),
        React.createElement("div", { className: "flex items-center gap-2 md:gap-6 flex-wrap justify-end" },
            superHumansUnlocked && React.createElement("div", { className: "text-right" },
                React.createElement("p", { className: "text-lg md:text-xl font-mono font-bold text-sky-400 flex items-center justify-end gap-2" }, React.createElement(SuperHumanIcon, { className: "w-5 h-5" }), formatNumber(superHumans, numberFormat)),
                React.createElement("p", { className: "text-xs md:text-sm text-sky-500" }, "Super Humans")
            ),
             superHumansUnlocked && React.createElement("div", { className: "text-right" },
                React.createElement("p", { className: "text-lg md:text-xl font-mono font-bold text-purple-400 flex items-center justify-end gap-2" }, React.createElement(BrainIcon, { className: "w-5 h-5" }), formatNumber(artificialIngenuity, numberFormat)),
                React.createElement("p", { className: "text-xs md:text-sm text-purple-500" }, formatNumber(artificialIngenuityPerSecond, numberFormat), " Ingenuity/s")
            ),
            humansUnlocked && React.createElement("div", { className: "text-right" },
                React.createElement("p", { className: "text-lg md:text-xl font-mono font-bold text-pink-400 flex items-center justify-end gap-2" }, React.createElement(BrainIcon, { className: "w-5 h-5" }), formatNumber(skillPoints, numberFormat)),
                React.createElement("p", { className: "text-xs md:text-sm text-pink-500" }, formatNumber(skillPointGenerationRate, numberFormat), " SP/s")
            ),
            humansUnlocked && React.createElement("div", { className: "text-right" },
                React.createElement("p", { className: "text-lg md:text-xl font-mono font-bold text-green-400 flex items-center justify-end gap-2" }, React.createElement(HumanIcon, { className: "w-5 h-5" }), formatNumber(humans.total, numberFormat)),
                React.createElement("p", { className: "text-xs md:text-sm text-green-500" }, "Humans")
            ),
            subjectsUnlocked && React.createElement("div", { className: "text-right" },
                React.createElement("p", { className: "text-lg md:text-xl font-mono font-bold text-red-400 flex items-center justify-end gap-2" }, React.createElement(LifeIcon, { className: "w-5 h-5" }), formatNumber(lives, numberFormat)),
                React.createElement("p", { className: "text-xs md:text-sm text-red-500" }, formatNumber(livesPerSecond, numberFormat), " Lives/s")
            ),
            (atoms.gte(PRESTIGE_REQUIREMENT) || prestigePoints.gt(0)) && React.createElement("div", { className: "text-right" },
                React.createElement("p", { className: "text-lg md:text-xl font-mono font-bold text-yellow-400 flex items-center justify-end gap-2" },
                    React.createElement(PrestigeIcon, { className: "w-5 h-5" }),
                    formatNumber(prestigePoints, numberFormat)
                ),
                prestigePointsPerSecond.gt(0) 
                  ? React.createElement("p", { className: "text-xs md:text-sm text-yellow-500" }, formatNumber(prestigePointsPerSecond, numberFormat), " PP/s")
                  : React.createElement("p", { className: "text-xs md:text-sm text-yellow-500" }, "Prestige Points")
            ),
            React.createElement("div", { className: "text-right" },
                React.createElement("p", { className: "text-xl md:text-2xl font-mono font-bold text-white" }, formatNumber(atoms, numberFormat)),
                React.createElement("p", { className: "text-xs md:text-sm text-cyan-400" }, formatNumber(atomsPerSecond, numberFormat), " atoms/s")
            )
        )
      )
    );
};

const GeneratorItem = ({ generator, onBuy, atoms, buyAmount, assignedHumans, humanBonusPerHuman, totalGlobalMultiplier, prestigeBonus, researchMultiplier, lifeBonus, infiniteProjectBonus, ip1Special, specificGeneratorMultipliers, superHumanSkills, isAutomationUnlocked, isAutomated, onToggleAutomation, numberFormat }) => {
  const amountToBuy = useMemo(() => {
    if (buyAmount === 'MAX') return calculateMaxAffordable(generator, atoms);
    return buyAmount;
  }, [buyAmount, generator, atoms]);

  const cost = useMemo(() => calculatePurchaseCost(generator, amountToBuy), [generator, amountToBuy]);

  const displayCost = useMemo(() => {
    if (buyAmount === 'MAX' && amountToBuy === 0) return calculatePurchaseCost(generator, 1);
    return cost;
  }, [buyAmount, amountToBuy, cost, generator]);

  const canAfford = atoms.gte(cost) && amountToBuy > 0;
  const humanBonus = assignedHumans * humanBonusPerHuman * 100;

  const specificMultiplier = specificGeneratorMultipliers[generator.id] || new D(1);
  const humanBonusMultiplier = new D(1).plus(new D(assignedHumans).mul(humanBonusPerHuman));
  
  let gen2Boost = new D(1);
    if (generator.id === 'gen2' && superHumanSkills) {
        const gen2Skill = superHumanSkills.find(s => s.id === 'shs2');
        if (gen2Skill) {
            gen2Boost = new D(6).pow(gen2Skill.level);
        }
    }

  const effectiveProductionPerGenerator = new D(generator.baseProduction).mul(specificMultiplier).mul(humanBonusMultiplier).mul(totalGlobalMultiplier).mul(prestigeBonus).mul(researchMultiplier).mul(lifeBonus).mul(infiniteProjectBonus).mul(ip1Special).mul(gen2Boost);
  const totalProductionFromGenerator = effectiveProductionPerGenerator.mul(generator.count);

  return React.createElement("div", { className: "relative bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 hover:border-cyan-500 hover:bg-slate-800" },
      React.createElement("div", { className: "flex-shrink-0" }, generator.icon),
      React.createElement("div", { className: "flex-grow" },
        React.createElement("div", { className: "flex justify-between items-baseline" },
            React.createElement("h3", { className: "text-lg font-bold text-white flex items-center gap-2" },
                generator.name,
                isAutomationUnlocked && React.createElement("button", {
                    title: "Toggle Automation",
                    onClick: () => onToggleAutomation(generator.id),
                    className: `w-10 h-6 rounded-full p-1 flex items-center transition-colors duration-300 ml-2 ${isAutomated ? 'bg-green-500 justify-end' : 'bg-slate-600 justify-start'}`
                },
                    React.createElement("span", { className: "block w-4 h-4 bg-white rounded-full" })
                )
            ),
            React.createElement("span", { className: "text-2xl font-bold text-slate-300" }, formatNumber(generator.count, numberFormat))
        ),
        React.createElement("p", { className: "text-sm text-slate-400" }, generator.description),
        React.createElement("p", { className: "text-sm text-cyan-400" }, "+", formatNumber(effectiveProductionPerGenerator, numberFormat), " APS each (Total: ", formatNumber(totalProductionFromGenerator, numberFormat), " APS)"),
        humanBonus > 0 && React.createElement("p", { className: "text-sm text-green-400" }, "+", formatNumber(humanBonus, numberFormat), "% from Humans")
      ),
      React.createElement("button", { onClick: () => onBuy(generator.id, amountToBuy), disabled: !canAfford, className: `w-32 flex-shrink-0 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${ canAfford ? 'bg-cyan-400 hover:bg-cyan-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed' }`},
        amountToBuy > 1 ? `Buy x${formatNumber(amountToBuy, numberFormat)}` : 'Buy', React.createElement("br"), React.createElement("span", { className: "font-mono" }, formatNumber(displayCost, numberFormat)))
    );
};

const UpgradeItem = ({ upgrade, onBuy, atoms, buyAmount, numberFormat }) => {
  const isAlreadyMaxLevel = upgrade.maxLevel !== undefined && upgrade.level >= upgrade.maxLevel;
  const amountToBuy = useMemo(() => {
    if (isAlreadyMaxLevel) return 0;
    let desiredAmount = buyAmount === 'MAX' ? calculateMaxAffordable({ ...upgrade, count: upgrade.level }, atoms) : buyAmount;
    if (upgrade.maxLevel !== undefined) return Math.min(desiredAmount, upgrade.maxLevel - upgrade.level);
    return desiredAmount;
  }, [buyAmount, upgrade, atoms, isAlreadyMaxLevel]);

  const cost = useMemo(() => {
    if (amountToBuy <= 0) return new D(0);
    return calculatePurchaseCost({ ...upgrade, count: upgrade.level }, amountToBuy);
  }, [upgrade, amountToBuy]);

  const displayCost = useMemo(() => {
      if (buyAmount === 'MAX' && amountToBuy === 0 && !isAlreadyMaxLevel) return calculatePurchaseCost({ ...upgrade, count: upgrade.level }, 1);
      return cost;
  }, [buyAmount, amountToBuy, cost, upgrade, isAlreadyMaxLevel]);
  
  const canAfford = atoms.gte(cost) && amountToBuy > 0;
  return React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 hover:border-teal-500 hover:bg-slate-800" },
      React.createElement("div", { className: "flex-shrink-0" }, upgrade.icon),
      React.createElement("div", { className: "flex-grow" },
        React.createElement("h3", { className: "text-lg font-bold text-white" }, upgrade.name),
        React.createElement("p", { className: "text-sm text-slate-400" }, upgrade.description),
        upgrade.maxLevel !== undefined ? React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", upgrade.level, " / ", Math.max(upgrade.level, upgrade.maxLevel)) : React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", upgrade.level),
      ),
      React.createElement("button", { onClick: () => onBuy(upgrade.id, amountToBuy), disabled: !canAfford || isAlreadyMaxLevel, className: `w-32 flex-shrink-0 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${ isAlreadyMaxLevel ? 'bg-green-500 cursor-not-allowed' : canAfford ? 'bg-teal-400 hover:bg-teal-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed' }`},
        isAlreadyMaxLevel ? 'MAX' : amountToBuy > 1 ? `Buy x${formatNumber(amountToBuy, numberFormat)}` : 'Buy',
        !isAlreadyMaxLevel && React.createElement(React.Fragment, null, React.createElement("br"), React.createElement("span", { className: "font-mono" }, formatNumber(displayCost, numberFormat)))
      )
    );
};

function calculatePrestigeGainWithSoftcap(currentPrestige, prestigeToGain) {
    const SOFTCAP_START = new D('1e114'); 
    const SOFTCAP_FACTOR = new D('1.0000000000000001');  
    const current = new D(currentPrestige);
    const gain = new D(prestigeToGain);

    if (current.add(gain).lte(SOFTCAP_START)) {
        return gain.floor();
    }

    const normalGain = D.max(0, SOFTCAP_START.sub(current));
    const overGain = gain.sub(normalGain);

    let pointsFromOverGain;

    if (overGain.lte(0)) {
        pointsFromOverGain = new D(0);
    } else {

        const r_minus_1 = SOFTCAP_FACTOR.sub(1); 
        const log_argument = overGain.mul(r_minus_1).add(1);
        
        if (log_argument.lte(1)) {
            pointsFromOverGain = new D(0);
        } else {
            pointsFromOverGain = log_argument.log(SOFTCAP_FACTOR);
        }
    }
    
    return normalGain.add(pointsFromOverGain).floor();
}

const PrestigeDisplay = ({ atoms, prestigePoints, onPrestige, prestigeRequirement, research, prestigeSkillBonus, galacticBonus, numberFormat }) => {
  
  const canPrestige = atoms.gte(prestigeRequirement);
  const prestigePointsOnResetBase = atoms.div(prestigeRequirement).sqrt().mul(prestigeSkillBonus).mul(galacticBonus);
  const prestigePointsOnReset = calculatePrestigeGainWithSoftcap(prestigePoints, prestigePointsOnResetBase);


  let prestigeBonusPercentage;
  if(research.find(r => r.id === 'res0')?.isPurchased) {
      prestigeBonusPercentage = 1.02;
  }
  else if (research.find(r => r.id === 'res3')?.isPurchased) {
      prestigeBonusPercentage = 1.015;
  }
  else {
      prestigeBonusPercentage = 1.01;
  }


  const totalBonus = prestigePoints.mul(prestigeBonusPercentage - 1).mul(100);

  return React.createElement("div", { className: "mt-8" },
      React.createElement("h2", { className: "text-2xl font-bold mb-4 flex items-center gap-2 text-slate-300" }, React.createElement(PrestigeIcon, { className: "w-6 h-6 text-yellow-300" }), "Prestige"),
      React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex flex-col md:flex-row items-center justify-between gap-4" },
        React.createElement("div", null,
          React.createElement("p", { className: "text-slate-300" }, "Prestige Points: ", React.createElement("span", { className: "font-bold text-yellow-300" }, formatNumber(prestigePoints, numberFormat))),
          React.createElement("p", { className: "text-slate-400 text-sm" }, "Total production bonus: ", React.createElement("span", { className: "font-bold text-yellow-400" }, "+", formatNumber(totalBonus, numberFormat), "%")),
          React.createElement("p", { className: "text-xs text-slate-500 mt-1" }, "You will reset your progress to gain Prestige Points that permanently increase your production.")
        ),
        React.createElement("button", { onClick: onPrestige, disabled: !canPrestige, className: `px-6 py-3 font-bold rounded-lg transition-all duration-200 text-slate-900 ${ canPrestige ? 'bg-yellow-400 hover:bg-yellow-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed' }`},
          React.createElement("div", null, "Prestige for +", formatNumber(prestigePointsOnReset, numberFormat), " Points"),
          React.createElement("div", { className: "text-xs font-normal" }, "Requires ", formatNumber(prestigeRequirement, numberFormat), " atoms")
        )
      )
    );
};

const ResearchItem = ({ research, allResearch, prestigePoints, onBuy, researchCostReduction, numberFormat }) => {
    const dependencies = research.dependencies.map(depId => allResearch.find(r => r.id === depId)).filter(r => !!r);
    const dependenciesMet = dependencies.every(dep => dep.isPurchased);
    const effectiveCost = new D(research.cost).mul(researchCostReduction);
    const canAfford = prestigePoints.gte(effectiveCost);
    const canBuy = !research.isPurchased && dependenciesMet && canAfford;
    const isLocked = !research.isPurchased && !dependenciesMet;
    let buttonContent, buttonClass;
    if (research.isPurchased) {
        buttonContent = 'Purchased';
        buttonClass = 'bg-green-600 cursor-not-allowed';
    } else if (isLocked) {
        buttonContent = React.createElement(LockIcon, { className: "w-5 h-5 mx-auto" });
        buttonClass = 'bg-slate-700 cursor-not-allowed';
    } else {
        buttonContent = React.createElement("div", { className: "flex items-center justify-center gap-2" }, React.createElement(PrestigeIcon, { className: "w-5 h-5" }), React.createElement("span", null, formatNumber(effectiveCost, numberFormat)));
        buttonClass = canBuy ? 'bg-yellow-500 hover:bg-yellow-400 active:scale-95 text-slate-900' : 'bg-slate-600 cursor-not-allowed text-slate-400';
    }
    return React.createElement("div", { className: `bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 ${research.isPurchased ? 'border-green-500' : isLocked ? 'opacity-60' : 'hover:border-yellow-500'}`},
            React.createElement("div", { className: "flex-shrink-0" }, research.icon),
            React.createElement("div", { className: "flex-grow" },
                React.createElement("h3", { className: "text-lg font-bold text-white" }, research.name),
                React.createElement("p", { className: "text-sm text-slate-400" }, research.description),
                isLocked && React.createElement("div", { className: "text-xs text-rose-400 mt-1" }, "Requires: ", dependencies.filter(d => !d.isPurchased).map(d => d.name).join(', '))
            ),
            React.createElement("button", { onClick: () => onBuy(research.id), disabled: !canBuy || isLocked || research.isPurchased, className: `w-32 flex-shrink-0 h-12 px-4 py-2 font-bold rounded-lg transition-all duration-200 ${buttonClass}`}, buttonContent)
        );
};

const InfiniteProjectItem = ({ project, onBuy, atoms, numberFormat }) => {
    const cost = new D(project.baseCost).mul(new D(project.costIncreaseFactor).pow(project.level));
    const canAfford = atoms.gte(cost);

    return React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 hover:border-purple-500 hover:bg-slate-800" },
        React.createElement("div", { className: "flex-shrink-0" }, project.icon),
        React.createElement("div", { className: "flex-grow" },
            React.createElement("h3", { className: "text-lg font-bold text-white" }, project.name),
            React.createElement("p", { className: "text-sm text-slate-400" }, project.description),
            React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(project.level, numberFormat))
        ),
        React.createElement("button", {
            onClick: () => onBuy(project.id),
            disabled: !canAfford,
            className: `w-40 flex-shrink-0 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${canAfford ? 'bg-purple-400 hover:bg-purple-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed'}`
        },
            "Upgrade", React.createElement("br"), React.createElement("span", { className: "font-mono" }, formatNumber(cost, numberFormat), " Atoms")
        )
    );
};


const ResearchTree = ({ research, prestigePoints, onBuyResearch, infiniteProjects, onBuyInfiniteProject, atoms, researchCostReduction, numberFormat }) => {
    if (research.length === 0) return null;
    const areAnyHumansUnlocked = infiniteProjects.length > 0;

    return React.createElement("div", { className: "mt-8" },
        React.createElement("h2", { className: "text-2xl font-bold mb-4 flex items-center gap-2 text-slate-300" }, React.createElement(ResearchIcon, { className: "w-6 h-6 text-yellow-300" }), "Research Tree"),
        React.createElement("div", { className: "space-y-3" }, research.map(res => React.createElement(ResearchItem, { key: res.id, research: res, allResearch: research, prestigePoints: prestigePoints, onBuy: onBuyResearch, researchCostReduction: researchCostReduction, numberFormat: numberFormat }))),
        
        areAnyHumansUnlocked && React.createElement("div", {className: "mt-12"},
            React.createElement("h2", { className: "text-2xl font-bold mb-4 flex items-center gap-2 text-slate-300" }, React.createElement(InfinityIcon, { className: "w-6 h-6 text-purple-300" }), "Infinite Projects"),
            React.createElement("div", { className: "space-y-3" }, infiniteProjects.map(proj => React.createElement(InfiniteProjectItem, { key: proj.id, project: proj, onBuy: onBuyInfiniteProject, atoms: atoms, numberFormat: numberFormat })))
        )
    );
};

const SubjectItem = ({ subject, onBuy, gameState, buyAmount, lifeProductionMultiplier, isAutomationUnlocked, isAutomated, onToggleAutomation, numberFormat }) => {
  let currentResourceAmount;
  let resourceIcon = null;
  if (subject.costResource === 'atoms') {
    currentResourceAmount = gameState.atoms;
    resourceIcon = React.createElement(AtomIcon, { className: "w-5 h-5" });
  } else if (subject.costResource === 'lives') {
    currentResourceAmount = gameState.lives;
    resourceIcon = React.createElement(LifeIcon, { className: "w-5 h-5" });
  } else {
    currentResourceAmount = gameState.prestigePoints;
    resourceIcon = React.createElement(PrestigeIcon, { className: "w-5 h-5" });
  }

  const amountToBuy = useMemo(() => {
    if (buyAmount === 'MAX') return calculateMaxAffordable(subject, currentResourceAmount);
    return buyAmount;
  }, [buyAmount, subject, currentResourceAmount]);

  const totalCost = useMemo(() => calculatePurchaseCost(subject, amountToBuy), [subject, amountToBuy]);

  const displayCost = useMemo(() => {
      if (buyAmount === 'MAX' && amountToBuy === 0) return calculatePurchaseCost(subject, 1);
      return totalCost;
  }, [buyAmount, amountToBuy, totalCost, subject]);

  const canAfford = currentResourceAmount.gte(totalCost) && amountToBuy > 0;

  let buttonClass = 'bg-slate-600 cursor-not-allowed';
  if (canAfford) {
    if (subject.costResource === 'atoms') buttonClass = 'bg-cyan-500 hover:bg-cyan-400';
    else if (subject.costResource === 'lives') buttonClass = 'bg-red-500 hover:bg-red-400';
    else buttonClass = 'bg-yellow-500 hover:bg-yellow-400';
  }

  const buttonText = buyAmount === 'MAX' ? `Buy Max (${formatNumber(amountToBuy > 0 ? amountToBuy : 0, numberFormat)})` : `Buy x${buyAmount}`;

  const effectiveLifeProductionPerSubject = new D(subject.baseLifeProduction).mul(lifeProductionMultiplier);
  const totalLifeProductionFromSubject = effectiveLifeProductionPerSubject.mul(subject.count);

  return React.createElement("div", { className: `bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 hover:border-purple-500`},
      React.createElement("div", { className: "flex-shrink-0" }, subject.icon),
      React.createElement("div", { className: "flex-grow" },
        React.createElement("div", { className: "flex justify-between items-baseline" },
            React.createElement("h3", { className: "text-lg font-bold text-white flex items-center gap-2" },
                subject.name,
                isAutomationUnlocked && React.createElement("button", {
                    title: "Toggle Automation",
                    onClick: () => onToggleAutomation(subject.id),
                    className: `w-10 h-6 rounded-full p-1 flex items-center transition-colors duration-300 ml-2 ${isAutomated ? 'bg-green-500 justify-end' : 'bg-slate-600 justify-start'}`
                },
                    React.createElement("span", { className: "block w-4 h-4 bg-white rounded-full" })
                )
            ),
            subject.count > 0 && React.createElement("span", { className: "text-2xl font-bold text-slate-300" }, formatNumber(subject.count, numberFormat))
        ),
        React.createElement("p", { className: "text-sm text-slate-400" }, subject.description),
        React.createElement("p", { className: "text-sm text-purple-400" }, "+", formatNumber(effectiveLifeProductionPerSubject, numberFormat), " Lives/s each (Total: ", formatNumber(totalLifeProductionFromSubject, numberFormat), " Lives/s)")
      ),
      React.createElement("button", { onClick: () => onBuy(subject.id, amountToBuy), disabled: !canAfford, className: `w-40 flex-shrink-0 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${buttonClass}`},
        React.createElement("div", { className: 'flex flex-col items-center' },
            React.createElement("span", null, buttonText),
            React.createElement("div", { className: "flex items-center justify-center gap-1 font-mono" }, resourceIcon, React.createElement("span", null, formatNumber(displayCost, numberFormat)))
        )
      )
    );
};

const HumanAscension = ({ lives, onAscend, unlockRequirement, humansTotal, mindBonuses, numberFormat }) => {
  const canAscendCheck = lives.gte(unlockRequirement);

  const humansOnReset = useMemo(() => {
    if (!canAscendCheck) return 0;
    const item = {
        baseCost: HUMANS_UNLOCK_REQUIREMENT,
        costIncreaseFactor: HUMAN_COST_INCREASE_FACTOR,
        count: humansTotal ?? 0
    };
    const effectiveLives = lives.mul(mindBonuses.humanGain);
    return calculateMaxAffordable(item, effectiveLives);
  }, [lives, humansTotal, unlockRequirement, mindBonuses.humanGain, canAscendCheck]);

  const costOfNextHuman = useMemo(() => {
    const item = {
        baseCost: HUMANS_UNLOCK_REQUIREMENT,
        costIncreaseFactor: HUMAN_COST_INCREASE_FACTOR,
        count: humansTotal ?? 0
    };
    const baseCost = calculatePurchaseCost(item, 1);
    return baseCost.div(mindBonuses.humanGain); 
    }, [humansTotal, mindBonuses.humanGain]);
  
  const canAscend = canAscendCheck && humansOnReset > 0;

  return React.createElement("div", { className: "mt-8" },
      React.createElement("h2", { className: "text-2xl font-bold mb-4 flex items-center gap-2 text-slate-300" }, React.createElement(HumanIcon, { className: "w-6 h-6 text-green-300" }), "Human Ascension"),
      React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex flex-col md:flex-row items-center justify-between gap-4" },
        React.createElement("div", null,
          React.createElement("p", { className: "text-slate-300" }, "Reach ", formatNumber(unlockRequirement, numberFormat), " Lives to ascend and create Humans."),
          React.createElement("p", { className: "text-slate-400 text-sm" }, "Ascending will reset ALL prior progress (including Prestige Points and Research). The only thing you keep and gain are Humans."),
          React.createElement("p", { className: "text-xs text-slate-500 mt-1" }, "Humans can be assigned to Generators to provide a powerful production boost."),
          React.createElement("p", { className: "text-sm text-green-400 mt-2 font-semibold" }, "Next Human Cost: ", React.createElement("span", {className: "font-mono"}, formatNumber(costOfNextHuman, numberFormat), " Lives"))
        ),
        React.createElement("button", { onClick: () => onAscend(humansOnReset), disabled: !canAscend, className: `px-6 py-3 font-bold rounded-lg transition-all duration-200 text-slate-900 ${ canAscend ? 'bg-green-400 hover:bg-green-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed' }`},
          React.createElement("div", null, "Ascend for +", formatNumber(humansOnReset, numberFormat), " Humans"),
          React.createElement("div", { className: "text-xs font-normal" }, "Requires ", formatNumber(unlockRequirement, numberFormat), " Lives")
        )
      )
    );
};


const Subjects = ({ subjects, gameState, onBuySubject, onAscend, buyAmount, setBuyAmount, lifeProductionMultiplier, lifeTechnologies, onBuyLifeTechnology, lifeTechBuyAmount, setLifeTechBuyAmount, setGameState, mindBonuses, numberFormat }) => {
    const [subjectSubTab, setSubjectSubTab] = useState('subjects');

    return React.createElement("div", { className: "mt-4" },
        React.createElement("div", { className: "text-center mb-6" },
            React.createElement("h2", { className: "text-3xl font-bold mb-2 flex items-center justify-center gap-3 text-slate-300" }, React.createElement(SubjectIcon, { className: "w-8 h-8 text-purple-300" }), "Subjects"),
            React.createElement("p", { className: "text-slate-400 max-w-2xl mx-auto" }, "Subjects are entities that generate Lives, a resource that drastically boosts your atom production. Acquiring the first one is an irreversible step.")
        ),
        React.createElement("div", { className: "mb-6 flex justify-center border-b border-slate-700" },
            React.createElement("button", { onClick: () => setSubjectSubTab('subjects'), className: `px-6 py-2 text-lg font-semibold border-b-2 transition-colors ${subjectSubTab === 'subjects' ? 'border-purple-400 text-purple-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Subjects"),
            React.createElement("button", { onClick: () => setSubjectSubTab('technologies'), className: `px-6 py-2 text-lg font-semibold border-b-2 transition-colors ${subjectSubTab === 'technologies' ? 'border-red-400 text-red-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Life Technologies")
        ),

        subjectSubTab === 'subjects' && React.createElement(React.Fragment, null,
            React.createElement("div", { className: "flex justify-center items-center mb-4" },
                React.createElement("span", { className: "text-slate-400 mr-2 text-sm" }, "Buy:"),
                [1, 5, 10, 50, 'MAX'].map((amount) => React.createElement("button", { key: amount.toString(), onClick: () => setBuyAmount(amount), className: `w-12 px-3 py-1 text-sm font-bold rounded-md ml-1 transition-colors ${buyAmount === amount ? 'bg-purple-500 text-slate-900' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}` }, amount))
            ),
            React.createElement("div", { className: "space-y-4 max-w-4xl mx-auto" }, subjects.map(sub => {
                const isAutomationUnlocked = gameState.research.find(r => r.id === 'res16')?.isPurchased;
                const isAutomated = !!gameState.subjectAutomations?.[sub.id];
                const onToggleAutomation = (subjectId) => setGameState(prev => ({
                    ...prev,
                    subjectAutomations: { ...prev.subjectAutomations, [subjectId]: !prev.subjectAutomations?.[subjectId] }
                }));

                return React.createElement(SubjectItem, { 
                    key: sub.id, 
                    subject: sub, 
                    gameState: gameState, 
                    onBuy: onBuySubject, 
                    buyAmount: buyAmount, 
                    lifeProductionMultiplier: lifeProductionMultiplier, 
                    isAutomationUnlocked,
                    isAutomated,
                    onToggleAutomation,
                    numberFormat: numberFormat 
                });
            })),            
                gameState.humansUnlocked && React.createElement(HumanAscension, { 
                lives: gameState.lives, 
                onAscend: onAscend, 
                unlockRequirement: HUMANS_UNLOCK_REQUIREMENT,
                humansTotal: gameState.humans.total,
                mindBonuses,
                numberFormat: numberFormat
            })
        ),
        
        subjectSubTab === 'technologies' && React.createElement(React.Fragment, null,
            React.createElement("div", { className: "flex justify-center items-center mb-4" },
                React.createElement("span", { className: "text-slate-400 mr-2 text-sm" }, "Buy:"),
                [1, 5, 10, 50, 'MAX'].map((amount) => React.createElement("button", { key: amount.toString(), onClick: () => setLifeTechBuyAmount(amount), className: `w-12 px-3 py-1 text-sm font-bold rounded-md ml-1 transition-colors ${lifeTechBuyAmount === amount ? 'bg-red-500 text-slate-900' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}` }, amount))
            ),
            React.createElement("div", { className: "space-y-4 max-w-4xl mx-auto" },
                React.createElement("h3", { className: "text-xl font-bold mb-4 text-slate-300" }, "Life Technologies"),
                lifeTechnologies.map(tech => React.createElement(LifeTechnologyItem, { key: tech.id, technology: tech, onBuy: onBuyLifeTechnology, lives: gameState.lives, buyAmount: lifeTechBuyAmount, numberFormat: numberFormat }))
            )
        )
    );
};

const HumanSkillItem = ({ skill, onBuy, skillPoints, numberFormat }) => {
    const cost = new D(skill.baseCost).mul(new D(skill.costIncreaseFactor).pow(skill.level));
    const canAfford = skillPoints.gte(cost);
    const isMaxLevel = skill.maxLevel && skill.level >= skill.maxLevel;

    return React.createElement("div", { className: `bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 ${isMaxLevel ? 'border-green-500' : 'hover:border-pink-500'}` },
        React.createElement("div", { className: "flex-shrink-0" }, skill.icon),
        React.createElement("div", { className: "flex-grow" },
            React.createElement("h3", { className: "text-lg font-bold text-white" }, skill.name),
            React.createElement("p", { className: "text-sm text-slate-400" }, skill.description),
            skill.maxLevel ? 
                React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(skill.level, numberFormat), " / ", skill.maxLevel) :
                React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(skill.level, numberFormat))
        ),
        React.createElement("button", {
            onClick: () => onBuy(skill.id),
            disabled: !canAfford || isMaxLevel,
            className: `w-40 flex-shrink-0 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${isMaxLevel ? 'bg-green-600 cursor-not-allowed' : canAfford ? 'bg-pink-400 hover:bg-pink-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed'}`
        },
            isMaxLevel ? "MAX" : "Upgrade",
            !isMaxLevel && React.createElement(React.Fragment, null, React.createElement("br"), React.createElement("span", { className: "font-mono" }, formatNumber(cost, numberFormat), " SP"))
        )
    );
};

const BulkAssignButton = React.memo(({ text, amount, disabled, genId, onClick }) => {
    const isDisabled = disabled || amount === 0;
    return React.createElement("button", { onClick: () => onClick(genId, amount), disabled: isDisabled, className: `px-2 py-1 text-xs font-bold rounded-md bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed transition-colors` }, text);
});

const HumansTab = ({ gameState, onAssignHuman, onBuySkill, humanBonusPerHuman, numberFormat }) => {
    const [humanSubTab, setHumanSubTab] = useState('assign');
    const assignedHumansCount = Object.values(gameState.humans.assigned || {}).reduce((sum, count) => sum + count, 0);
    const availableHumans = gameState.humans.total - assignedHumansCount;

    return React.createElement("div", { className: "mt-4" },
        React.createElement("div", { className: "text-center mb-6" },
            React.createElement("h2", { className: "text-3xl font-bold mb-2 flex items-center justify-center gap-3 text-slate-300" }, React.createElement(HumanIcon, { className: "w-8 h-8 text-green-300" }), "Humans"),
            React.createElement("p", { className: "text-slate-400 max-w-2xl mx-auto" }, "Assign Humans to boost production and spend Skill Points on powerful permanent upgrades."),
            React.createElement("div", { className: "mt-4 font-mono text-lg flex justify-center gap-6" },
                React.createElement("div", null, "Available: ", React.createElement("span", { className: "text-green-400" }, formatNumber(availableHumans, numberFormat))),
                React.createElement("div", null, "Total: ", React.createElement("span", { className: "text-slate-300" }, formatNumber(gameState.humans.total, numberFormat))),
                React.createElement("div", null, "Skill Points: ", React.createElement("span", { className: "text-pink-400" }, formatNumber(gameState.skillPoints, numberFormat)))
            )
        ),
        React.createElement("div", { className: "mb-6 flex justify-center border-b border-slate-700" },
            React.createElement("button", { onClick: () => setHumanSubTab('assign'), className: `px-6 py-2 text-lg font-semibold border-b-2 transition-colors ${humanSubTab === 'assign' ? 'border-green-400 text-green-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Assign"),
            React.createElement("button", { onClick: () => setHumanSubTab('skills'), className: `px-6 py-2 text-lg font-semibold border-b-2 transition-colors ${humanSubTab === 'skills' ? 'border-pink-400 text-pink-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Skills")
        ),
        humanSubTab === 'assign' && React.createElement("div", { className: "space-y-4 max-w-4xl mx-auto" },
            gameState.generators.map(gen => {
                const assignedCount = (gameState.humans.assigned || {})[gen.id] || 0;
                const bonus = assignedCount * humanBonusPerHuman * 100;
                return React.createElement("div", { key: gen.id, className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4" },
                    React.createElement("div", { className: "flex-shrink-0" }, gen.icon),
                    React.createElement("div", { className: "flex-grow text-center sm:text-left" },
                        React.createElement("h3", { className: "text-lg font-bold text-white" }, gen.name),
                        React.createElement("p", { className: "text-sm text-slate-400" }, "Current Bonus: ", React.createElement("span", { className: "font-bold text-green-400" }, "+", formatNumber(bonus, numberFormat), "%"))
                    ),
                    React.createElement("div", { className: "flex items-center gap-1 flex-wrap justify-center" },
                        React.createElement(BulkAssignButton, { text: "-All", genId: gen.id, amount: -assignedCount, disabled: assignedCount === 0, onClick: onAssignHuman }),
                        React.createElement(BulkAssignButton, { text: "-10%", genId: gen.id, amount: -Math.max(1, Math.floor(assignedCount * 0.1)), disabled: assignedCount === 0, onClick: onAssignHuman }),
                        React.createElement("button", { onClick: () => onAssignHuman(gen.id, -1), disabled: assignedCount === 0, className: "w-8 h-8 font-bold text-lg rounded-md bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed transition-colors" }, "-"),
                        React.createElement("span", { className: "w-20 text-center text-xl font-bold" }, formatNumber(assignedCount, numberFormat)),
                        React.createElement("button", { onClick: () => onAssignHuman(gen.id, 1), disabled: availableHumans <= 0, className: "w-8 h-8 font-bold text-lg rounded-md bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed transition-colors" }, "+"),
                        React.createElement(BulkAssignButton, { text: "+10%", genId: gen.id, amount: Math.max(1, Math.floor(availableHumans * 0.1)), disabled: availableHumans <= 0, onClick: onAssignHuman }),
                        React.createElement(BulkAssignButton, { text: "+All", genId: gen.id, amount: availableHumans, disabled: availableHumans <= 0, onClick: onAssignHuman })
                    )
                )
            })
        ),
        humanSubTab === 'skills' && React.createElement("div", { className: "space-y-4 max-w-4xl mx-auto" },
            gameState.humanSkills.map(skill => React.createElement(HumanSkillItem, { key: skill.id, skill: skill, onBuy: onBuySkill, skillPoints: gameState.skillPoints, numberFormat: numberFormat }))
        )
    );
};

const PrestigeSkillItem = ({ skill, onBuy, prestigePoints, buyAmount, numberFormat }) => {
    const isAlreadyMaxLevel = skill.maxLevel !== undefined && skill.level >= skill.maxLevel;
    const amountToBuy = useMemo(() => {
      if (isAlreadyMaxLevel) return 0;
      let desiredAmount = buyAmount === 'MAX' ? calculateMaxAffordable({ ...skill, count: skill.level }, prestigePoints) : buyAmount;
      if (skill.maxLevel !== undefined) return Math.min(desiredAmount, skill.maxLevel - skill.level);
      return desiredAmount;
    }, [buyAmount, skill, prestigePoints, isAlreadyMaxLevel]);
  
    const cost = useMemo(() => {
      if (amountToBuy <= 0) return new D(0);
      return calculatePurchaseCost({ ...skill, count: skill.level }, amountToBuy);
    }, [skill, amountToBuy]);
  
    const displayCost = useMemo(() => {
        if (buyAmount === 'MAX' && amountToBuy === 0 && !isAlreadyMaxLevel) return calculatePurchaseCost({ ...skill, count: skill.level }, 1);
        return cost;
    }, [buyAmount, amountToBuy, cost, skill, isAlreadyMaxLevel]);

    const canAfford = prestigePoints.gte(cost) && amountToBuy > 0;
    const isMaxed = skill.maxLevel && skill.level >= skill.maxLevel;

    return React.createElement("div", { className: `bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 ${isMaxed ? 'border-green-500' : 'hover:border-yellow-500'}` },
        React.createElement("div", { className: "flex-shrink-0" }, skill.icon),
        React.createElement("div", { className: "flex-grow" },
            React.createElement("h3", { className: "text-lg font-bold text-white" }, skill.name),
            React.createElement("p", { className: "text-sm text-slate-400" }, skill.description),
            skill.maxLevel ? 
                React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(skill.level, numberFormat), " / ", skill.maxLevel) :
                React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(skill.level, numberFormat))
        ),
        React.createElement("button", {
            onClick: () => onBuy(skill.id, amountToBuy),
            disabled: !canAfford || isMaxed,
            className: `w-40 flex-shrink-0 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${isMaxed ? 'bg-green-600 cursor-not-allowed' : canAfford ? 'bg-yellow-400 hover:bg-yellow-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed'}`
        },
            isMaxed ? "MAX" : (amountToBuy > 1 ? `Upgrade x${formatNumber(amountToBuy, numberFormat)}` : "Upgrade"),
            !isMaxed && React.createElement(React.Fragment, null, React.createElement("br"), React.createElement("span", { className: "font-mono" }, formatNumber(displayCost, numberFormat), " PP"))
        )
    );
};

const PrestigeTab = ({ gameState, onPrestige, onBuyPrestigeSkill, prestigeSkillBuyAmount, setPrestigeSkillBuyAmount, prestigeSkillBonus, galacticBonuses, numberFormat, prestigeSkills }) => {
    return React.createElement('div', { className: 'max-w-4xl mx-auto' },
        React.createElement(PrestigeDisplay, { 
            atoms: gameState.atoms, 
            prestigePoints: gameState.prestigePoints, 
            onPrestige: onPrestige, 
            prestigeRequirement: PRESTIGE_REQUIREMENT, 
            research: gameState.research, 
            prestigeSkillBonus: prestigeSkillBonus,
            galacticBonus: galacticBonuses.prestigeMultiplier,
            galacticBonus: galacticBonuses.prestigeMultiplier,
            numberFormat: numberFormat
        }),
        React.createElement('div', { className: 'mt-8' },
            React.createElement('h2', { className: 'text-2xl font-bold mb-4 flex items-center gap-2 text-slate-300' }, 
                React.createElement(UpgradeIcon, { className: 'w-6 h-6 text-yellow-300' }), 
                'Prestige Skills'
            ),
             React.createElement("div", { className: "flex justify-center items-center mb-4" },
                React.createElement("span", { className: "text-slate-400 mr-2 text-sm" }, "Buy:"),
                [1, 5, 10, 50, 'MAX'].map((amount) => React.createElement("button", { key: amount.toString(), onClick: () => setPrestigeSkillBuyAmount(amount), className: `w-12 px-3 py-1 text-sm font-bold rounded-md ml-1 transition-colors ${prestigeSkillBuyAmount === amount ? 'bg-yellow-500 text-slate-900' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}` }, amount))
            ),
            React.createElement('div', { className: 'space-y-3' }, 
                prestigeSkills.map(skill => React.createElement(PrestigeSkillItem, { 
                    key: skill.id, 
                    skill: skill, 
                    onBuy: onBuyPrestigeSkill, 
                    prestigePoints: gameState.prestigePoints,
                    buyAmount: prestigeSkillBuyAmount,
                    numberFormat: numberFormat
                }))
            )
        )
    );
};


const LifeTechnologyItem = ({ technology, onBuy, lives, buyAmount, numberFormat }) => {
    const isAlreadyMaxLevel = technology.maxLevel !== undefined && technology.level >= technology.maxLevel;
    const amountToBuy = useMemo(() => {
      if (isAlreadyMaxLevel) return 0;
      let desiredAmount = buyAmount === 'MAX' ? calculateMaxAffordable({ ...technology, count: technology.level }, lives) : buyAmount;
      if (technology.maxLevel !== undefined) return Math.min(desiredAmount, technology.maxLevel - technology.level);
      return desiredAmount;
    }, [buyAmount, technology, lives, isAlreadyMaxLevel]);
  
    const cost = useMemo(() => {
      if (amountToBuy <= 0) return new D(0);
      return calculatePurchaseCost({ ...technology, count: technology.level }, amountToBuy);
    }, [technology, amountToBuy]);
  
    const displayCost = useMemo(() => {
        if (buyAmount === 'MAX' && amountToBuy === 0 && !isAlreadyMaxLevel) return calculatePurchaseCost({ ...technology, count: technology.level }, 1);
        return cost;
    }, [buyAmount, amountToBuy, cost, technology, isAlreadyMaxLevel]);

    const canAfford = lives.gte(cost) && amountToBuy > 0;
    const isMaxed = technology.maxLevel && technology.level >= technology.maxLevel;

    return React.createElement("div", { className: `bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 ${isMaxed ? 'border-green-500' : 'hover:border-red-500'}` },
        React.createElement("div", { className: "flex-shrink-0" }, technology.icon),
        React.createElement("div", { className: "flex-grow" },
            React.createElement("h3", { className: "text-lg font-bold text-white" }, technology.name),
            React.createElement("p", { className: "text-sm text-slate-400" }, technology.description),
            technology.maxLevel ? 
                React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(technology.level, numberFormat), " / ", technology.maxLevel) :
                React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(technology.level, numberFormat))
        ),
        React.createElement("button", {
            onClick: () => onBuy(technology.id, amountToBuy),
            disabled: !canAfford || isMaxed,
            className: `w-40 flex-shrink-0 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${isMaxed ? 'bg-green-600 cursor-not-allowed' : canAfford ? 'bg-red-400 hover:bg-red-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed'}`
        },
            isMaxed ? "MAX" : (amountToBuy > 1 ? `Upgrade x${formatNumber(amountToBuy, numberFormat)}` : "Upgrade"),
            !isMaxed && React.createElement(React.Fragment, null, React.createElement("br"), React.createElement("span", { className: "font-mono" }, formatNumber(displayCost, numberFormat), " Lives"))
        )
    );
};

const SuperHumanSkillItem = ({ skill, onBuy, artificialIngenuity, numberFormat }) => {
    const cost = new D(skill.baseCost).mul(new D(skill.costIncreaseFactor).pow(skill.level));
    const canAfford = artificialIngenuity.gte(cost);
    const isMaxLevel = skill.maxLevel && skill.level >= skill.maxLevel;

    return React.createElement("div", { className: `bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center space-x-4 transition-all duration-300 ${isMaxLevel ? 'border-green-500' : 'hover:border-sky-500'}` },
        React.createElement("div", { className: "flex-shrink-0" }, skill.icon),
        React.createElement("div", { className: "flex-grow" },
            React.createElement("h3", { className: "text-lg font-bold text-white" }, skill.name),
            React.createElement("p", { className: "text-sm text-slate-400" }, skill.description),
            skill.maxLevel ? 
                React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(skill.level, numberFormat), " / ", skill.maxLevel) :
                React.createElement("p", { className: "text-xs text-slate-500" }, "Level: ", formatNumber(skill.level, numberFormat))
        ),
        React.createElement("button", {
            onClick: () => onBuy(skill.id),
            disabled: !canAfford || isMaxLevel,
            className: `w-40 flex-shrink-0 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${isMaxLevel ? 'bg-green-600 cursor-not-allowed' : canAfford ? 'bg-sky-400 hover:bg-sky-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed'}`
        },
            isMaxLevel ? "MAX" : "Upgrade",
            !isMaxLevel && React.createElement(React.Fragment, null, React.createElement("br"), React.createElement("span", { className: "font-mono" }, formatNumber(cost, numberFormat), " AI"))
        )
    );
};

const SuperHumansTab = ({ gameState, onAscend, onBuySkill, onAssignSuperHuman, mindBonuses, galacticBonuses, numberFormat }) => {
    const [superHumanSubTab, setSuperHumanSubTab] = useState('ascension'); 
    
    const superHumansOnAscension = useMemo(() => {
        const effectiveHumans = new D(gameState.humans.total).mul(mindBonuses.superHumanGain).mul(galacticBonuses.superHumanGainMultiplier);
        const item = {
            baseCost: SUPER_HUMAN_UNLOCK_REQUIREMENT,
            costIncreaseFactor: SUPER_HUMAN_COST_INCREASE_FACTOR,
            count: gameState.superHumans
        };
        return calculateMaxAffordable(item, effectiveHumans);
    }, [gameState.humans.total, gameState.superHumans, mindBonuses.superHumanGain, galacticBonuses.superHumanGainMultiplier]);

    const costOfNextSuperHuman = useMemo(() => {
        const item = {
            baseCost: SUPER_HUMAN_UNLOCK_REQUIREMENT,
            costIncreaseFactor: SUPER_HUMAN_COST_INCREASE_FACTOR,
            count: gameState.superHumans
        };
        const baseCost = calculatePurchaseCost(item, 1);
        return baseCost.div(mindBonuses.superHumanGain).div(galacticBonuses.superHumanGainMultiplier);
    }, [gameState.superHumans, mindBonuses.superHumanGain, galacticBonuses.superHumanGainMultiplier]);

    const canAscend = superHumansOnAscension > 0;

    return React.createElement("div", { className: "mt-4" },
        React.createElement("div", { className: "mb-6 flex justify-center border-b border-slate-700" },
            React.createElement("button", { onClick: () => setSuperHumanSubTab('ascension'), className: `px-6 py-2 text-lg font-semibold border-b-2 transition-colors ${superHumanSubTab === 'ascension' ? 'border-sky-400 text-sky-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Ascension"),
            React.createElement("button", { onClick: () => setSuperHumanSubTab('skills'), className: `px-6 py-2 text-lg font-semibold border-b-2 transition-colors ${superHumanSubTab === 'skills' ? 'border-purple-400 text-purple-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Skills")
        ),
        
        superHumanSubTab === 'ascension' && React.createElement(React.Fragment, null,
            React.createElement("div", { className: "mb-8" }, 
                React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex flex-col md:flex-row items-center justify-between gap-4 max-w-4xl mx-auto" },
                    React.createElement("div", null,
                        React.createElement("p", { className: "text-slate-300 text-lg font-bold" }, "Ascend to a new state of being."),
                        React.createElement("p", { className: "text-slate-400 text-sm" }, "This will reset EVERYTHING except for Super Humans and their skills."),
                    ),
                    React.createElement("button", { onClick: () => onAscend(superHumansOnAscension), disabled: !canAscend, className: `px-6 py-3 font-bold rounded-lg transition-all duration-200 text-slate-900 ${ canAscend ? 'bg-sky-400 hover:bg-sky-300 active:scale-95' : 'bg-slate-600 cursor-not-allowed' }`},
                        React.createElement("div", null, "Ascend for +", formatNumber(superHumansOnAscension, numberFormat), " Super Humans"),
                        React.createElement("div", { className: "text-xs font-normal" }, "Next at: ", formatNumber(costOfNextSuperHuman, numberFormat), " Humans")
                    )
                )
            ),
            React.createElement("div", { className: "space-y-4 max-w-4xl mx-auto" },
                React.createElement("h3", { className: "text-xl font-bold mb-2 text-sky-300" }, "Assign Super Humans to Infinite Projects"),
                React.createElement("div", { className: "mb-4 text-sm text-sky-200 bg-slate-800/70 rounded-lg p-3 border border-sky-700" },
                    "Each Super Human assigned increases the Infinite Project bonus by 100%. ",
                    React.createElement("br"),
                    "If at least 1 Super Human is assigned to ",
                    React.createElement("span", { className: "font-bold text-cyan-300" }, "Infinite Atom Drive"),
                    ", atom gain is boosted by 500%. ",
                    React.createElement("br"),
                    "If at least 1 Super Human is assigned to ",
                    React.createElement("span", { className: "font-bold text-purple-300" }, "Endless Knowledge"),
                    ", Skill Point gain is boosted by 500%."
                ),
                INFINITE_PROJECTS.map(proj => {
                    const assignedCount = (gameState.superHumansAssigned || {})[proj.id] || 0;
                    const totalAssignedCount = Object.values(gameState.superHumansAssigned || {}).reduce((sum, c) => sum + c, 0);
                    const available = gameState.superHumans - totalAssignedCount;
                    return React.createElement("div", { key: proj.id, className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-2" },
                        React.createElement("div", { className: "flex-shrink-0" }, proj.icon),
                        React.createElement("div", { className: "flex-grow text-center sm:text-left" },
                            React.createElement("h3", { className: "text-lg font-bold text-white" }, proj.name),
                            React.createElement("p", { className: "text-sm text-slate-400" }, proj.description)
                        ),
                        React.createElement("div", { className: "flex items-center gap-1 flex-wrap justify-center" },
                            React.createElement(BulkAssignButton, { text: "-All", genId: proj.id, amount: -assignedCount, disabled: assignedCount === 0, onClick: onAssignSuperHuman }),
                            React.createElement(BulkAssignButton, { text: "-10%", genId: proj.id, amount: -Math.max(1, Math.floor(assignedCount * 0.1)), disabled: assignedCount === 0, onClick: onAssignSuperHuman }),
                            React.createElement("button", { onClick: () => onAssignSuperHuman(proj.id, -1), disabled: assignedCount === 0, className: "w-8 h-8 font-bold text-lg rounded-md bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed transition-colors" }, "-"),
                            React.createElement("span", { className: "w-20 text-center text-xl font-bold" }, formatNumber(assignedCount, numberFormat)),
                            React.createElement("button", { onClick: () => onAssignSuperHuman(proj.id, 1), disabled: available <= 0, className: "w-8 h-8 font-bold text-lg rounded-md bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed transition-colors" }, "+"),
                            React.createElement(BulkAssignButton, { text: "+10%", genId: proj.id, amount: Math.max(1, Math.floor(available * 0.1)), disabled: available <= 0, onClick: onAssignSuperHuman }),
                            React.createElement(BulkAssignButton, { text: "+All", genId: proj.id, amount: available, disabled: available <= 0, onClick: onAssignSuperHuman })
                        )
                    );
                })
            )
        ),

        superHumanSubTab === 'skills' && React.createElement("div", { className: "space-y-4 max-w-4xl mx-auto" },
            gameState.superHumanSkills.map(skill => React.createElement(SuperHumanSkillItem, { 
                key: skill.id, 
                skill: skill, 
                onBuy: onBuySkill, 
                artificialIngenuity: gameState.artificialIngenuity,
                numberFormat: numberFormat 
            }))
        )
    )};

const GuideTab = ({ numberFormat }) => {
    const guideData = [
        {
            title: 'Prestige',
            icon: React.createElement(PrestigeIcon, { className: "w-8 h-8 text-yellow-300" }),
            requirement: `Requires ${formatNumber(PRESTIGE_REQUIREMENT, numberFormat)} Atoms.`,
            unlocks: 'Unlocks the Prestige and Research tabs, allowing you to earn Prestige Points that permanently boost your production and purchase unique upgrades (softcaps at 1AA PP)'
        },
        {
            title: 'Lives & Subjects',
            icon: React.createElement(LifeIcon, { className: "w-8 h-8 text-red-300" }),
            requirement: `Requires ${formatNumber(SUBJECTS_UNLOCK_REQUIREMENT, numberFormat)} Atoms.`,
            unlocks: 'Unlocks the Subjects tab. Subjects generate Lives, a new resource that provides a massive bonus to atom production.'
        },
        {
            title: 'Humans',
            icon: React.createElement(HumanIcon, { className: "w-8 h-8 text-green-300" }),
            requirement: `Requires ${formatNumber(HUMANS_UNLOCK_REQUIREMENT, numberFormat)} Lives.`,
            unlocks: 'Unlocks the Humans tab and Human Ascension. Sacrifice your progress to gain Humans, which can be assigned to generators or generate Skill Points for permanent upgrades.'
        },
        {
            title: 'Super Humans',
            icon: React.createElement(SuperHumanIcon, { className: "w-8 h-8 text-sky-300" }),
            requirement: `Requires ${formatNumber(SUPER_HUMAN_UNLOCK_REQUIREMENT, numberFormat)} Humans.`,
            unlocks: 'Unlocks the Super Humans tab, the ultimate reset. Sacrifice all your progress (including Humans) to gain Super Humans, who provide immense power and unlock their own skill tree.'
        },
        {
            title: 'The Universe',
            icon: React.createElement(UniverseIcon, { className: "w-8 h-8 text-purple-300" }),
            requirement: `Requires ${formatNumber(POST_SUPER_HUMANS_REQUIREMENT)} Super Humans.`,
            unlocks: 'Unlocks the Universe window, where you unlock 1 generator, 1 upgrade, and Stardust!'
        },
        {
            title: 'The Mind',
            icon: React.createElement(MindIcon, { className: "w-8 h-8 text-indigo-300" }),
            requirement: `Requires ${formatNumber(MIND_UNLOCK_REQUIREMENT)} Super Humans.`,
            unlocks: 'Unlocks the Mind tab, feed the growing consciousness to unlock Super Human and Human discounts and other benefits.'
        },
        {
            title: '??? ??? ?????', // The New Being
            icon: React.createElement(NewBeingIcon, { className: "w-8 h-8 text-pink-300" }),
            requirement: `Requires ### Mind Levels.`,
            unlocks: '.-- .... -.--   -.. ---   -.-- --- ..-   -.- . . .--.   .--. .-.. .- -.-- .. -. --. ..--..'
        }
    ];

    return React.createElement("div", { className: "mt-4 max-w-4xl mx-auto" },
        React.createElement("div", { className: "text-center mb-8" },
            React.createElement("h2", { className: "text-3xl font-bold mb-2 flex items-center justify-center gap-3 text-emerald-400" }, 
                React.createElement(GuideIcon, { className: "w-8 h-8" }), 
                "Progress Guide"
            ),
            React.createElement("p", { className: "text-slate-400" }, "Here you'll find the requirements to unlock the main mechanics and tabs of the game.")
        ),
        React.createElement("div", { className: "space-y-4" },
            guideData.map(item => React.createElement("div", { key: item.title, className: "bg-slate-800/60 p-5 rounded-lg border border-slate-700" },
                React.createElement("div", { className: "flex items-center gap-4 mb-2" },
                    item.icon,
                    React.createElement("h3", { className: "text-2xl font-bold text-slate-100" }, item.title)
                ),
                React.createElement("p", { className: "text-md text-slate-300 font-semibold ml-12" }, item.requirement),
                React.createElement("p", { className: "text-sm text-slate-400 mt-1 ml-12" }, item.unlocks)
            ))
        )
    );
};

const InfusionItem = ({ name, icon, onInfuse, currency, currencyAmount, xpPerUnit, buyAmount, setBuyAmount, numberFormat, colorClass }) => {
    const amountToBuy = useMemo(() => {
        if (buyAmount === 'MAX') {
            return currencyAmount.floor().toNumber();
        }
        return buyAmount;
    }, [buyAmount, currencyAmount]);

    const cost = new D(amountToBuy);
    const xpGained = cost.mul(xpPerUnit);
    const canAfford = currencyAmount.gte(cost) && amountToBuy > 0;

    return React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700" },
        React.createElement("div", { className: "flex flex-col md:flex-row items-center justify-between gap-4" },
            React.createElement("div", { className: "flex items-center gap-3" },
                icon,
                React.createElement("h3", { className: "text-lg font-bold text-white" }, name)
            ),
            React.createElement("div", { className: "flex items-center" },
                React.createElement("span", { className: "text-slate-400 mr-2 text-sm" }, "Infuse:"),
                 [1, 10, 100, 1000, 'MAX'].map((amount) => React.createElement("button", { key: amount.toString(), onClick: () => setBuyAmount(amount), className: `w-14 px-3 py-1 text-sm font-bold rounded-md ml-1 transition-colors ${buyAmount === amount ? `${colorClass} text-slate-900` : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}` }, typeof amount === 'string' ? amount : formatNumber(amount, numberFormat)))
            ),
            React.createElement("button", {
                onClick: () => onInfuse(currency, amountToBuy),
                disabled: !canAfford,
                className: `w-full md:w-48 px-4 py-2 font-bold rounded-lg transition-all duration-200 text-slate-900 ${canAfford ? `${colorClass} hover:opacity-90 active:scale-95` : 'bg-slate-600 cursor-not-allowed'}`
            },
                `Infuse for +${formatNumber(xpGained, numberFormat)} XP | Cost: ${formatNumber(cost, numberFormat)}`
            )
        )
    );
};

const MindTab = ({ gameState, onInfuse, mindBonuses, numberFormat }) => {
    const [infuseAiAmount, setInfuseAiAmount] = useState(1e6);
    const [infuseSpAmount, setInfuseSpAmount] = useState(1e6);

    const { mind } = gameState;
    const xpProgress = mind.xp.div(mind.xpToNextLevel).mul(100).toNumber();

    const getNextBonus = () => {
        const nextLevel = mind.level + 1;
        const type = (nextLevel - 1) % 3;
        if (type === 0) return { text: "+50% Human Discount", color: "text-green-400" };
        if (type === 1) return { text: "+50% Super Human Discount", color: "text-sky-400" };
        return { text: "x1000 Life Production", color: "text-red-400" };
    };
    const nextBonus = getNextBonus();

    return React.createElement("div", { className: "mt-4 max-w-4xl mx-auto" },
        React.createElement("div", { className: "text-center mb-8" },
            React.createElement("h2", { className: "text-3xl font-bold mb-2 flex items-center justify-center gap-3 text-indigo-400" },
                React.createElement(MindIcon, { className: "w-8 h-8" }),
                "The Mind"
            ),
            React.createElement("p", { className: "text-slate-400" }, "Feed the growing consciousness to unlock its potential.")
        ),
        React.createElement("div", { className: "bg-slate-800/60 p-6 rounded-lg border border-slate-700 mb-6" },
            React.createElement("div", { className: "flex justify-between items-baseline mb-2" },
                React.createElement("span", { className: "text-2xl font-bold text-indigo-300" }, `Mind Level: ${mind.level}`),
                React.createElement("span", { className: "text-sm text-slate-400" }, `Next Level Bonus: `, React.createElement("span", { className: `font-bold ${nextBonus.color}`}, nextBonus.text)),
            ),
            React.createElement("div", { className: "w-full bg-slate-700 rounded-full h-6" },
                React.createElement("div", {
                    className: "bg-gradient-to-r from-indigo-500 to-purple-500 h-6 rounded-full text-center text-white text-sm leading-6",
                    style: { width: `${Math.min(100, xpProgress)}%` }
                }, `${formatNumber(mind.xp, numberFormat)} / ${formatNumber(mind.xpToNextLevel, numberFormat)} XP`)
            )
        ),
        React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8" },
             React.createElement("div", { className: "bg-slate-800/60 p-4 rounded-lg border border-slate-700" },
                React.createElement("h3", { className: "text-xl font-bold text-slate-200 mb-3 text-center" }, "Current Bonuses"),
                React.createElement("ul", { className: "space-y-2 text-center" },
                    React.createElement("li", { className: "text-green-400" }, `Human Gain Discount: +${formatNumber(mindBonuses.humanGain.sub(1).mul(100), numberFormat)}%`),
                    React.createElement("li", { className: "text-sky-400" }, `Super Human Gain Discount: +${formatNumber(mindBonuses.superHumanGain.sub(1).mul(100), numberFormat)}%`),
                    React.createElement("li", { className: "text-red-400" }, `Life Production Multiplier: x${formatNumber(mindBonuses.lifeProduction, numberFormat)}`)
                )
            ),
            React.createElement("div", { className: "bg-slate-800/60 p-4 rounded-lg border border-slate-700" },
                 React.createElement("h3", { className: "text-xl font-bold text-slate-200 mb-3 text-center" }, "Infusion Rates"),
                 React.createElement("ul", { className: "space-y-2 text-center" },
                    React.createElement("li", { className: "text-purple-400" }, `1 Artificial Ingenuity = 10 XP`),
                    React.createElement("li", { className: "text-pink-400" }, `1m Skill Points = 10 XP`)
                )
            )
        ),
        React.createElement("div", { className: "space-y-4" },
            React.createElement(InfusionItem, {
                name: "Infuse with Ingenuity",
                icon: React.createElement(BrainIcon, { className: "w-8 h-8 text-purple-400" }),
                onInfuse: onInfuse,
                currency: "ai",
                currencyAmount: gameState.artificialIngenuity,
                xpPerUnit: AI_TO_XP,
                buyAmount: infuseAiAmount,
                setBuyAmount: setInfuseAiAmount,
                numberFormat: numberFormat,
                colorClass: "bg-purple-500"
            }),
            React.createElement(InfusionItem, {
                name: "Infuse with Skills",
                icon: React.createElement(BrainIcon, { className: "w-8 h-8 text-pink-400" }),
                onInfuse: onInfuse,
                currency: "sp",
                currencyAmount: gameState.skillPoints,
                xpPerUnit: SP_TO_XP,
                buyAmount: infuseSpAmount,
                setBuyAmount: setInfuseSpAmount,
                numberFormat: numberFormat,
                colorClass: "bg-pink-500"
            })
        ),
        React.createElement("div", { className: "mt-8" },
            React.createElement("h3", { className: "text-xl font-bold text-slate-200 mb-4 text-center" }, "Mind Milestones"),
            React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                MIND_MILESTONES.map(milestone => {
                    const isUnlocked = mind.level >= milestone.level;
                    return React.createElement("div", { key: milestone.level, className: `p-3 rounded-lg border transition-colors ${isUnlocked ? 'bg-indigo-900/50 border-indigo-500' : 'bg-slate-800/50 border-slate-700'}` },
                        React.createElement("p", { className: `font-bold ${isUnlocked ? 'text-indigo-300' : 'text-slate-400'}` }, "Level ", milestone.level),
                        React.createElement("p", { className: `text-sm ${isUnlocked ? 'text-slate-200' : 'text-slate-500'}` }, milestone.description)
                    );
                })
            )
        )
    );
};

const getInitialGameState = () => ({
  atoms: new D(1),
  prestigePoints: new D(0),  
  generators: INITIAL_GENERATORS.map(g => ({ ...g, count: 0 })),
  upgrades: INITIAL_UPGRADES.map(u => ({ ...u, level: 0 })),
  research: RESEARCH_TREE.map(r => ({ ...r, dependencies: [...r.dependencies], isPurchased: false })),
  lives: new D(0),
  subjects: INITIAL_SUBJECTS.map(s => ({ ...s, count: 0 })),
  subjectsUnlocked: false,
  humans: { total: 0, assigned: {} },
  humansUnlocked: false,
  skillPoints: new D(0),
  humanSkills: HUMAN_SKILLS.map(s => ({...s, level: 0})),
  infiniteProjects: INFINITE_PROJECTS.map(p => ({...p, level: 0})),
  prestigeSkills: INITIAL_PRESTIGE_SKILLS.map(s => ({...s, level: 0})),
  lifeTechnologies: INITIAL_LIFE_TECHNOLOGIES.map(t => ({...t, level: 0})),
  generatorAutomations: {},
  autoBuyUpgrades: false,
  autoBuyLifeTechs: false,
  autoBuyHumanSkills: false,
  autoBuySuperHumanSkills: false,
  autoBuyInfiniteProjects: false,
  subjectsAutomations: {},
  superHumans: 0,
  superHumansAssigned: {},
  artificialIngenuity: new D(0),
  superHumansUnlocked: false,
  superHumanSkills: INITIAL_SUPER_HUMAN_SKILLS.map(s => ({...s, level: 0})),
  maxHistoricalBHC: 0,
  stardust: new D(0),
  stardustAwardedfromBHC: 0,
  universeUnlockedNotified: false,
  planetarySystems: 0,
  galacticPoints: 0,
  universeData: {
      purchasedPlanets: [],
      purchasedMoons: [],
      purchasedUpgrades: [],
      purchasedGalacticUpgrades: [],
      planetarySystemProgress: { stardust: '0', energy: '0' },
      totalEnergy: '0',
      lastClosedTime: '0'
  },
  mind: {
    level: 0,
    xp: new D(0),
    xpToNextLevel: new D(MIND_XP_BASE),
    unlocked: false,
  }
});

const saveGameState = (gameState) => {
    try {
        const stateToSave = {
            ...gameState,
            atoms: gameState.atoms.toString(),
            prestigePoints: gameState.prestigePoints.toString(),
            lives: gameState.lives.toString(),
            skillPoints: gameState.skillPoints.toString(),
            artificialIngenuity: gameState.artificialIngenuity.toString(),
            generators: gameState.generators.map(g => ({ id: g.id, count: g.count })),
            upgrades: gameState.upgrades.map(u => ({ id: u.id, level: u.level })),
            research: gameState.research.map(r => ({ id: r.id, isPurchased: r.isPurchased })),
            subjects: gameState.subjects.map(s => ({ id: s.id, count: s.count })),
            humanSkills: gameState.humanSkills.map(s => ({ id: s.id, level: s.level })),
            infiniteProjects: gameState.infiniteProjects.map(p => ({ id: p.id, level: p.level })),
            prestigeSkills: gameState.prestigeSkills.map(s => ({ id: s.id, level: s.level })),
            lifeTechnologies: gameState.lifeTechnologies.map(t => ({ id: t.id, level: t.level })),
            subjectsAutomations: gameState.subjectsAutomations,
            superHumanSkills: gameState.superHumanSkills.map(s => ({ id: s.id, level: s.level })),
            stardust: gameState.stardust.toString(),
            stardustAwardedfromBHC: gameState.stardustAwardedfromBHC.toString(),
            universeData: {
                ...gameState.universeData,
                totalEnergy: gameState.universeData.totalEnergy.toString(),
                planetarySystemProgress: {
                    stardust: gameState.universeData.planetarySystemProgress.stardust.toString(),
                    energy: gameState.universeData.planetarySystemProgress.energy.toString()
                }
            },
            mind: {
                level: gameState.mind.level,
                xp: gameState.mind.xp.toString(),
                xpToNextLevel: gameState.mind.xpToNextLevel.toString(),
                unlocked: gameState.mind.unlocked
            }
        };
        localStorage.setItem('atomIdleSaveData', JSON.stringify(stateToSave));
    } catch (e) {
        console.error("Failed to save game state:", e);
    }
};

const loadGameState = () => {
    const initialState = getInitialGameState();
    try {
        const unifiedSaveString = localStorage.getItem('atomIdleSaveData');
        if (unifiedSaveString) {
            const savedState = JSON.parse(unifiedSaveString);
            const mergedState = { ...initialState, ...savedState };

            const safeLoadDecimal = (value) => new D(value && value !== "NaN" ? value : '0');

            mergedState.atoms = safeLoadDecimal(savedState.atoms);
            mergedState.prestigePoints = safeLoadDecimal(savedState.prestigePoints);
            mergedState.lives = safeLoadDecimal(savedState.lives);
            mergedState.skillPoints = safeLoadDecimal(savedState.skillPoints);
            mergedState.artificialIngenuity = safeLoadDecimal(savedState.artificialIngenuity);
            
            mergedState.humans = {
                total: Number(savedState.humans?.total) || 0,
                assigned: (typeof savedState.humans?.assigned === 'object' && savedState.humans.assigned) ? savedState.humans.assigned : {}
            };
            mergedState.superHumans = Number(savedState.superHumans) || 0;
            mergedState.superHumansAssigned = (typeof savedState.superHumansAssigned === 'object' && savedState.superHumansAssigned) ? savedState.superHumansAssigned : {};

            mergedState.stardust = safeLoadDecimal(savedState.stardust);
            mergedState.stardustAwardedfromBHC = safeLoadDecimal(savedState.stardustAwardedfromBHC);
            mergedState.planetarySystems = Number(savedState.planetarySystems) || 0;
            mergedState.galacticPoints = Number(savedState.galacticPoints) || 0;


            mergedState.universeData = {
                purchasedPlanets: Array.isArray(savedState.universeData?.purchasedPlanets) ? savedState.universeData.purchasedPlanets : [],
                purchasedMoons: Array.isArray(savedState.universeData?.purchasedMoons) ? savedState.universeData.purchasedMoons : [],
                purchasedUpgrades: Array.isArray(savedState.universeData?.purchasedUpgrades) ? savedState.universeData.purchasedUpgrades : [],
                purchasedGalacticUpgrades: Array.isArray(savedState.universeData?.purchasedGalacticUpgrades) ? savedState.universeData.purchasedGalacticUpgrades : [],
                planetarySystemProgress: {
                    stardust: safeLoadDecimal(savedState.universeData?.planetarySystemProgress?.stardust),
                    energy: safeLoadDecimal(savedState.universeData?.planetarySystemProgress?.energy)
                },
                totalEnergy: (savedState.universeData?.totalEnergy && savedState.universeData.totalEnergy !== "NaN" ? savedState.universeData.totalEnergy : '0'),
                lastClosedTime: savedState.universeData?.lastClosedTime || '0'
            };

            if (savedState.mind) {
                const loadedLevel = savedState.mind.level || 0;
                mergedState.mind = {
                    level: loadedLevel,
                    xp: safeLoadDecimal(savedState.mind.xp),
                    xpToNextLevel: new D(MIND_XP_BASE).mul(new D(MIND_XP_FACTOR).pow(loadedLevel)),
                    unlocked: savedState.mind.unlocked || false,
                };
            } else {
                 mergedState.mind = initialState.mind;
            }
            
            const rehydrateItems = (template, savedItems, field) => {
                if (!Array.isArray(savedItems)) return template.map(item => ({ ...item, [field]: 0 }));
                return template.map(initialItem => {
                    const savedItem = savedItems.find(s => s.id === initialItem.id);
                    return { ...initialItem, [field]: savedItem ? (Number(savedItem[field]) || 0) : 0 };
                });
            };

            mergedState.generators = rehydrateItems(initialState.generators, savedState.generators, 'count');
            mergedState.upgrades = rehydrateItems(initialState.upgrades, savedState.upgrades, 'level');
            mergedState.subjects = rehydrateItems(initialState.subjects, savedState.subjects, 'count');
            mergedState.humanSkills = rehydrateItems(initialState.humanSkills, savedState.humanSkills, 'level');
            mergedState.infiniteProjects = rehydrateItems(initialState.infiniteProjects, savedState.infiniteProjects, 'level');
            mergedState.prestigeSkills = rehydrateItems(initialState.prestigeSkills, savedState.prestigeSkills, 'level');
            mergedState.lifeTechnologies = rehydrateItems(initialState.lifeTechnologies, savedState.lifeTechnologies, 'level');
            mergedState.superHumanSkills = rehydrateItems(initialState.superHumanSkills, savedState.superHumanSkills, 'level');

            mergedState.research = initialState.research.map(r => ({
                ...r,
                isPurchased: !!savedState.research?.find(sr => sr.id === r.id)?.isPurchased
            }));
            
            mergedState.generatorAutomations = typeof savedState.generatorAutomations === 'object' && savedState.generatorAutomations ? savedState.generatorAutomations : {};

            mergedState.subjectAutomations = typeof savedState.subjectAutomations === 'object' && savedState.subjectAutomations ? savedState.subjectAutomations : {};
            return mergedState;
        }

        const mainSaveString = localStorage.getItem('atomIdleGameState');
        if (mainSaveString) {
            console.log("Old save format found. Migrating to new format.");
            const mainSavedState = JSON.parse(mainSaveString);
            const universeData = {
                purchasedPlanets: JSON.parse(localStorage.getItem('purchasedPlanets') || '[]'),
                purchasedMoons: JSON.parse(localStorage.getItem('purchasedMoons') || '[]'),
                purchasedUpgrades: JSON.parse(localStorage.getItem('purchasedUpgrades') || '[]'),
                totalEnergy: localStorage.getItem('totalEnergy') || '0',
                lastClosedTime: localStorage.getItem('universeLastClosedTime') || '0',
            };
            
            const migratedState = { ...initialState, ...mainSavedState, universeData };
            
            saveGameState(migratedState);
            localStorage.removeItem('atomIdleGameState');
            localStorage.removeItem('purchasedPlanets');
            localStorage.removeItem('purchasedMoons');
            localStorage.removeItem('purchasedUpgrades');
            localStorage.removeItem('totalEnergy');
            localStorage.removeItem('universeLastClosedTime');
            
            return loadGameState();
        }

    } catch (e) {
        console.error("Failed to parse saved state, starting new game:", e);
        localStorage.removeItem('atomIdleSaveData');
        localStorage.removeItem('atomIdleGameState');
        return initialState;
    }

    return initialState;
};


const App = () => {
  const [gameState, setGameState] = useState(loadGameState);

  const fileInputRef = useRef(null);
  
  const [buyAmount, setBuyAmount] = useState(1);
  const [upgradeBuyAmount, setUpgradeBuyAmount] = useState(1);
  const [subjectBuyAmount, setSubjectBuyAmount] = useState(1);
  const [prestigeSkillBuyAmount, setPrestigeSkillBuyAmount] = useState(1); 
  const [lifeTechBuyAmount, setLifeTechBuyAmount] = useState(1);
  const [activeTab, setActiveTab] = useState('main');
  const [notifications, setNotifications] = useState([]);
  const [numberFormat, setNumberFormat] = useState(() => localStorage.getItem('numberFormat') || 'standard');
  const [isUniverseVisible, setIsUniverseVisible] = useState(false);
  const [universeMultiplier, setUniverseMultiplier] = useState(1);

  const gameStateRef = useRef(gameState);
  useEffect(() => { gameStateRef.current = gameState; }, [gameState]);

  const lastTickTimeRef = useRef(Date.now());
  useEffect(() => {
    const saveInterval = setInterval(() => {
        saveGameState(gameStateRef.current);

    }, SAVE_INTERVAL_MS);

    return () => clearInterval(saveInterval);
  }, []); 

  useEffect(() => {
    localStorage.setItem('numberFormat', numberFormat);
  }, [numberFormat]);

  const addNotification = useCallback((message) => {
    const newNotification = { id: Date.now() + Math.random(), message };
    setNotifications(prev => [...prev, newNotification]);
  }, []);

  const removeNotification = useCallback((id) => {
    setNotifications(prev => prev.filter(n => n.id !== id));
  }, []);

  const galacticBonuses = useMemo(() => {
    const bonuses = { atomMultiplier: new D(1), prestigeMultiplier: new D(1), universeEnergyMultiplier: new D(1), stardustMultiplier: new D(1), superHumanGainMultiplier: new D(1), lifeMultiplier: new D(1) };
    (gameState.universeData.purchasedGalacticUpgrades || []).forEach(id => {
        const upgrade = GALACTIC_UPGRADES[id];
        if (upgrade) {
            if (upgrade.effect.type === 'atoms') bonuses.atomMultiplier = bonuses.atomMultiplier.mul(upgrade.effect.multiplier);
            if (upgrade.effect.type === 'prestige') bonuses.prestigeMultiplier = bonuses.prestigeMultiplier.mul(upgrade.effect.multiplier);
            if (upgrade.effect.type === 'universe_energy') bonuses.universeEnergyMultiplier = bonuses.universeEnergyMultiplier.mul(upgrade.effect.multiplier);
            if (upgrade.effect.type === 'stardust_generation') bonuses.stardustMultiplier = bonuses.stardustMultiplier.mul(upgrade.effect.multiplier);
            if (upgrade.effect.type === 'super_human_gain') bonuses.superHumanGainMultiplier = bonuses.superHumanGainMultiplier.mul(upgrade.effect.multiplier);
            if (upgrade.effect.type === 'life_production') bonuses.lifeMultiplier = bonuses.lifeMultiplier.mul(upgrade.effect.multiplier);
        }
    });
    return bonuses;
}, [gameState.universeData.purchasedGalacticUpgrades]);

const universeEnergyPerSecond = useMemo(() => {
    const purchasedPlanets = gameState.universeData.purchasedPlanets || [];
    const purchasedUpgrades = gameState.universeData.purchasedUpgrades || [];
    
    let totalEnergyRate = new D(0);
    purchasedPlanets.forEach(planetName => {
        const planetData = UNIVERSE_PLANETS[planetName];
        if (planetData && planetData.energy) {
            totalEnergyRate = totalEnergyRate.add(planetData.energy);
        }
    });

    purchasedUpgrades.forEach(upgradeName => {
        const upgradeData = UNIVERSE_UPGRADES[upgradeName];
        if (upgradeData && upgradeData.effect === 'energy') {
            totalEnergyRate = totalEnergyRate.mul(upgradeData.multiplier);
        }
    });

    return totalEnergyRate.mul(galacticBonuses.universeEnergyMultiplier);
}, [gameState.universeData.purchasedPlanets, gameState.universeData.purchasedUpgrades, galacticBonuses.universeEnergyMultiplier]);

  useEffect(() => {
    
  }, [isUniverseVisible]);

const handleBuyUniverseItem = useCallback((itemType, itemName) => {
    setGameState(prev => {
        const itemDataSources = { planet: UNIVERSE_PLANETS, moon: UNIVERSE_MOONS, upgrade: UNIVERSE_UPGRADES };
        const itemData = itemDataSources[itemType]?.[itemName];
        if (!itemData) return prev;

        const currentUniverseData = { ...prev.universeData };
        const cost = calculatePurchaseCost({ ...itemData, count: 0 }, 1);
        let resourcePool, isPurchased;
        
        if (itemType === 'planet') {
            resourcePool = prev.stardust;
            isPurchased = (currentUniverseData.purchasedPlanets || []).includes(itemName);
        } else {
            resourcePool = new D(currentUniverseData.totalEnergy || '0');
            isPurchased = (currentUniverseData.purchasedMoons || []).includes(itemName) || (currentUniverseData.purchasedUpgrades || []).includes(itemName);
        }

        if (!resourcePool.gte(cost) || isPurchased) return prev;

        const newState = { ...prev };
        if (itemType === 'planet') {
            newState.stardust = Decimal.max(prev.stardust.sub(cost), 0);
            currentUniverseData.purchasedPlanets = [...(currentUniverseData.purchasedPlanets || []), itemName];
        } else {
            currentUniverseData.totalEnergy = Decimal.max(new D(currentUniverseData.totalEnergy || '0').sub(cost), 0).toString();
            if (itemType === 'moon') {
                currentUniverseData.purchasedMoons = [...(currentUniverseData.purchasedMoons || []), itemName];
            } else if (itemType === 'upgrade') {
                currentUniverseData.purchasedUpgrades = [...(currentUniverseData.purchasedUpgrades || []), itemName];
            }
        }
        
        newState.universeData = currentUniverseData;
        return newState;
    });
  }, []);

  const handleInvestInPlanetarySystem = useCallback((resourceType) => {
    setGameState(prev => {
        const systemIndex = prev.planetarySystems;
        const reqs = {
            stardust: PLANETARY_SYSTEM_REQUIREMENTS.stardustBase.mul(PLANETARY_SYSTEM_REQUIREMENTS.stardustScaling.pow(systemIndex)),
            energy: PLANETARY_SYSTEM_REQUIREMENTS.energyBase.mul(PLANETARY_SYSTEM_REQUIREMENTS.energyScaling.pow(systemIndex)),
        };
        const progress = {
            stardust: new D(prev.universeData.planetarySystemProgress.stardust),
            energy: new D(prev.universeData.planetarySystemProgress.energy)
        };
        
        let amountToInvest;
        let needed = reqs[resourceType].sub(progress[resourceType]);
        
        if (resourceType === 'stardust') {
            amountToInvest = D.min(prev.stardust, needed);
        } else {
            amountToInvest = D.min(new D(prev.universeData.totalEnergy), needed);
        }

        if (amountToInvest.lte(0)) return prev;

        const newState = { ...prev };
        const newProgress = { ...progress };

        if (resourceType === 'stardust') {
            newState.stardust = prev.stardust.sub(amountToInvest);
            newProgress.stardust = progress.stardust.add(amountToInvest);
        } else {
            newState.universeData = {...prev.universeData, totalEnergy: new D(prev.universeData.totalEnergy).sub(amountToInvest).toString()};
            newProgress.energy = progress.energy.add(amountToInvest);
        }
        
        newState.universeData.planetarySystemProgress = { stardust: newProgress.stardust.toString(), energy: newProgress.energy.toString() };
        return newState;
    });
  }, []);

  const handleFormPlanetarySystem = useCallback(() => {
    setGameState(prev => {
        const systemIndex = prev.planetarySystems;
        const stellarNurseryReq = PLANETARY_SYSTEM_REQUIREMENTS.stellarNurseryBase + systemIndex * PLANETARY_SYSTEM_REQUIREMENTS.stellarNurseryIncrease;
        const stardustReq = PLANETARY_SYSTEM_REQUIREMENTS.stardustBase.mul(PLANETARY_SYSTEM_REQUIREMENTS.stardustScaling.pow(systemIndex));
        const energyReq = PLANETARY_SYSTEM_REQUIREMENTS.energyBase.mul(PLANETARY_SYSTEM_REQUIREMENTS.energyScaling.pow(systemIndex));

        const stellarNurseryMet = (prev.generators.find(g => g.id === 'gen2')?.count || 0) >= stellarNurseryReq;
        const stardustMet = new D(prev.universeData.planetarySystemProgress.stardust).gte(stardustReq);
        const energyMet = new D(prev.universeData.planetarySystemProgress.energy).gte(energyReq);
        
        if (!stellarNurseryMet || !stardustMet || !energyMet) return prev;
        
        addNotification("Planetary System Formed! +1 Galactic Point!");
        
        return {
            ...prev,
            planetarySystems: prev.planetarySystems + 1,
            galacticPoints: prev.galacticPoints + 1,
            universeData: {
                ...prev.universeData,
                planetarySystemProgress: { stardust: '0', energy: '0' }
            }
        };
    });
  }, [addNotification]);
  
  const handleBuyGalacticUpgrade = useCallback((upgradeId) => {
    setGameState(prev => {
        const upgrade = GALACTIC_UPGRADES[upgradeId];
        if (!upgrade || prev.galacticPoints < upgrade.cost || (prev.universeData.purchasedGalacticUpgrades || []).includes(upgradeId)) {
            return prev;
        }

        return {
            ...prev,
            galacticPoints: prev.galacticPoints - upgrade.cost,
            universeData: {
                ...prev.universeData,
                purchasedGalacticUpgrades: [...(prev.universeData.purchasedGalacticUpgrades || []), upgradeId]
            }
        };
    });
  }, []);


    useEffect(() => {
        const purchasedUpgrades = gameState.universeData?.purchasedUpgrades || [];

        const totalAtomMultiplier = purchasedUpgrades.reduce((total, upgradeName) => {
            const upgradeData = UNIVERSE_UPGRADES[upgradeName];
            
            if (upgradeData && upgradeData.effect === 'atoms') {
                return total * upgradeData.multiplier;
            }
            
            return total;
        }, 1); 

        setUniverseMultiplier(totalAtomMultiplier);
    }, [gameState.universeData?.purchasedUpgrades]);

  const prevResearchRef = useRef(gameState.research);
  useEffect(() => {
    const keyAutomationResearch = {
        res8: 'Generator Automation Unlocked!', res9: 'Automated Upgrades Unlocked!', res10: 'Automated Research Unlocked!',
        res12: 'Life Tech Automation Unlocked!', res13: 'Human Skill Automation Unlocked!', res14: 'Super Human Skill Automation Unlocked!', res15: 'Infinite Project Automation Unlocked!',
    };
    gameState.research.forEach(currentRes => {
        const prevRes = prevResearchRef.current.find(r => r.id === currentRes.id);
        if (prevRes && !prevRes.isPurchased && currentRes.isPurchased) {
            if (keyAutomationResearch[currentRes.id]) {
                addNotification(keyAutomationResearch[currentRes.id]);
            }
        }
    });
    prevResearchRef.current = gameState.research;
  }, [gameState.research, addNotification]);

  const getEffectiveGenerators = useCallback((state) => {
    const hs2Level = state.humanSkills.find(s => s.id === 'hs2')?.level || 0;
    const generatorCostMultiplier = Math.max(0.001, 1 - (hs2Level * 0.05));
    return state.generators.map(g => ({...g, baseCost: new D(INITIAL_GENERATORS.find(ig => ig.id === g.id).baseCost).mul(generatorCostMultiplier)}));
  }, []);

const getEffectiveUpgrades = useCallback((state) => {
    const isHumanConsciousnessScalingUnlocked = state.mind.level >= 50; 
    const isPantheonSymbiosisScalingUnlocked = state.mind.level >= 100;

    return state.upgrades.map(upg => {
        let modifiedUpg = { ...upg };

        if (upg.id === 'upg2' && state.research.find(r => r.id === 'res5')?.isPurchased) {
            const initialMaxLevel = INITIAL_UPGRADES.find(u => u.id === 'upg2')?.maxLevel || 10;
            const supernovaForgeCount = state.generators.find(g => g.id === 'gen4')?.count || 0;

            const tiers = [
                { req: 1000, condition: () => state.atoms.gte('1e21420') },
                { req: 100,  condition: () => state.atoms.gte('1e2142') },
                { req: 50,   condition: () => true }
            ];
            
            const activeTier = tiers.find(tier => tier.condition());
            const bonusLevels = activeTier ? Math.floor(supernovaForgeCount / activeTier.req) * 5 : 0;
            modifiedUpg.maxLevel = initialMaxLevel + bonusLevels;
        }
        
        if (upg.id === 'upg4' && state.research.find(r => r.id === 'res7')?.isPurchased) {
            const initialMaxLevel = INITIAL_UPGRADES.find(u => u.id === 'upg4')?.maxLevel || 10;
            const originCount = state.subjects.find(s => s.id === 'sub1')?.count || 0;

            const tiers = [
                { req: 1000, livesThreshold: new D('1e10000') },
                { req: 250,  livesThreshold: new D('1e6426') },
                { req: 50,   livesThreshold: new D('1e4284') },
                { req: 20,   livesThreshold: new D('1e2142') },
                { req: 10,   livesThreshold: new D(0) }
            ];
            
            const activeTier = tiers.find(tier => state.lives.gte(tier.livesThreshold));
            const bonusLevels = activeTier ? Math.floor(originCount / activeTier.req) * 5 : 0;
            modifiedUpg.maxLevel = initialMaxLevel + bonusLevels;
        }
        if (upg.id === 'upg4' && isHumanConsciousnessScalingUnlocked) {
            const currentTheoreticalMax = modifiedUpg.maxLevel || INITIAL_UPGRADES.find(u => u.id === upg.id)?.maxLevel || 10;
            const humans = state.humans.total || 0;
            const cappedHumans = Math.min(humans, 1e12); 
            const humansInBillions = Math.floor(cappedHumans / 1e9);
            const humanBonusLevels = humansInBillions * 5;
            
            modifiedUpg.maxLevel = currentTheoreticalMax + humanBonusLevels;
        }

        if (upg.id === 'upg5' && isPantheonSymbiosisScalingUnlocked) {
            const initialMaxLevel = INITIAL_UPGRADES.find(u => u.id === upg.id)?.maxLevel || 10;
            const pantheonSubjects = state.subjects.find(s => s.id === 'sub5')?.count || 0;
            
            const tiers = [ 
                { req: 10000, livesThreshold: new D('1e6426') },
                { req: 5000,  livesThreshold: new D('1e4284') },
                { req: 2000,  livesThreshold: new D('1e2142') },
                { req: 1000,  livesThreshold: new D(0) }
            ];

            const activeTier = tiers.find(tier => state.lives.gte(tier.livesThreshold));
            const bonusLevels = activeTier ? Math.floor(pantheonSubjects / activeTier.req) * 5 : 0;
            modifiedUpg.maxLevel = initialMaxLevel + bonusLevels;
        }

        if (upg.id === 'upg4') {
            const lt3Level = state.lifeTechnologies.find(t => t.id === 'lt3')?.level || 0;
            const initialEffect = INITIAL_UPGRADES.find(u => u.id === 'upg4').effect();
            modifiedUpg.effect = () => initialEffect * (1 + lt3Level * 0.02);
        }
        if (upg.id === 'upg5') {
            const lt2Level = state.lifeTechnologies.find(t => t.id === 'lt2')?.level || 0;
            const initialEffect = INITIAL_UPGRADES.find(u => u.id === 'upg5').effect();
            modifiedUpg.effect = () => initialEffect * (1 + lt2Level * 0.1);
        }

        return modifiedUpg;
    }).filter(upg => upg.unlockCondition ? upg.unlockCondition(state) : true);
}, []);

  useEffect(() => {
    const currentBHC = gameState.generators.find(g => g.id === 'gen5')?.count || 0;
    if (currentBHC > (gameState.maxHistoricalBHC || 0)) {
        setGameState(prev => ({ ...prev, maxHistoricalBHC: currentBHC }));
    }
  }, [gameState.generators]);

  const mindMilestoneBonuses = useMemo(() => {
    const bonuses = {
        aiGeneration: new D(1),
        spGeneration: new D(1),
        humanGainBonusMultiplier: new D(1),
        superHumanGainBonusMultiplier: new D(1),
        temporalPrestigeMaxLevelBonus: 0
    };

    MIND_MILESTONES.forEach(milestone => {
        if (gameState.mind.level >= milestone.level) {
            switch (milestone.effect.type) {
                case 'ai_gen':
                    bonuses.aiGeneration = bonuses.aiGeneration.add(milestone.effect.value - 1);
                    break;
                case 'sp_gen':
                    bonuses.spGeneration = bonuses.spGeneration.add(milestone.effect.value - 1);
                    break;
                case 'shg_bonus_mult':
                    bonuses.superHumanGainBonusMultiplier = bonuses.superHumanGainBonusMultiplier.mul(milestone.effect.value);
                    break;
                case 'hg_bonus_mult':
                    bonuses.humanGainBonusMultiplier = bonuses.humanGainBonusMultiplier.mul(milestone.effect.value);
                    break;
                case 'ps3_max_level':
                    bonuses.temporalPrestigeMaxLevelBonus += milestone.effect.value;
                    break;
            }
        }
    });
    return bonuses;
  }, [gameState.mind.level]);

  const artificialIngenuityPerSecond = useMemo(() => {
    const skillBonus = new D(1).add(new D(gameState.superHumanSkills.find(s => s.id === 'shs1')?.level || 0).mul(0.1));
    return new D(gameState.superHumans).mul(ARTIFICIAL_INGENUITY_PER_SUPER_HUMAN_PER_SECOND).mul(skillBonus).mul(mindMilestoneBonuses.aiGeneration);
  }, [gameState.superHumans, gameState.superHumanSkills, mindMilestoneBonuses.aiGeneration]);

  const skillPointGenerationRate = useMemo(() => {
      const ip2Level = gameState.infiniteProjects.find(p => p.id === 'ip2')?.level || 0;
      const ip2Bonus = new D(1).add(new D(ip2Level).mul(0.1));
      
      const superHumansIp2 = gameState.superHumansAssigned?.ip2 || 0;
      const superHumanSkillBonus = new D(1).add(new D(gameState.superHumanSkills.find(s => s.id === 'shs4')?.level || 0).mul(0.5));
      const ip2Special = new D(1);
      const superHumanProjectBonus = superHumansIp2 > 0 ? new D(superHumansIp2).add(5) : new D(1);
      
      return new D(gameState.humans.total)
        .mul(HUMAN_SKILL_POINTS_PER_SECOND_PER_HUMAN)
        .mul(ip2Bonus)
        .mul(superHumanSkillBonus)
        .mul(ip2Special)
        .mul(superHumanProjectBonus)
        .mul(mindMilestoneBonuses.spGeneration);
  }, [gameState.humans.total, gameState.infiniteProjects, gameState.superHumansAssigned, gameState.superHumanSkills, mindMilestoneBonuses.spGeneration]);

  const effectiveUpgrades = useMemo(() => {
        return getEffectiveUpgrades(gameState);
    }, [gameState, getEffectiveUpgrades]);

  const prestigePointsPerSecond = useMemo(() => {
    const ps3 = gameState.prestigeSkills.find(s => s.id === 'ps3');
    if (!ps3 || ps3.level === 0) {
        return new D(0);
    }
    const ratePerLevel = 0.01;
    return gameState.prestigePoints.mul(ps3.level * ratePerLevel);
  }, [gameState.prestigePoints, gameState.prestigeSkills]);
  
  const mindBonuses = useMemo(() => {
    const bonuses = {
        humanGain: new D(1),
        superHumanGain: new D(1),
        lifeProduction: new D(1)
    };
    if (!gameState.mind.unlocked) return bonuses;

    let baseHumanGainBonus = new D(0);
    let baseSuperHumanGainBonus = new D(0);

    for (let i = 1; i <= gameState.mind.level; i++) {
        const type = (i - 1) % 3;
        if (type === 0) {
            baseHumanGainBonus = baseHumanGainBonus.add(0.50);
        } else if (type === 1) {
            baseSuperHumanGainBonus = baseSuperHumanGainBonus.add(0.50);
        } else {
            bonuses.lifeProduction = bonuses.lifeProduction.mul(1000);
        }
    }

    bonuses.humanGain = new D(1).add(baseHumanGainBonus.mul(mindMilestoneBonuses.humanGainBonusMultiplier));
    bonuses.superHumanGain = new D(1).add(baseSuperHumanGainBonus.mul(mindMilestoneBonuses.superHumanGainBonusMultiplier));
    
    return bonuses;
  }, [gameState.mind.level, gameState.mind.unlocked, mindMilestoneBonuses]);

  const lifeProductionMultiplier = useMemo(() => {
    const lifeUpgrade = effectiveUpgrades.find(u => u.id === 'upg4');
    let lifeMultiplier = new D(1);
    
    if (lifeUpgrade && lifeUpgrade.level > 0) {
        lifeMultiplier = new D(lifeUpgrade.effect()).pow(lifeUpgrade.level);
    }
    
    const skillBonus = new D(1).add(new D(gameState.humanSkills.find(s => s.id === 'hs3')?.level || 0).mul(0.01));
    const lt1Bonus = new D(1).add(new D(gameState.lifeTechnologies.find(t => t.id === 'lt1')?.level || 0).mul(0.1));

return lifeMultiplier.mul(skillBonus).mul(lt1Bonus).mul(mindBonuses.lifeProduction).mul(galacticBonuses.lifeMultiplier);
  }, [effectiveUpgrades, gameState.humanSkills, gameState.lifeTechnologies, mindBonuses.lifeProduction]);

  const livesPerSecond = useMemo(() => {
    let baseLifeProduction = gameState.subjects.reduce((total, sub) => total.add(new D(sub.baseLifeProduction).mul(sub.count)), new D(0));
    return baseLifeProduction.mul(lifeProductionMultiplier);
  }, [gameState.subjects, lifeProductionMultiplier]);
  
const calculateTotalHumanBonusMultiplier = (assignedHumans, totalHumans, humanSkills, superHumanSkills) => {
    if (assignedHumans === 0) {
        return new D(1);
    }

    const effectiveTotalHumans = Math.min(totalHumans, 1e12);

    const humanIngenuityBonus = new D(humanSkills.find(s => s.id === 'hs1')?.level || 0).mul(0.01);
    const cosmicArchitectsBonus = new D(superHumanSkills.find(s => s.id === 'shs3')?.level || 0).mul(0.01);
    const skillBonus = humanIngenuityBonus.add(cosmicArchitectsBonus);

    const TIER1_CAP = 1e9;  // 1b
    const TIER2_CAP = 1e10;   // 10b
    const TIER3_CAP = 1e11;   // 100b
    const TIER4_CAP = 1e12;   // 1t

    const TIER1_BONUS = new D(0.25).add(skillBonus);
    const TIER2_BONUS = new D(0.01).add(skillBonus);
    const TIER3_BONUS = new D(0.0001).add(skillBonus);
    const TIER4_BONUS = new D(0.0000000001).add(skillBonus);
    

    let totalBonus = new D(0);

    const tier1_humans = Math.min(effectiveTotalHumans, TIER1_CAP);
    const tier2_humans = Math.min(Math.max(0, effectiveTotalHumans - TIER1_CAP), TIER2_CAP - TIER1_CAP);
    const tier3_humans = Math.min(Math.max(0, effectiveTotalHumans - TIER2_CAP), TIER3_CAP - TIER2_CAP);
    const tier4_humans = Math.max(0, effectiveTotalHumans - TIER3_CAP);

    if (tier1_humans > 0) {
        totalBonus = totalBonus.add(TIER1_BONUS.mul(tier1_humans));
    }
    if (tier2_humans > 0) {
        totalBonus = totalBonus.add(TIER2_BONUS.mul(tier2_humans));
    }
    if (tier3_humans > 0) {
        totalBonus = totalBonus.add(TIER3_BONUS.mul(tier3_humans));
    }
    if(tier4_humans > 0) {
        totalBonus = totalBonus.add(TIER4_BONUS.mul(tier4_humans));
    }
    
    const averageBonusPerHuman = effectiveTotalHumans > 0 ? totalBonus.div(effectiveTotalHumans) : new D(0);
    
    return new D(1).add(averageBonusPerHuman.mul(assignedHumans));
};


  const effectiveBonusPerHuman = useMemo(() => {
      const totalHumans = gameState.humans.total;
      const assignedHumans = gameState.humans.assigned;
      let baseBonus;
      if (totalHumans < 5e11) {
          baseBonus = new D(HUMAN_GENERATOR_BONUS_PER_HUMAN);
      } else if (totalHumans < 5e14) {
          baseBonus = new D(0.10);
      } else {
          baseBonus = new D(0.02);
      }

      const humanIngenuityBonus = new D(gameState.humanSkills.find(s => s.id === 'hs1')?.level || 0).mul(0.01);
      const cosmicArchitectsBonus = new D(gameState.superHumanSkills.find(s => s.id === 'shs3')?.level || 0).mul(0.01);
      
      return baseBonus.add(humanIngenuityBonus).add(cosmicArchitectsBonus);
  }, [gameState.humanSkills, gameState.superHumanSkills, gameState.humans.total]);

  
  const { totalGlobalMultiplier, prestigeBonus, researchMultiplier, lifeBonus, infiniteProjectBonus, ip1Special, specificGeneratorMultipliers, prestigeSkillBonus, researchCostReduction } = useMemo(() => {
    const globalMultiplier = effectiveUpgrades
        .filter(upg => !upg.appliesToGenerator && upg.level > 0 && upg.id !== 'upg4' && upg.id !== 'upg5')
        .reduce((multiplier, upg) => multiplier.mul(new D(upg.effect()).pow(upg.level)), new D(1));

    let prestigeBonusPercentage;
    if (gameState.research.find(r => r.id === 'res0' && r.isPurchased)) {
        prestigeBonusPercentage = 1.02;
    }
    else if (gameState.research.find(r => r.id === 'res3' && r.isPurchased)) {
        prestigeBonusPercentage = 1.015;
    }
    else {
        prestigeBonusPercentage = 1.01;
    }

    const prestigeBonusVal = new D(1).add(gameState.prestigePoints.mul(prestigeBonusPercentage - 1));
    
    let researchMultiplierVal = gameState.research.find(r => r.id === 'res1' && r.isPurchased) ? new D(1.5) : new D(1);
    
    const lifeUpgrade = effectiveUpgrades.find(u => u.id === 'upg5');
    const perLifeBonusBase = new D(0.1);
    const perLifeBonusEffect = lifeUpgrade ? new D(lifeUpgrade.effect()).pow(lifeUpgrade.level) : new D(1);
    const perLifeBonus = perLifeBonusBase.mul(perLifeBonusEffect);
    const researchLifeBonus = gameState.research.find(r => r.id === 'res6' && r.isPurchased) ? new D(1.25) : new D(1);
    const lifeBonusVal = new D(1).add(gameState.lives.mul(perLifeBonus).mul(researchLifeBonus));
    
    const superHumansIp1 = gameState.superHumansAssigned?.ip1 || 0;
    const ip1Level = gameState.infiniteProjects.find(p => p.id === 'ip1')?.level || 0;
    const superHumanProjectBonusIp1 = superHumansIp1 > 0 ? new D(superHumansIp1).add(5) : new D(1);
    const infiniteProjectBonusVal = new D(1).add(new D(ip1Level).mul(0.1)).mul(superHumanProjectBonusIp1);
    const ip1SpecialMultiplier = new D(1);

    const specificMultipliers = {};
    effectiveUpgrades.filter(upg => upg.appliesToGenerator && upg.level > 0).forEach(upg => {
        specificMultipliers[upg.appliesToGenerator] = (specificMultipliers[upg.appliesToGenerator] || new D(1)).mul(new D(upg.effect()).pow(upg.level));
    });

    const ps1Bonus = new D(1).add(new D(gameState.prestigeSkills.find(s => s.id === 'ps1')?.level || 0).mul(0.1));
    const ps2Reduction = new D(1).sub(new D(Math.min(0.99, (gameState.prestigeSkills.find(s => s.id === 'ps2')?.level || 0) * 0.01)));

    return {
        totalGlobalMultiplier: globalMultiplier,
        prestigeBonus: prestigeBonusVal,
        researchMultiplier: researchMultiplierVal,
        lifeBonus: lifeBonusVal,
        infiniteProjectBonus: infiniteProjectBonusVal,
        ip1Special: ip1SpecialMultiplier,
        specificGeneratorMultipliers: specificMultipliers,
        prestigeSkillBonus: ps1Bonus,
        researchCostReduction: ps2Reduction
    };
  }, [gameState, effectiveUpgrades]);

  const atomsPerSecond = useMemo(() => {
    const baseProductionFromGenerators = gameState.generators.reduce((total, gen) => {
        if (typeof gen.count === 'undefined' || typeof gen.baseProduction === 'undefined') {
            console.error('Generator is missing count or baseProduction:', gen);
            return total;
        }
        let singleGeneratorProduction = new D(gen.baseProduction);
        const specificMultiplier = specificGeneratorMultipliers[gen.id] || new D(1);
        const assignedHumans = (gameState.humans.assigned || {})[gen.id] || 0;
        const humanBonusMultiplier = calculateTotalHumanBonusMultiplier(assignedHumans, gameState.humans.total, gameState.humanSkills, gameState.superHumanSkills);
        let gen2Boost = new D(1);
        if(gen.id === 'gen2' && gameState.superHumanSkills) {
            const gen2Skill = gameState.superHumanSkills.find(s => s.id === 'shs2');
            if(gen2Skill) {
                gen2Boost = new D(6).pow(gen2Skill.level);
            }
        }
        
        singleGeneratorProduction = singleGeneratorProduction.mul(specificMultiplier).mul(humanBonusMultiplier).mul(gen2Boost);
        return total.add(singleGeneratorProduction.mul(gen.count));
    }, new D(0));
    
    return baseProductionFromGenerators.mul(totalGlobalMultiplier).mul(prestigeBonus).mul(researchMultiplier).mul(lifeBonus).mul(infiniteProjectBonus).mul(ip1Special).mul(universeMultiplier).mul(galacticBonuses.atomMultiplier);
  }, [gameState, totalGlobalMultiplier, prestigeBonus, researchMultiplier, lifeBonus, infiniteProjectBonus, ip1Special, specificGeneratorMultipliers, universeMultiplier, galacticBonuses.atomMultiplier, gameState.humans.total]);
    const performPrestige = useCallback((currentState, psBonus, galBonus) => {
        if (currentState.atoms.lt(PRESTIGE_REQUIREMENT)) return currentState;
        const prestigePointsGainedBase = currentState.atoms.div(PRESTIGE_REQUIREMENT).sqrt().mul(psBonus).mul(galBonus);
        const prestigePointsGained = calculatePrestigeGainWithSoftcap(currentState.prestigePoints, prestigePointsGainedBase);        
        const newState = getInitialGameState(); 
        
        newState.research = currentState.research;
        newState.subjects = currentState.subjects;
        newState.lives = currentState.lives;
        newState.subjectsUnlocked = currentState.subjectsUnlocked;
        newState.humans = currentState.humans;
        newState.humansUnlocked = currentState.humansUnlocked;
        newState.skillPoints = currentState.skillPoints;
        newState.humanSkills = currentState.humanSkills;
        newState.infiniteProjects = currentState.infiniteProjects;
        newState.prestigeSkills = currentState.prestigeSkills;
        newState.lifeTechnologies = currentState.lifeTechnologies;
        newState.generatorAutomations = currentState.generatorAutomations;
        newState.autoBuyUpgrades = currentState.autoBuyUpgrades;
        newState.autoBuyLifeTechs = currentState.autoBuyLifeTechs;
        newState.autoBuyHumanSkills = currentState.autoBuyHumanSkills;
        newState.autoBuySuperHumanSkills = currentState.autoBuySuperHumanSkills;
        newState.autoBuyInfiniteProjects = currentState.autoBuyInfiniteProjects;
        newState.superHumans = currentState.superHumans;
        newState.superHumansAssigned = currentState.superHumansAssigned;
        newState.artificialIngenuity = currentState.artificialIngenuity;
        newState.superHumansUnlocked = currentState.superHumansUnlocked;
        newState.superHumanSkills = currentState.superHumanSkills;
        newState.maxHistoricalBHC = currentState.maxHistoricalBHC;
        newState.stardust = currentState.stardust;
        newState.stardustAwardedfromBHC = currentState.stardustAwardedfromBHC;
        newState.universeData = currentState.universeData;
        newState.planetarySystems = currentState.planetarySystems;
        newState.galacticPoints = currentState.galacticPoints;
        newState.mind = currentState.mind;
        newState.universeUnlockedNotified = currentState.universeUnlockedNotified;

        newState.prestigePoints = currentState.prestigePoints.add(prestigePointsGained);
        
        if (currentState.research.find(r => r.id === 'res4' && r.isPurchased)) {
             newState.atoms = currentState.atoms.mul(0.01);
        } else {
            newState.atoms = new D(10);
        }

        if (currentState.research.find(r => r.id === 'res2' && r.isPurchased)) {
            const gen1 = newState.generators.find(g => g.id === 'gen1');
            if (gen1) gen1.count = RESEARCH_STARTING_BOOST_AMOUNT;
        }
        return newState; 
    }, []);

    const performHumanAscension = useCallback((currentState, gained) => {
        if (gained <= 0) return currentState;
        const initialState = getInitialGameState();
        initialState.humans = { total: currentState.humans.total + gained, assigned: {} };
        initialState.humansUnlocked = true;
        initialState.skillPoints = currentState.skillPoints;
        initialState.humanSkills = currentState.humanSkills;
        initialState.superHumans = currentState.superHumans;
        initialState.superHumansAssigned = currentState.superHumansAssigned;
        initialState.artificialIngenuity = currentState.artificialIngenuity;
        initialState.superHumansUnlocked = currentState.superHumansUnlocked;
        initialState.superHumanSkills = currentState.superHumanSkills;
        initialState.autoBuyUpgrades = currentState.autoBuyUpgrades;
        initialState.generatorAutomations = currentState.generatorAutomations;
        initialState.autoBuyLifeTechs = currentState.autoBuyLifeTechs;
        initialState.autoBuyHumanSkills = currentState.autoBuyHumanSkills;
        initialState.autoBuySuperHumanSkills = currentState.autoBuySuperHumanSkills;
        initialState.autoBuyInfiniteProjects = currentState.autoBuyInfiniteProjects;
        initialState.maxHistoricalBHC = currentState.maxHistoricalBHC;
        initialState.stardust = currentState.stardust;
        initialState.stardustAwardedfromBHC = currentState.stardustAwardedfromBHC;
        initialState.universeData = currentState.universeData;
        initialState.planetarySystems = currentState.planetarySystems;
        initialState.galacticPoints = currentState.galacticPoints;
        initialState.mind = currentState.mind;

        const automationResearchIds = ['res8', 'res9', 'res10', 'res12', 'res13', 'res14', 'res15'];
        automationResearchIds.forEach(resId => {
            const research = currentState.research.find(r => r.id === resId);
            if(research && research.isPurchased) {
                const targetResearch = initialState.research.find(r => r.id === resId);
                if (targetResearch) targetResearch.isPurchased = true;
            }
        });

        return initialState;
    }, []);
    
    const stardustPerSecond = useMemo(() => {
        let stardustFromMoons = new D(0);
        (gameState.universeData.purchasedMoons || []).forEach(moonName => {
            if (UNIVERSE_MOONS[moonName]) {
                stardustFromMoons = stardustFromMoons.add(UNIVERSE_MOONS[moonName].stardust || 0);
            }
        });
        
        let moonMultiplier = new D(1);
        (gameState.universeData.purchasedUpgrades || []).forEach(upgradeName => {
            const upgradeData = UNIVERSE_UPGRADES[upgradeName];
            if (upgradeData && upgradeData.effect === 'moon') {
                moonMultiplier = moonMultiplier.mul(upgradeData.multiplier);
            }
        });

        return stardustFromMoons.mul(moonMultiplier).mul(galacticBonuses.stardustMultiplier);
    }, [gameState.universeData.purchasedMoons, gameState.universeData.purchasedUpgrades, galacticBonuses.stardustMultiplier]);

  useEffect(() => {
    const interval = setInterval(() => {
      const now = Date.now();
      const deltaTimeInSeconds = (now - lastTickTimeRef.current) / 1000;
      lastTickTimeRef.current = now;
      
      setGameState(prev => {
        let newState = { ...prev };

        newState.atoms = prev.atoms.add(atomsPerSecond.mul(deltaTimeInSeconds));
        newState.lives = prev.lives.add(livesPerSecond.mul(deltaTimeInSeconds));
        newState.skillPoints = prev.skillPoints.add(skillPointGenerationRate.mul(deltaTimeInSeconds));
        newState.artificialIngenuity = prev.artificialIngenuity.add(artificialIngenuityPerSecond.mul(deltaTimeInSeconds));
        newState.prestigePoints = prev.prestigePoints.add(prestigePointsPerSecond.mul(deltaTimeInSeconds));
        newState.stardust = prev.stardust.add(stardustPerSecond.mul(deltaTimeInSeconds));

        const currentEnergy = new D(prev.universeData.totalEnergy || '0');
        const energyPerTick = universeEnergyPerSecond.mul(deltaTimeInSeconds);
        newState.universeData = {
            ...prev.universeData,
            totalEnergy: currentEnergy.add(energyPerTick).toString()
        };


        if (prev.research.find(r => r.id === 'res8')?.isPurchased) {
            const effectiveGens = getEffectiveGenerators(newState);
            const automatedAndAffordable = effectiveGens
                .filter(gen => newState.generatorAutomations[gen.id])
                .map(gen => ({ gen, cost: calculatePurchaseCost(gen, 1) }))
                .filter(item => newState.atoms.gte(item.cost))
                .sort((a, b) => a.cost.cmp(b.cost));

            if (automatedAndAffordable.length > 0) {
                const cheapestToBuy = automatedAndAffordable[0];
                const { gen } = cheapestToBuy;
                const maxAffordable = calculateMaxAffordable(gen, newState.atoms);
                if (maxAffordable > 0) {
                    const cost = calculatePurchaseCost(gen, maxAffordable);
                    const genIndex = newState.generators.findIndex(g => g.id === gen.id);
                    if (genIndex !== -1) {
                        const newGenerators = [...newState.generators];
                        newGenerators[genIndex] = { ...newGenerators[genIndex], count: newGenerators[genIndex].count + maxAffordable };
                        newState.atoms = newState.atoms.sub(cost);
                        newState.generators = newGenerators;
                    }
                }
            }
        }

        if (prev.autoBuyUpgrades && prev.research.find(r => r.id === 'res9')?.isPurchased) {
            const effectiveUpgs = getEffectiveUpgrades(newState); 
            const sortedUpgrades = [...effectiveUpgs].filter(upg => !upg.maxLevel || upg.level < upg.maxLevel)
                .sort((a, b) => calculatePurchaseCost({ ...a, count: a.level }, 1).cmp(calculatePurchaseCost({ ...b, count: b.level }, 1)));
            
            if(sortedUpgrades.length > 0) {
                const upg = sortedUpgrades[0];
                const maxAffordable = calculateMaxAffordable({ ...upg, count: upg.level }, newState.atoms);
                const levelsToBuy = upg.maxLevel ? Math.min(maxAffordable, upg.maxLevel - upg.level) : maxAffordable;

                if (levelsToBuy > 0) {
                    const upgIndex = newState.upgrades.findIndex(u => u.id === upg.id);
                    if (upgIndex !== -1) {
                        newState.atoms = newState.atoms.sub(calculatePurchaseCost({ ...upg, count: upg.level }, levelsToBuy));
                        const newUpgrades = [...newState.upgrades];
                        newUpgrades[upgIndex] = { ...newUpgrades[upgIndex], level: newUpgrades[upgIndex].level + levelsToBuy };
                        newState.upgrades = newUpgrades;
                    }
                }
            }
        }
        if (prev.autoBuyLifeTechs && prev.research.find(r => r.id === 'res12')?.isPurchased) {
            const buyable = prev.lifeTechnologies
                .filter(t => !t.maxLevel || t.level < t.maxLevel)
                .sort((a, b) => calculatePurchaseCost({ ...a, count: a.level }, 1).cmp(calculatePurchaseCost({ ...b, count: b.level }, 1)));
            
            if (buyable.length > 0) {
                const cheapest = buyable[0];
                const maxAffordable = calculateMaxAffordable({ ...cheapest, count: cheapest.level }, newState.lives);
                
                if (maxAffordable > 0) {
                    const totalCost = calculatePurchaseCost({ ...cheapest, count: cheapest.level }, maxAffordable);
                    const index = newState.lifeTechnologies.findIndex(t => t.id === cheapest.id);
                    if (index !== -1) {
                        const newTechs = [...newState.lifeTechnologies];
                        newTechs[index] = { ...newTechs[index], level: newTechs[index].level + maxAffordable };
                        newState.lives = newState.lives.sub(totalCost);
                        newState.lifeTechnologies = newTechs;
                    }
                }
            }
        }
        if (prev.autoBuyHumanSkills && prev.research.find(r => r.id === 'res13')?.isPurchased) {
            const buyable = prev.humanSkills
                .filter(s => !s.maxLevel || s.level < s.maxLevel)
                .sort((a, b) => new D(a.baseCost).mul(new D(a.costIncreaseFactor).pow(a.level)).cmp(new D(b.baseCost).mul(new D(b.costIncreaseFactor).pow(b.level))));

            if (buyable.length > 0) {
                const cheapest = buyable[0];
                const maxAffordable = calculateMaxAffordable({ ...cheapest, count: cheapest.level }, newState.skillPoints);

                if (maxAffordable > 0) {
                    const totalCost = calculatePurchaseCost({ ...cheapest, count: cheapest.level }, maxAffordable);
                    const index = newState.humanSkills.findIndex(s => s.id === cheapest.id);
                    if (index !== -1) {
                        const newSkills = [...newState.humanSkills];
                        newSkills[index] = { ...newSkills[index], level: newSkills[index].level + maxAffordable };
                        newState.skillPoints = newState.skillPoints.sub(totalCost);
                        newState.humanSkills = newSkills;
                    }
                }
            }
        }
        if (prev.autoBuySuperHumanSkills && prev.research.find(r => r.id === 'res14')?.isPurchased) {
            const buyable = prev.superHumanSkills
                .filter(s => !s.maxLevel || s.level < s.maxLevel)
                .sort((a, b) => new D(a.baseCost).mul(new D(a.costIncreaseFactor).pow(a.level)).cmp(new D(b.baseCost).mul(new D(b.costIncreaseFactor).pow(b.level))));

            if (buyable.length > 0) {
                const cheapest = buyable[0];
                const maxAffordable = calculateMaxAffordable({ ...cheapest, count: cheapest.level }, newState.artificialIngenuity);

                if (maxAffordable > 0) {
                    const totalCost = calculatePurchaseCost({ ...cheapest, count: cheapest.level }, maxAffordable);
                    const index = newState.superHumanSkills.findIndex(s => s.id === cheapest.id);
                    if (index !== -1) {
                        const newSkills = [...newState.superHumanSkills];
                        newSkills[index] = { ...newSkills[index], level: newSkills[index].level + maxAffordable };
                        newState.artificialIngenuity = newState.artificialIngenuity.sub(totalCost);
                        newState.superHumanSkills = newSkills;
                    }
                }
            }
        }
        if (prev.autoBuyInfiniteProjects && prev.research.find(r => r.id === 'res15')?.isPurchased) {
            const buyable = prev.infiniteProjects
                .sort((a, b) => new D(a.baseCost).mul(new D(a.costIncreaseFactor).pow(a.level)).cmp(new D(b.baseCost).mul(new D(b.costIncreaseFactor).pow(b.level))));

            if (buyable.length > 0) {
                const cheapest = buyable[0];
                const maxAffordable = calculateMaxAffordable({ ...cheapest, count: cheapest.level }, newState.atoms);
                
                if (maxAffordable > 0) {
                    const totalCost = calculatePurchaseCost({ ...cheapest, count: cheapest.level }, maxAffordable);
                    const index = newState.infiniteProjects.findIndex(p => p.id === cheapest.id);
                    if (index !== -1) {
                        const newProjects = [...newState.infiniteProjects];
                        newProjects[index] = { ...newProjects[index], level: newProjects[index].level + maxAffordable };
                        newState.atoms = newState.atoms.sub(totalCost);
                        newState.infiniteProjects = newProjects;
                    }
                }
            }
        }
        if (prev.research.find(r => r.id === 'res10')?.isPurchased) {
            const researchToBuy = prev.research
                .filter(r => !r.isPurchased && (!r.unlockCondition || r.unlockCondition(prev)) && r.dependencies.every(depId => prev.research.find(dep => dep.id === depId)?.isPurchased))
                .sort((a, b) => new D(a.cost).cmp(new D(b.cost)))[0];
            
            if (researchToBuy) {
                const effectiveCost = new D(researchToBuy.cost).mul(researchCostReduction);
                if (newState.prestigePoints.gte(effectiveCost)) {
                    const resIndex = newState.research.findIndex(r => r.id === researchToBuy.id);
                    if (resIndex !== -1) {
                       newState.prestigePoints = newState.prestigePoints.sub(effectiveCost);
                       const newResearch = [...newState.research];
                       newResearch[resIndex] = { ...newResearch[resIndex], isPurchased: true };
                       newState.research = newResearch;
                    }
                }
            }
        }
        if (prev.research.find(r => r.id === 'res16')?.isPurchased) {
            const automatedSubjects = newState.subjects.filter(sub => newState.subjectAutomations?.[sub.id]);

            automatedSubjects.forEach(sub => {
                let resourcePool;
                if (sub.costResource === 'atoms') resourcePool = newState.atoms;
                else if (sub.costResource === 'lives') resourcePool = newState.lives;
                
                if (resourcePool) {
                    const maxAffordable = calculateMaxAffordable(sub, resourcePool);
                    if (maxAffordable > 0) {
                        const cost = calculatePurchaseCost(sub, maxAffordable);
                        const subIndex = newState.subjects.findIndex(s => s.id === sub.id);
                        if (subIndex !== -1) {
                            const newSubjects = [...newState.subjects];
                            newSubjects[subIndex] = { ...newSubjects[subIndex], count: newSubjects[subIndex].count + maxAffordable };
                            
                            if (sub.costResource === 'atoms') {
                                newState.atoms = newState.atoms.sub(cost);
                            } else if (sub.costResource === 'lives') {
                                newState.lives = newState.lives.sub(cost);
                            }
                            newState.subjects = newSubjects;
                        }
                    }
                }
            });
        }
        return newState;
      });
    }, GAME_TICK_RATE_MS);
    return () => clearInterval(interval);
  }, [atomsPerSecond, livesPerSecond, skillPointGenerationRate, artificialIngenuityPerSecond, prestigePointsPerSecond, getEffectiveGenerators, getEffectiveUpgrades, researchCostReduction, performPrestige, prestigeSkillBonus, performHumanAscension, stardustPerSecond, universeEnergyPerSecond]);
  useEffect(() => {
    if (!gameState.subjectsUnlocked && gameState.atoms.gte(SUBJECTS_UNLOCK_REQUIREMENT)) {
        setGameState(prev => ({...prev, subjectsUnlocked: true}));
        setActiveTab('subjects');
        addNotification("Subjects Unlocked! A new path opens.");
    }
    if (gameState.subjectsUnlocked && !gameState.humansUnlocked && gameState.lives.gte(HUMANS_UNLOCK_REQUIREMENT)) {
        setGameState(prev => ({...prev, humansUnlocked: true}));
        setActiveTab('subjects');
        addNotification("Humanity Arises! New potential unlocked.");
    }
     if (gameState.humansUnlocked && !gameState.superHumansUnlocked && new D(gameState.humans.total).gte(SUPER_HUMAN_UNLOCK_REQUIREMENT)) {
        setGameState(prev => ({...prev, superHumansUnlocked: true}));
        setActiveTab('superHumans');
        addNotification("Transcendence! Super Humans are now available.");
    }
    if (!gameState.mind.unlocked && gameState.superHumans >= MIND_UNLOCK_REQUIREMENT) {
        setGameState(prev => ({...prev, mind: {...prev.mind, unlocked: true}}));
        setActiveTab('mind');
        addNotification("A new consciousness awakens... The Mind is unlocked.");
    }
  }, [gameState.atoms, gameState.lives, gameState.humans.total, gameState.subjectsUnlocked, gameState.humansUnlocked, gameState.superHumansUnlocked, gameState.superHumans, gameState.mind.unlocked, addNotification]);

  const effectiveGenerators = useMemo(() => {
      return getEffectiveGenerators(gameState);
  }, [gameState.generators, gameState.humanSkills]);
  
  const effectivePrestigeSkills = useMemo(() => {
    return gameState.prestigeSkills.map(skill => {
        if (skill.id === 'ps3') {
            const initialSkill = INITIAL_PRESTIGE_SKILLS.find(s => s.id === 'ps3');
            if (initialSkill) {
                return {
                    ...skill,
                    maxLevel: initialSkill.maxLevel + mindMilestoneBonuses.temporalPrestigeMaxLevelBonus
                };
            }
        }
        return skill;
    });
  }, [gameState.prestigeSkills, mindMilestoneBonuses.temporalPrestigeMaxLevelBonus]);

  const visibleResearch = useMemo(() => gameState.research.filter(res => res.unlockCondition ? res.unlockCondition(gameState) : true), [gameState]);
  const visibleInfiniteProjects = useMemo(() => gameState.humansUnlocked ? gameState.infiniteProjects : [], [gameState.humansUnlocked, gameState.infiniteProjects]);

const handleBuyGenerator = useCallback((id, amount) => {
    setGameState(prev => {
      const generatorToBuy = getEffectiveGenerators(prev).find(g => g.id === id);
      if (!generatorToBuy || amount <= 0) return prev;
      const cost = calculatePurchaseCost(generatorToBuy, amount);
      if (prev.atoms.gte(cost)) {
        const newGenerators = prev.generators.map(g => g.id === id ? { ...g, count: g.count + amount } : g);
        return { ...prev, atoms: Decimal.max(prev.atoms.sub(cost), 0), generators: newGenerators };
      }
      return prev;
    });
  }, [getEffectiveGenerators]);

const handleBuyUpgrade = useCallback((id, amount) => {
    setGameState(prev => {
        const originalUpgrade = prev.upgrades.find(u => u.id === id);
        if (!originalUpgrade) return prev;
        
        const effectiveUpgrade = getEffectiveUpgrades(prev).find(u => u.id === id);
        const isAlreadyMaxLevel = effectiveUpgrade.maxLevel !== undefined && effectiveUpgrade.level >= effectiveUpgrade.maxLevel;
        if (isAlreadyMaxLevel || amount <= 0) return prev;
        
        const cappedAmount = effectiveUpgrade.maxLevel ? Math.min(amount, effectiveUpgrade.maxLevel - effectiveUpgrade.level) : amount;
        if (cappedAmount <= 0) return prev;

        const cost = calculatePurchaseCost({ ...originalUpgrade, count: originalUpgrade.level }, cappedAmount);
        if (prev.atoms.gte(cost)) {
            const newUpgrades = prev.upgrades.map(u => u.id === id ? { ...u, level: u.level + cappedAmount } : u);
            return { ...prev, atoms: Decimal.max(prev.atoms.sub(cost), 0), upgrades: newUpgrades };
        }
        return prev;
    });
  }, [getEffectiveUpgrades]);

  const handlePrestige = useCallback(() => {
    setGameState(prev => performPrestige(prev, prestigeSkillBonus, galacticBonuses.prestigeMultiplier));
  }, [performPrestige, prestigeSkillBonus, galacticBonuses.prestigeMultiplier]);

const handleBuyResearch = useCallback((id) => {
    setGameState(prev => {
        const researchToBuy = prev.research.find(r => r.id === id);
        if (!researchToBuy || researchToBuy.isPurchased) return prev;
        const effectiveCost = new D(researchToBuy.cost).mul(researchCostReduction);
        if (prev.prestigePoints.lt(effectiveCost)) return prev;
        const dependenciesMet = researchToBuy.dependencies.every(depId => prev.research.find(r => r.id === depId)?.isPurchased);
        if (dependenciesMet) {
            const newResearch = prev.research.map(r => r.id === id ? { ...r, isPurchased: true } : r);
            return { ...prev, prestigePoints: Decimal.max(prev.prestigePoints.sub(effectiveCost), 0), research: newResearch };
        }
        return prev;
    });
  }, [researchCostReduction]);

const handleBuySubject = useCallback((id, amount) => {
    setGameState(prev => {
        const subjectToBuy = prev.subjects.find(s => s.id === id);
        if (!subjectToBuy || amount <= 0) return prev;
        const cost = calculatePurchaseCost(subjectToBuy, amount);
        let resourcePool;
        if (subjectToBuy.costResource === 'atoms') resourcePool = prev.atoms;
        else if (subjectToBuy.costResource === 'lives') resourcePool = prev.lives;
        
        if (!resourcePool || resourcePool.lt(cost)) return prev;
        
        const newState = { ...prev };
        if (subjectToBuy.costResource === 'atoms') newState.atoms = Decimal.max(prev.atoms.sub(cost), 0);
        else if (subjectToBuy.costResource === 'lives') newState.lives = Decimal.max(prev.lives.sub(cost), 0);
        
        newState.subjects = prev.subjects.map(s => s.id === id ? { ...s, count: s.count + amount } : s);
        return newState;
    });
  }, []);
  
  const handleHumanAscension = useCallback((gained) => {
        if (!gained || gained <= 0) return;
        setGameState(prev => performHumanAscension(prev, gained));
    }, [performHumanAscension]);

    const handleSuperHumanAscension = useCallback((amount) => {
    if (!amount || amount <= 0) return;
    setGameState(prev => {
        
        const initialState = getInitialGameState();
        initialState.superHumans = prev.superHumans + amount;
        initialState.superHumanSkills = prev.superHumanSkills;
        initialState.artificialIngenuity = prev.artificialIngenuity;
        initialState.superHumansUnlocked = true;
        initialState.maxHistoricalBHC = prev.maxHistoricalBHC;
        initialState.stardust = prev.stardust;
        initialState.stardustAwardedfromBHC = prev.stardustAwardedfromBHC;
        initialState.universeData = prev.universeData;
        initialState.planetarySystems = prev.planetarySystems;
        initialState.galacticPoints = prev.galacticPoints;
        initialState.mind = prev.mind;
        
        const shs5Level = prev.superHumanSkills.find(s => s.id === 'shs5')?.level || 0;
        if (shs5Level > 0) {
            initialState.humans = { total: shs5Level * 10, assigned: {} };
            initialState.humansUnlocked = true;
        }
        return initialState;
    });
}, []);

  const handleAssignSuperHuman = useCallback((projectId, amount) => {
    setGameState(prev => {
        if (amount === 0) return prev;
        const assignedCount = Object.values(prev.superHumansAssigned || {}).reduce((sum, c) => sum + c, 0);
        const available = prev.superHumans - assignedCount;
        const newAssigned = { ...(prev.superHumansAssigned || {}) };
        const current = newAssigned[projectId] || 0;
        let actualAmount = (amount > 0) ? Math.min(amount, available) : -Math.min(-amount, current);
        if (actualAmount === 0) return prev;
        newAssigned[projectId] = current + actualAmount;
        return { ...prev, superHumansAssigned: newAssigned };
    });
    }, []);

  const handleAssignHuman = useCallback((generatorId, amount) => {
    setGameState(prev => {
        if (amount === 0) return prev;
        const assignedHumansCount = Object.values(prev.humans.assigned || {}).reduce((sum, count) => sum + count, 0);
        const availableHumans = prev.humans.total - assignedHumansCount;
        const newAssigned = { ...(prev.humans.assigned || {}) };
        const currentAssignment = newAssigned[generatorId] || 0;
        let actualAmount = (amount > 0) ? Math.min(amount, availableHumans) : -Math.min(-amount, currentAssignment);
        if (actualAmount === 0) return prev;
        newAssigned[generatorId] = currentAssignment + actualAmount;
        return { ...prev, humans: { ...prev.humans, assigned: newAssigned } };
    });
  }, []);

const handleBuySkill = useCallback((skillId) => {
      setGameState(prev => {
          const skill = prev.humanSkills.find(s => s.id === skillId);
          if (!skill || (skill.maxLevel && skill.level >= skill.maxLevel)) return prev;
          const cost = new D(skill.baseCost).mul(new D(skill.costIncreaseFactor).pow(skill.level));
          if (prev.skillPoints.gte(cost)) {
              const newSkills = prev.humanSkills.map(s => s.id === skillId ? {...s, level: s.level + 1} : s);
              return {...prev, humanSkills: newSkills, skillPoints: Decimal.max(prev.skillPoints.sub(cost), 0)};
          }
          return prev;
      });
  }, []);

const handleBuySuperHumanSkill = useCallback((skillId) => {
      setGameState(prev => {
          const skill = prev.superHumanSkills.find(s => s.id === skillId);
          if (!skill || (skill.maxLevel && skill.level >= skill.maxLevel)) return prev;
          const cost = new D(skill.baseCost).mul(new D(skill.costIncreaseFactor).pow(skill.level));
          if (prev.artificialIngenuity.gte(cost)) {
              const newSkills = prev.superHumanSkills.map(s => s.id === skillId ? {...s, level: s.level + 1} : s);
              return {...prev, superHumanSkills: newSkills, artificialIngenuity: Decimal.max(prev.artificialIngenuity.sub(cost), 0)};
          }
          return prev;
      });
  }, []);
  
  const handleInfuseMind = useCallback((currencyType, buyAmount) => {
    setGameState(prev => {
        if (!prev.mind.unlocked || buyAmount <= 0) return prev;

        let cost, xpGained, resourcePool;
        const newState = { ...prev };

        if (currencyType === 'ai') {
            cost = new D(buyAmount);
            xpGained = cost.mul(AI_TO_XP);
            resourcePool = newState.artificialIngenuity;
            if (resourcePool.lt(cost)) return prev;
            newState.artificialIngenuity = Decimal.max(resourcePool.sub(cost), 0);
        } else if (currencyType === 'sp') {
            cost = new D(buyAmount);
            xpGained = cost.mul(SP_TO_XP);
            resourcePool = newState.skillPoints;
            if (resourcePool.lt(cost)) return prev;
            newState.skillPoints = Decimal.max(resourcePool.sub(cost), 0);
        } else {
            return prev;
        }

        const newMindState = { ...newState.mind };
        newMindState.xp = newMindState.xp.add(xpGained);

        while (newMindState.xp.gte(newMindState.xpToNextLevel)) {
            newMindState.xp = newMindState.xp.sub(newMindState.xpToNextLevel);
            newMindState.level += 1;
            newMindState.xpToNextLevel = new D(MIND_XP_BASE).mul(new D(MIND_XP_FACTOR).pow(newMindState.level));
        }
        
        newState.mind = newMindState;
        return newState;
    });
  }, []);


const handleBuyInfiniteProject = useCallback((projectId) => {
      setGameState(prev => {
          const project = prev.infiniteProjects.find(p => p.id === projectId);
          if (!project) return prev;
          const cost = new D(project.baseCost).mul(new D(project.costIncreaseFactor).pow(project.level));
          if (prev.atoms.gte(cost)) {
              const newProjects = prev.infiniteProjects.map(p => p.id === projectId ? {...p, level: p.level + 1} : p);
              return {...prev, infiniteProjects: newProjects, atoms: Decimal.max(prev.atoms.sub(cost), 0)};
          }
          return prev;
      });
  }, []);

const handleBuyPrestigeSkill = useCallback((skillId, amount) => {
    setGameState(prev => {
        const skill = prev.prestigeSkills.find(s => s.id === skillId);
        if (!skill || amount <= 0) return prev;

        const effectiveSkill = effectivePrestigeSkills.find(s => s.id === skillId);
        if (!effectiveSkill) return prev; 

        if (effectiveSkill.maxLevel && skill.level >= effectiveSkill.maxLevel) {
            return prev;
        }

        const cappedAmount = effectiveSkill.maxLevel
            ? Math.min(amount, effectiveSkill.maxLevel - skill.level)
            : amount;

        if (cappedAmount <= 0) return prev;

        const cost = calculatePurchaseCost({ ...skill, count: skill.level }, cappedAmount);
        if (prev.prestigePoints.gte(cost)) {
            const newSkills = prev.prestigeSkills.map(s =>
                s.id === skillId ? { ...s, level: s.level + cappedAmount } : s
            );
            return { ...prev, prestigeSkills: newSkills, prestigePoints: Decimal.max(prev.prestigePoints.sub(cost), 0) };
        }
        return prev;
    });
}, [effectivePrestigeSkills]); 

const handleBuyLifeTechnology = useCallback((techId, amount) => {
      setGameState(prev => {
          const tech = prev.lifeTechnologies.find(t => t.id === techId);
          if (!tech || amount <= 0 || (tech.maxLevel && tech.level >= tech.maxLevel)) return prev;
          const cappedAmount = tech.maxLevel ? Math.min(amount, tech.maxLevel - tech.level) : amount;
          if (cappedAmount <= 0) return prev;
          const cost = calculatePurchaseCost({ ...tech, count: tech.level }, cappedAmount);
          if (prev.lives.gte(cost)) {
              const newTechs = prev.lifeTechnologies.map(t => t.id === techId ? {...t, level: t.level + cappedAmount} : t);
              return {...prev, lifeTechnologies: newTechs, lives: Decimal.max(prev.lives.sub(cost), 0)};
          }
          return prev;
      });
  }, []);

  const handleToggleGeneratorAutomation = useCallback((generatorId) => {
    setGameState(prev => ({ ...prev, generatorAutomations: { ...prev.generatorAutomations, [generatorId]: !prev.generatorAutomations[generatorId] } }));
  }, []);
  const handleToggleAutoUpgrades = useCallback(() => setGameState(prev => ({ ...prev, autoBuyUpgrades: !prev.autoBuyUpgrades })), []);
  const handleToggleAutoLifeTechs = useCallback(() => setGameState(prev => ({ ...prev, autoBuyLifeTechs: !prev.autoBuyLifeTechs })), []);
  const handleToggleAutoHumanSkills = useCallback(() => setGameState(prev => ({ ...prev, autoBuyHumanSkills: !prev.autoBuyHumanSkills })), []);
  const handleToggleAutoSuperHumanSkills = useCallback(() => setGameState(prev => ({ ...prev, autoBuySuperHumanSkills: !prev.autoBuySuperHumanSkills })), []);
  const handleToggleAutoInfiniteProjects = useCallback(() => setGameState(prev => ({ ...prev, autoBuyInfiniteProjects: !prev.autoBuyInfiniteProjects })), []);

  const handleHardReset = useCallback(() => {
    if (window.confirm('Are you sure you want to delete all your progress? This action is irreversible and will restart the game from scratch.')) {
        localStorage.clear();
        window.location.reload(true);
    }
  }, []);

const handleExport = useCallback(() => {
    try {
        const gameState = gameStateRef.current;
        const stateToSave = {
            ...gameState,
            atoms: gameState.atoms.toString(),
            prestigePoints: gameState.prestigePoints.toString(),
            lives: gameState.lives.toString(),
            skillPoints: gameState.skillPoints.toString(),
            artificialIngenuity: gameState.artificialIngenuity.toString(),
            generators: gameState.generators.map(g => ({ id: g.id, count: g.count })),
            upgrades: gameState.upgrades.map(u => ({ id: u.id, level: u.level })),
            research: gameState.research.map(r => ({ id: r.id, isPurchased: r.isPurchased })),
            subjects: gameState.subjects.map(s => ({ id: s.id, count: s.count })),
            humanSkills: gameState.humanSkills.map(s => ({ id: s.id, level: s.level })),
            infiniteProjects: gameState.infiniteProjects.map(p => ({ id: p.id, level: p.level })),
            prestigeSkills: gameState.prestigeSkills.map(s => ({ id: s.id, level: s.level })),
            lifeTechnologies: gameState.lifeTechnologies.map(t => ({ id: t.id, level: t.level })),
            subjectsAutomations: gameState.subjectsAutomations,
            superHumanSkills: gameState.superHumanSkills.map(s => ({ id: s.id, level: s.level })),
            stardust: gameState.stardust.toString(),
            stardustAwardedfromBHC: gameState.stardustAwardedfromBHC.toString(),
            universeData: {
                ...gameState.universeData,
                totalEnergy: gameState.universeData.totalEnergy.toString(),
                planetarySystemProgress: {
                    stardust: gameState.universeData.planetarySystemProgress.stardust.toString(),
                    energy: gameState.universeData.planetarySystemProgress.energy.toString(),
                }
            },
            mind: {
                level: gameState.mind.level,
                xp: gameState.mind.xp.toString(),
                xpToNextLevel: gameState.mind.xpToNextLevel.toString(),
                unlocked: gameState.mind.unlocked
            }
        };
        const saveDataString = JSON.stringify(stateToSave);

        const hexfile = textToHex(saveDataString);
        const blob = new Blob([hexfile], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `atom_idle_save_${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        addNotification("Save file downloaded!");
    } catch (error) {
        console.error("Export failed:", error);
        addNotification("Failed to export save data.");
    }
  }, [addNotification]);

  const handleFileSelect = useCallback(async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const hexFile = e.target.result;
            const contentString = hexToText(hexFile);
            
            let potentialSaveData;
            try {
                potentialSaveData = JSON.parse(contentString);
            } catch (err) {
                 addNotification("Import failed: File is not valid JSON.");
                 return;
            }

            if (potentialSaveData.atoms !== undefined && potentialSaveData.generators !== undefined) {
                if (window.confirm('Are you sure you want to import this save? Your current progress will be overwritten.')) {
                    localStorage.setItem('atomIdleSaveData', contentString);
                    addNotification("Import successful! Reloading game...");
                    setTimeout(() => window.location.reload(true), 50);
                }
            } else {
                addNotification("Invalid or corrupted save file format.");
            }
        } catch (error) {
            console.error("Import failed:", error);
            addNotification("Failed to read or parse save file.");
        } finally {
            if(event.target) event.target.value = null;
        }
    };
    reader.readAsText(file);
  }, [addNotification]);

  const handleImportClick = useCallback(() => { fileInputRef.current.click(); }, []);

    useEffect(() => {
        const hasUnlockedStardust = gameState.research.find(r => r.id === 'res11' && r.isPurchased);
        if (!hasUnlockedStardust) return;

        const totalPotentialStardust = Math.floor((gameState.maxHistoricalBHC || 0) / 50);
        const alreadyAwarded = gameState.stardustAwardedfromBHC || 0;
        const stardustToAdd = totalPotentialStardust - alreadyAwarded;

        if (stardustToAdd > 0) {
            setGameState(prev => ({
                ...prev,
                stardust: prev.stardust.add(stardustToAdd), 
                stardustAwardedfromBHC: totalPotentialStardust 
            }));
            addNotification(`+${stardustToAdd} Stardust from Black Hole Colliders!`);
        }
    }, [gameState.maxHistoricalBHC, gameState.research, addNotification]);

useEffect(() => {
    if (gameState.superHumans >= Number(POST_SUPER_HUMANS_REQUIREMENT) && 
        gameState.generators.find(g => g.id === 'gen5' && g.isHidden) && 
        !gameState.universeUnlockedNotified) {
        setGameState(prev => ({
            ...prev,
            generators: prev.generators.map(g => g.id === 'gen5' ? { ...g, isHidden: false } : g),
            upgrades: prev.upgrades.map(u => u.id === 'upg0' ? { ...u, isHidden: false } : u),
            universeUnlockedNotified: true
        }));
        addNotification("The Universe Beckons! New content unlocked.");
    }
}, [gameState.superHumans, gameState.generators, gameState.universeUnlockedNotified, addNotification]);

  const showStardustButton = gameState.research.find(r => r.id === 'res11' && r.isPurchased);

  const stardustButton = showStardustButton && React.createElement("button", {
      onClick: () => setIsUniverseVisible(true),
      className: "fixed bottom-8 left-8 w-16 h-16 rounded-full bg-gradient-to-br from-violet-400 to-pink-500 shadow-lg shadow-purple-500/30 flex items-center justify-center z-50 border-2 border-transparent hover:border-white transition-all duration-300 transform hover:scale-110",
      title: "Go to Universe"
    }, React.createElement(UniverseIcon, { className: "w-10 h-10 text-white" })
  );

  return React.createElement(React.Fragment, null, 
    React.createElement("div", { className: "bg-slate-900 text-slate-100 min-h-screen font-sans" },
      React.createElement(UniverseModal, { 
          show: isUniverseVisible, 
          onClose: () => setIsUniverseVisible(false),
          universeData: gameState.universeData,
          availableStardust: gameState.stardust,
          onBuyUniverseItem: handleBuyUniverseItem,
          totalEnergy: new D(gameState.universeData.totalEnergy || '0'),
          energyPerSecond: universeEnergyPerSecond,
          stardustPerSecond: stardustPerSecond,
          stellarNurseryCount: gameState.generators.find(g => g.id === 'gen2')?.count || 0,
          planetarySystems: gameState.planetarySystems,
          galacticPoints: gameState.galacticPoints,
          onInvestInPlanetarySystem: handleInvestInPlanetarySystem,
                    onFormPlanetarySystem: handleFormPlanetarySystem,
          onBuyGalacticUpgrade: handleBuyGalacticUpgrade
      }),
      React.createElement(Header, { ...gameState, atomsPerSecond, livesPerSecond, artificialIngenuityPerSecond, skillPointGenerationRate, prestigePointsPerSecond, numberFormat }),
      React.createElement('div', { id: 'notification-area' },
          notifications.map(notification => React.createElement(Notification, {
              key: notification.id,
              id: notification.id,
              message: notification.message,
              onDismiss: removeNotification
          }))
      ),
      React.createElement("main", { className: "max-w-7xl mx-auto p-4" },
        React.createElement("div", { className: "mb-6 flex justify-center border-b border-slate-700 flex-wrap" },
          React.createElement("button", { onClick: () => setActiveTab('main'), className: `px-4 py-2 text-lg font-semibold border-b-2 transition-colors ${activeTab === 'main' ? 'border-cyan-400 text-cyan-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Main"),
          React.createElement("button", { onClick: () => setActiveTab('guide'), className: `px-4 py-2 text-lg font-semibold border-b-2 transition-colors ${activeTab === 'guide' ? 'border-emerald-400 text-emerald-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Guide"),
          (gameState.atoms.gte(PRESTIGE_REQUIREMENT) || gameState.prestigePoints.gt(0)) && React.createElement("button", { onClick: () => setActiveTab('prestige'), className: `px-4 py-2 text-lg font-semibold border-b-2 transition-colors ${activeTab === 'prestige' ? 'border-yellow-400 text-yellow-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Prestige"),
          (gameState.atoms.gte(PRESTIGE_REQUIREMENT) || gameState.prestigePoints.gt(0)) && React.createElement("button", { onClick: () => setActiveTab('research'), className: `px-4 py-2 text-lg font-semibold border-b-2 transition-colors ${activeTab === 'research' ? 'border-yellow-400 text-yellow-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Research"),
          gameState.subjectsUnlocked && React.createElement("button", { onClick: () => setActiveTab('subjects'), className: `px-4 py-2 text-lg font-semibold border-b-2 transition-colors ${activeTab === 'subjects' ? 'border-purple-400 text-purple-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Subjects"),
          gameState.humansUnlocked && React.createElement("button", { onClick: () => setActiveTab('humans'), className: `px-4 py-2 text-lg font-semibold border-b-2 transition-colors ${activeTab === 'humans' ? 'border-green-400 text-green-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Humans"),
          gameState.superHumansUnlocked && React.createElement("button", { onClick: () => setActiveTab('superHumans'), className: `px-4 py-2 text-lg font-semibold border-b-2 transition-colors ${activeTab === 'superHumans' ? 'border-sky-400 text-sky-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "Super Humans"),
          gameState.mind.unlocked && React.createElement("button", { onClick: () => setActiveTab('mind'), className: `px-4 py-2 text-lg font-semibold border-b-2 transition-colors ${activeTab === 'mind' ? 'border-indigo-400 text-indigo-300' : 'border-transparent text-slate-400 hover:text-white'}` }, "The Mind")
        ),
        activeTab === 'main' && React.createElement(React.Fragment, null,
          React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-4" },
            React.createElement("div", { className: "space-y-3" },
              React.createElement("div", { className: "flex justify-between items-center" },
                React.createElement("h2", { className: "text-2xl font-bold text-slate-300" }, "Generators"),
                React.createElement("div", { className: "flex items-center" },
                  React.createElement("span", { className: "text-slate-400 mr-2 text-sm" }, "Buy:"),
                  [1, 5, 10, 50, 'MAX'].map((amount) => React.createElement("button", { key: amount.toString(), onClick: () => setBuyAmount(amount), className: `w-12 px-3 py-1 text-sm font-bold rounded-md ml-1 transition-colors ${buyAmount === amount ? 'bg-cyan-500 text-slate-900' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}` }, amount))
                )
              ),
              effectiveGenerators.filter(gen => {
                  if (gen.id === 'gen5') {
                      return gameState.superHumans >= Number(POST_SUPER_HUMANS_REQUIREMENT);
                  }
                  return !gen.isHidden;
              }).map(gen => React.createElement(GeneratorItem, { key: gen.id, generator: gen, onBuy: handleBuyGenerator, atoms: gameState.atoms, buyAmount: buyAmount, assignedHumans: (gameState.humans.assigned || {})[gen.id] || 0, humanBonusPerHuman: effectiveBonusPerHuman, totalGlobalMultiplier: totalGlobalMultiplier, prestigeBonus: prestigeBonus, researchMultiplier: researchMultiplier, lifeBonus: lifeBonus, infiniteProjectBonus: infiniteProjectBonus, ip1Special: ip1Special, specificGeneratorMultipliers: specificGeneratorMultipliers, superHumanSkills: gameState.superHumanSkills, isAutomationUnlocked: gameState.research.find(r=>r.id==='res8')?.isPurchased, isAutomated: !!gameState.generatorAutomations[gen.id], onToggleAutomation: handleToggleGeneratorAutomation, numberFormat: numberFormat }))
            ),
            React.createElement("div", { className: "space-y-3" },
              React.createElement("div", { className: "flex justify-between items-center" },
                React.createElement("h2", { className: "text-2xl font-bold text-slate-300" }, "Upgrades"),
                React.createElement("div", { className: "flex items-center" },
                  React.createElement("span", { className: "text-slate-400 mr-2 text-sm" }, "Buy:"),
                  [1, 5, 10, 50, 'MAX'].map((amount) => React.createElement("button", { key: amount.toString(), onClick: () => setUpgradeBuyAmount(amount), className: `w-12 px-3 py-1 text-sm font-bold rounded-md ml-1 transition-colors ${upgradeBuyAmount === amount ? 'bg-teal-500 text-slate-900' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}` }, amount))
                )
              ),
              effectiveUpgrades.filter(upg => {
                  if (upg.id === 'upg0') {
                      return gameState.superHumans >= Number(POST_SUPER_HUMANS_REQUIREMENT);
                  }
                  return !upg.isHidden;
              }).map(upg => React.createElement(UpgradeItem, { key: upg.id, upgrade: upg, onBuy: handleBuyUpgrade, atoms: gameState.atoms, buyAmount: upgradeBuyAmount, numberFormat: numberFormat }))
            )
          ),
          React.createElement("div", { className: "mt-8" },
            React.createElement("h2", { className: "text-2xl font-bold mb-4 text-slate-300" }, "Options"),
            React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex flex-col sm:flex-row items-center justify-between gap-4" },
              React.createElement("div", null,
                React.createElement("h3", { className: "font-bold text-lg text-rose-400" }, "Hard Reset"),
                React.createElement("p", { className: "text-slate-400 text-sm" }, "Deletes all saved data and starts the game from the beginning. This action cannot be undone.")
              ),
              React.createElement("button", { onClick: handleHardReset, className: "px-6 py-3 w-full sm:w-auto flex-shrink-0 font-bold rounded-lg transition-all duration-200 bg-rose-600 hover:bg-rose-500 active:scale-95 text-white" }, "Delete Progress")
            ),
             React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between gap-4 mt-4" },
                React.createElement("div", null,
                    React.createElement("h3", { className: "font-bold text-lg text-blue-400" }, "Number Format"),
                    React.createElement("p", { className: "text-slate-400 text-sm" }, "Switch between standard (K, M, B) and scientific (e) notation.")
                ),
                React.createElement("button", { 
                    onClick: () => setNumberFormat(prev => prev === 'standard' ? 'scientific' : 'standard'), 
                    className: "px-6 py-3 font-bold rounded-lg transition-all duration-200 bg-blue-600 hover:bg-blue-500 text-white w-48" 
                }, `Current: ${numberFormat.charAt(0).toUpperCase() + numberFormat.slice(1)}`)
            ),
             gameState.research.find(r => r.id === 'res9' && r.isPurchased) && React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between gap-4 mt-4" },
                React.createElement("div", null,
                    React.createElement("h3", { className: "font-bold text-lg text-purple-400" }, "Automated Upgrades"),
                    React.createElement("p", { className: "text-slate-400 text-sm" }, "Automatically buys the cheapest affordable upgrade.")
                ),
                React.createElement("button", { onClick: handleToggleAutoUpgrades, className: `px-6 py-3 font-bold rounded-lg transition-all duration-200 ${gameState.autoBuyUpgrades ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-600 hover:bg-slate-500'} text-white` }, gameState.autoBuyUpgrades ? 'ON' : 'OFF')
            ),
            gameState.research.find(r => r.id === 'res12' && r.isPurchased) && React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between gap-4 mt-4" },
                React.createElement("div", null, React.createElement("h3", { className: "font-bold text-lg text-red-400" }, "Auto Life Techs"), React.createElement("p", { className: "text-slate-400 text-sm" }, "Automatically buys the cheapest affordable Life Technology.")),
                React.createElement("button", { onClick: handleToggleAutoLifeTechs, className: `px-6 py-3 font-bold rounded-lg transition-all duration-200 ${gameState.autoBuyLifeTechs ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-600 hover:bg-slate-500'} text-white` }, gameState.autoBuyLifeTechs ? 'ON' : 'OFF')
            ),
            gameState.research.find(r => r.id === 'res13' && r.isPurchased) && React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between gap-4 mt-4" },
                React.createElement("div", null, React.createElement("h3", { className: "font-bold text-lg text-pink-400" }, "Auto Human Skills"), React.createElement("p", { className: "text-slate-400 text-sm" }, "Automatically buys the cheapest affordable Human Skill.")),
                React.createElement("button", { onClick: handleToggleAutoHumanSkills, className: `px-6 py-3 font-bold rounded-lg transition-all duration-200 ${gameState.autoBuyHumanSkills ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-600 hover:bg-slate-500'} text-white` }, gameState.autoBuyHumanSkills ? 'ON' : 'OFF')
            ),
            gameState.research.find(r => r.id === 'res14' && r.isPurchased) && React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between gap-4 mt-4" },
                React.createElement("div", null, React.createElement("h3", { className: "font-bold text-lg text-sky-400" }, "Auto Super Human Skills"), React.createElement("p", { className: "text-slate-400 text-sm" }, "Automatically buys the cheapest affordable Super Human Skill.")),
                React.createElement("button", { onClick: handleToggleAutoSuperHumanSkills, className: `px-6 py-3 font-bold rounded-lg transition-all duration-200 ${gameState.autoBuySuperHumanSkills ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-600 hover:bg-slate-500'} text-white` }, gameState.autoBuySuperHumanSkills ? 'ON' : 'OFF')
            ),
            gameState.research.find(r => r.id === 'res15' && r.isPurchased) && React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between gap-4 mt-4" },
                React.createElement("div", null, React.createElement("h3", { className: "font-bold text-lg text-purple-400" }, "Auto Infinite Projects"), React.createElement("p", { className: "text-slate-400 text-sm" }, "Automatically buys the cheapest affordable Infinite Project.")),
                React.createElement("button", { onClick: handleToggleAutoInfiniteProjects, className: `px-6 py-3 font-bold rounded-lg transition-all duration-200 ${gameState.autoBuyInfiniteProjects ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-600 hover:bg-slate-500'} text-white` }, gameState.autoBuyInfiniteProjects ? 'ON' : 'OFF')
            ),
            React.createElement("div", { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700 mt-4" },
                React.createElement("h3", { className: "font-bold text-lg text-emerald-400" }, "Export / Import Save"),
                React.createElement("p", { className: "text-slate-400 text-sm mb-4" }, "Export your save to a file or import a previous save."),
                React.createElement("div", { className: "flex flex-col sm:flex-row gap-4" },
                    React.createElement("button", { onClick: handleExport, className: "px-6 py-3 w-full sm:flex-1 font-bold rounded-lg transition-all duration-200 bg-emerald-600 hover:bg-emerald-500 active:scale-95 text-white" }, "Export Game Data"),
                    React.createElement("button", { onClick: handleImportClick, className: "px-6 py-3 w-full sm:flex-1 font-bold rounded-lg transition-all duration-200 bg-teal-600 hover:bg-teal-500 active:scale-95 text-white" }, "Import From File"),
                    React.createElement("input", { type: "file", ref: fileInputRef, accept: ".txt", style: { display: 'none' }, onChange: handleFileSelect })
                )
            )
          )
        ),
        activeTab === 'guide' && React.createElement(GuideTab, { numberFormat: numberFormat }),
        activeTab === 'prestige' && React.createElement(PrestigeTab, { gameState: gameState, onPrestige: handlePrestige, onBuyPrestigeSkill: handleBuyPrestigeSkill, prestigeSkillBuyAmount: prestigeSkillBuyAmount, setPrestigeSkillBuyAmount: setPrestigeSkillBuyAmount, prestigeSkillBonus: prestigeSkillBonus, galacticBonuses: galacticBonuses, numberFormat: numberFormat, prestigeSkills: effectivePrestigeSkills }),
        activeTab === 'research' && React.createElement(ResearchTree, { research: visibleResearch, prestigePoints: gameState.prestigePoints, onBuyResearch: handleBuyResearch, infiniteProjects: visibleInfiniteProjects, onBuyInfiniteProject: handleBuyInfiniteProject, atoms: gameState.atoms, researchCostReduction: researchCostReduction, numberFormat: numberFormat }),
        activeTab === 'subjects' && React.createElement(Subjects, { subjects: gameState.subjects, gameState: gameState, onBuySubject: handleBuySubject, onAscend: handleHumanAscension, buyAmount: subjectBuyAmount, setBuyAmount: setSubjectBuyAmount, lifeProductionMultiplier: lifeProductionMultiplier, lifeTechnologies: gameState.lifeTechnologies, onBuyLifeTechnology: handleBuyLifeTechnology, lifeTechBuyAmount: lifeTechBuyAmount, setLifeTechBuyAmount: setLifeTechBuyAmount, setGameState: setGameState, mindBonuses: mindBonuses, numberFormat: numberFormat }),
        activeTab === 'humans' && React.createElement(HumansTab, { gameState: gameState, onAssignHuman: handleAssignHuman, onBuySkill: handleBuySkill, humanBonusPerHuman: effectiveBonusPerHuman, numberFormat: numberFormat }),
        activeTab === 'superHumans' && React.createElement(SuperHumansTab, { gameState: gameState, onAscend: handleSuperHumanAscension, onBuySkill: handleBuySuperHumanSkill, onAssignSuperHuman: handleAssignSuperHuman, mindBonuses: mindBonuses, galacticBonuses: galacticBonuses, numberFormat: numberFormat }),
        activeTab === 'mind' && React.createElement(MindTab, { gameState: gameState, onInfuse: handleInfuseMind, mindBonuses: mindBonuses, numberFormat: numberFormat })
      )
    ),
    stardustButton
  );
};

const rootElement = document.getElementById('root');
if (!rootElement) throw new Error("Could not find root element to mount to");
const root = ReactDOM.createRoot(rootElement);
root.render(React.createElement(React.StrictMode, null, React.createElement(App, null)));
    </script>
  </body>
</html>